<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <id>https://vy.github.io//</id>
  <title>Volkan Yazıcı's Soap Co.</title>
  <updated>2014-08-07T07:28:00Z</updated>
  <link rel="alternate" href="https://vy.github.io//"/>
  <link rel="self" href="https://vy.github.io//blog/feed/"/>
  <author>
    <name>Volkan Yazıcı</name>
    <uri>https://vy.github.io/</uri>
  </author>
  <entry>
    <id>tag:vy.github.io,2014-08-07://blog/post/2014/08/07/testing-websockets-in-play/</id>
    <title type="html">Testing WebSockets in Play Framework</title>
    <published>2014-08-07T07:28:00Z</published>
    <updated>2014-08-07T07:28:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2014/08/07/testing-websockets-in-play/"/>
    <content type="html">&lt;p&gt;In a recent job interview, I was asked to implement a fully fledged (that is,
including unit and integration tests) &lt;a href="http://en.wikipedia.org/wiki/Mancala"&gt;Lubang Menggali
(Mancala)&lt;/a&gt; game, where multiple users are
allowed to play in real-time. I went with &lt;a href="http://www.playframework.com/"&gt;Play
Framework&lt;/a&gt; and used
&lt;a href="http://en.wikipedia.org/wiki/WebSocket"&gt;WebSocket&lt;/a&gt;s to implement the real-time
server-client communication. (You can find the complete sources
&lt;a href="https://github.com/vy/lubang-menggali"&gt;here&lt;/a&gt;.) Play provides necessary leverage
for the integration tests – start the server, connect two browsers to it, click
on the buttons to make a move and check the board updates. However, the tricky
bit was the implementation of unit tests for &lt;code&gt;WebSocket&lt;/code&gt; handlers.&lt;/p&gt;

&lt;h1 id="preliminaries"&gt;Preliminaries&lt;/h1&gt;

&lt;p&gt;A typical &lt;code&gt;WebSocket&lt;/code&gt; handler in Play has the following entry point for the
request dispatcher.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;join&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="nd"&gt;@Override&lt;/span&gt;
        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;onReady&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;In&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;in&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Out&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;out&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
            &lt;span class="c1"&gt;// ...&lt;/span&gt;
        &lt;span class="o"&gt;}&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;When a request hits to &lt;code&gt;join()&lt;/code&gt;, the function returns a new &lt;code&gt;WebSocket&lt;/code&gt;
instance, where &lt;code&gt;onReady()&lt;/code&gt; will be invoked upon connection establishment. After
that, the book keeping of the input and output sockets are delegated to the
programmer. Note that the client-server communication is performed in JSON
messages in the above code snippet.&lt;/p&gt;

&lt;h1 id="mocking"&gt;Mocking&lt;/h1&gt;

&lt;p&gt;In order to mock a client-server &lt;code&gt;WebSocket&lt;/code&gt; communication, I need mock
&lt;code&gt;WebSocket.In&lt;/code&gt; and &lt;code&gt;WebSocket.Out&lt;/code&gt; class implementations. For that purpose, I
first tried googling alternatives and checked what other people have done
previously, but did not find much material. Hence, I came up with the following
&lt;code&gt;MockInputWebSocket&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="nd"&gt;@ThreadSafe&lt;/span&gt;
&lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;MockInputWebSocket&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;messageListeners&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
            &lt;span class="n"&gt;Collections&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;synchronizedList&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;());&lt;/span&gt;

    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback0&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;closeListeners&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;
            &lt;span class="n"&gt;Collections&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;synchronizedList&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback0&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;());&lt;/span&gt;

    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;In&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;inputSocket&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;In&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

        &lt;span class="nd"&gt;@Override&lt;/span&gt;
        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;onMessage&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="n"&gt;messageListeners&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;add&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

        &lt;span class="nd"&gt;@Override&lt;/span&gt;
        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;onClose&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback0&lt;/span&gt; &lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="n"&gt;closeListeners&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;add&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="o"&gt;};&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;write&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;Throwable&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;listener&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;messageListeners&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;invoke&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;close&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;Throwable&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Callback0&lt;/span&gt; &lt;span class="n"&gt;listener&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;closeListeners&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;invoke&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;In&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;getInputSocket&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;inputSocket&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here, I first implement a &lt;code&gt;WebSocket.In&lt;/code&gt; object, where message and close event
listeners can register themselves to &lt;code&gt;messageListeners&lt;/code&gt; and &lt;code&gt;closeListeners&lt;/code&gt;
list, respectively. Next, in order to pass data to the socket listeners, I wrote
my custom &lt;code&gt;write()&lt;/code&gt; and &lt;code&gt;close()&lt;/code&gt; methods.&lt;/p&gt;

&lt;p&gt;I also implemented &lt;code&gt;MockOutputWebSocket&lt;/code&gt; similarly:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="nd"&gt;@ThreadSafe&lt;/span&gt;
&lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;MockOutputWebSocket&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;ObjectMapper&lt;/span&gt; &lt;span class="n"&gt;objectMapper&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ObjectMapper&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;

    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;BlockingQueue&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;messageQueue&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;LinkedBlockingQueue&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;();&lt;/span&gt;

    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Out&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;outputSocket&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Out&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

        &lt;span class="nd"&gt;@Override&lt;/span&gt;
        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;write&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt; &lt;span class="n"&gt;frame&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="n"&gt;messageQueue&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;add&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;frame&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

        &lt;span class="nd"&gt;@Override&lt;/span&gt;
        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;close&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
            &lt;span class="k"&gt;try&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="n"&gt;messageQueue&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;add&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;objectMapper&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;readTree&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"{\"closed\": true}"&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;
            &lt;span class="c1"&gt;// This should not happen.&lt;/span&gt;
            &lt;span class="k"&gt;catch&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;IOException&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;throw&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;RuntimeException&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;
        &lt;span class="o"&gt;}&lt;/span&gt;
    &lt;span class="o"&gt;};&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;BlockingQueue&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;getMessageQueue&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;messageQueue&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;Out&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nf"&gt;getOutputSocket&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;outputSocket&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If we would forget about the custom close message hack (nasty!) in &lt;code&gt;close()&lt;/code&gt;
method of the implemented &lt;code&gt;WebSocket.Out&lt;/code&gt; class, things are self-explanative
here as well. That is, when we receive a new message, we push it to
&lt;code&gt;messageQueue&lt;/code&gt;. The test user will be able to consume the messages written to
the mock output socket by polling &lt;code&gt;JsonData&lt;/code&gt; from the &lt;code&gt;messageQueue&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Since I come this far, I also implemented an entire &lt;code&gt;WebSocket&lt;/code&gt; mock
(&lt;code&gt;MockWebSocket&lt;/code&gt;) that employs the aforementioned &lt;code&gt;MockInputWebSocket&lt;/code&gt; and
&lt;code&gt;MockOutputWebSocket&lt;/code&gt; as follows.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="nd"&gt;@ThreadSafe&lt;/span&gt;
&lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;MockWebSocket&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;MockInputWebSocket&lt;/span&gt; &lt;span class="n"&gt;mockInput&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;MockInputWebSocket&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;MockOutputWebSocket&lt;/span&gt; &lt;span class="n"&gt;mockOutput&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;MockOutputWebSocket&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="kd"&gt;protected&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

    &lt;span class="n"&gt;MockWebSocket&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;WebSocket&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;socket&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
        &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;onReady&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mockInput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getInputSocket&lt;/span&gt;&lt;span class="o"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;mockOutput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getOutputSocket&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="n"&gt;JsonNode&lt;/span&gt; &lt;span class="nf"&gt;read&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;InterruptedException&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;mockOutput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getMessageQueue&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;poll&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;TimeUnit&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;SECONDS&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;write&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;JsonNode&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;Throwable&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="n"&gt;mockInput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;write&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;close&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;Throwable&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="n"&gt;mockInput&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;close&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;MockWebSocket&lt;/code&gt; provides the caller an interface such that the two-way
&lt;code&gt;WebSocket&lt;/code&gt; communication can be intercepted through provided &lt;code&gt;read()&lt;/code&gt;,
&lt;code&gt;write()&lt;/code&gt; and &lt;code&gt;close()&lt;/code&gt; methods – much like a regular network socket.&lt;/p&gt;

&lt;h1 id="conclusion"&gt;Conclusion&lt;/h1&gt;

&lt;p&gt;Remember that I used JSON as the messaging medium. For that purpose, I created a
couple of event classes (e.g., &lt;code&gt;WaitingForOpponent&lt;/code&gt;, &lt;code&gt;ReadyToStart&lt;/code&gt;,
&lt;code&gt;IllegalMove&lt;/code&gt;, etc.) and used &lt;a href="http://jackson.codehaus.org/"&gt;Jackson&lt;/a&gt; for
POJO-JSON (de)serialization. Next, I integrated my brand new &lt;code&gt;MockWebSocket&lt;/code&gt;
into the unit tests as follows.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;T&lt;/span&gt; &lt;span class="n"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MockWebSocket&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Class&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;clazz&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
        &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;InterruptedException&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;JsonProcessingException&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;JsonNode&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;read&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;isNotNull&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;objectMapper&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;convertValue&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;clazz&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;
    &lt;span class="k"&gt;catch&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;IllegalArgumentException&lt;/span&gt; &lt;span class="n"&gt;iae&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;throw&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;IllegalArgumentException&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
                &lt;span class="s"&gt;"Invalid JSON: "&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;objectMapper&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;writeValueAsString&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;),&lt;/span&gt; &lt;span class="n"&gt;iae&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;writeMove&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MockWebSocket&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Object&lt;/span&gt; &lt;span class="n"&gt;pit&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;Throwable&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;write&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;objectMapper&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;valueToTree&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pit&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="nd"&gt;@Test&lt;/span&gt;
&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;testJoin&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;Throwable&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// Introduce the first user and read the "WaitingForOpponent" message.&lt;/span&gt;
    &lt;span class="n"&gt;MockWebSocket&lt;/span&gt; &lt;span class="n"&gt;fstSocket&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;MockWebSocket&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;join&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;
    &lt;span class="n"&gt;WaitingForOpponent&lt;/span&gt; &lt;span class="n"&gt;fstWfo&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;WaitingForOpponent&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getPendingPlayers&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;size&lt;/span&gt;&lt;span class="o"&gt;()).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getGames&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;size&lt;/span&gt;&lt;span class="o"&gt;()).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

    &lt;span class="c1"&gt;// Introduce the second user and read the."WaitingForOpponent" message.&lt;/span&gt;
    &lt;span class="n"&gt;MockWebSocket&lt;/span&gt; &lt;span class="n"&gt;sndSocket&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;MockWebSocket&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;join&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;
    &lt;span class="n"&gt;WaitingForOpponent&lt;/span&gt; &lt;span class="n"&gt;sndWfo&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;WaitingForOpponent&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstWfo&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;playerId&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;equals&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndWfo&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;playerId&lt;/span&gt;&lt;span class="o"&gt;)).&lt;/span&gt;&lt;span class="na"&gt;isFalse&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;

    &lt;span class="c1"&gt;// Validate "ReadyToStart" messages.&lt;/span&gt;
    &lt;span class="n"&gt;ReadyToStart&lt;/span&gt; &lt;span class="n"&gt;fstRts&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ReadyToStart&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;ReadyToStart&lt;/span&gt; &lt;span class="n"&gt;sndRts&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ReadyToStart&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getGames&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;size&lt;/span&gt;&lt;span class="o"&gt;()).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Application&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getPendingPlayers&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;size&lt;/span&gt;&lt;span class="o"&gt;()).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstRts&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;nextPlayerId&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndRts&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;nextPlayerId&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstRts&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;opponentId&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndWfo&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;playerId&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndRts&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;opponentId&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstWfo&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;playerId&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

    &lt;span class="c1"&gt;// Let 2nd player make a move, while this is not his turn.&lt;/span&gt;
    &lt;span class="n"&gt;writeMove&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;IllegalMove&lt;/span&gt; &lt;span class="n"&gt;im&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sndSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;IllegalMove&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;im&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;reason&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;isEqualTo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"It is opponent's turn."&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

    &lt;span class="c1"&gt;// Let 1st player make a move to an invalid pit index.&lt;/span&gt;
    &lt;span class="n"&gt;writeMove&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="s"&gt;"n/a"&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;im&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;IllegalMove&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;im&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;reason&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;matches&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"^Invalid pit index: .*"&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

    &lt;span class="c1"&gt;// Let 1st player make a move with a negative pit index.&lt;/span&gt;
    &lt;span class="n"&gt;writeMove&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;im&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;readPojo&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fstSocket&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;IllegalMove&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="n"&gt;assertThat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;im&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;reason&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;matches&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"^Invalid pit index: .*"&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

    &lt;span class="c1"&gt;// ...&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I suppose I have got a nearly 99% code coverage of the game engine by using the
mock &lt;code&gt;WebSocket&lt;/code&gt;s. I hope this scheme would help others trying to do a similar
testing stuff.&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2014-06-27://blog/post/2014/06/27/parse-bitcoin-blockchain/</id>
    <title type="html">Parsing Bitcoin Blockchain Data in Java</title>
    <published>2014-06-27T14:49:00Z</published>
    <updated>2014-06-27T14:49:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2014/06/27/parse-bitcoin-blockchain/"/>
    <content type="html">&lt;p&gt;Last week I spent some time on collecting certain statistics (e.g., average
number of performed transactions and created blocks per month) over a vast
(~20GB) Bitcoin blockchain dataset. The hardest part for me was to pick the
right tool to parse the raw blockchain data. First, I hit the Google with
&lt;em&gt;“parse bitcoin blockchain”&lt;/em&gt; keywords. Unfortunately, the returned results
(&lt;a href="https://github.com/gavinandresen/bitcointools"&gt;bitcointools&lt;/a&gt;,
&lt;a href="https://code.google.com/p/blockchain/"&gt;blockchain&lt;/a&gt;,
&lt;a href="https://github.com/znort987/blockparser"&gt;blockparser&lt;/a&gt;, etc.) point to almost
undocumented projects, where some appear to not even work. (As a side note,
bitcointools require a running BitcoinQt/bitcoind process in the background,
which I find pretty amusing.) Next, I checked some papers on Google Scholars to
find out how other people solved the problem. A paper leaded me to
&lt;a href="https://github.com/etotheipi/BitcoinArmory"&gt;BitcoinArmory&lt;/a&gt; project, which
requires a dozen of manual interventions to get installed. (I did not even
attempt to install it.) Suddenly, it occured me to add a &lt;em&gt;“java”&lt;/em&gt; keyword to the
search phrase, which led me to &lt;a href="https://bitcoinj.github.io/"&gt;bitcoinj&lt;/a&gt; project.
&lt;strong&gt;&lt;em&gt;bitcoinj is far most the best Bitcoin blockchain parser library that I have
ever met.&lt;/em&gt;&lt;/strong&gt; It has a rich documentation, developer-friendly (and fully
documented) API and works out of the box. It is composed of a single JAR, no
other requirements, stupid hassles, etc. In addition, its IRC channel at
FreeNode is packed with real people that provide instant support on any Bitcoin
related questions.&lt;/p&gt;

&lt;p&gt;Enough with the talk! Let’s get our hands dirty with the code. I first included
the bitcoinj Maven dependency in my &lt;code&gt;pom.xml&lt;/code&gt; as follows:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-xml"&gt;&lt;span class="nt"&gt;&amp;lt;dependency&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;com.google&lt;span class="nt"&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;bitcoinj&lt;span class="nt"&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;version&amp;gt;&lt;/span&gt;0.11.3&lt;span class="nt"&gt;&amp;lt;/version&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;scope&amp;gt;&lt;/span&gt;compile&lt;span class="nt"&gt;&amp;lt;/scope&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/dependency&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Next, I downloaded a couple of raw blockchain data for test purposes:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;
&lt;a href="https://code.google.com/p/blockchain/source/browse/trunk/blk00000.dat"&gt;Sample data composed of 5000 blocks&lt;/a&gt; (128 MB)&lt;/li&gt;
  &lt;li&gt;
&lt;a href="https://bitfetch.com/static/bootstrap.7z"&gt;From the genesis block through height 295,000&lt;/a&gt; (4.7 GB)&lt;/li&gt;
  &lt;li&gt;
&lt;a href="https://bitcoin.org/bin/blockchain/bootstrap.dat.torrent"&gt;From the genesis block through a recent height&lt;/a&gt; (~17 GB as of this post)&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Here comes the simplest part: the Java code. Below, I calculate the average
number of transactions per block per month.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;com.google.bitcoin.core.Block&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;com.google.bitcoin.core.NetworkParameters&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;com.google.bitcoin.core.PrunedException&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;com.google.bitcoin.core.Transaction&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;com.google.bitcoin.params.MainNetParams&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;com.google.bitcoin.store.BlockStoreException&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.io.File&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.ArrayList&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;  
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.HashMap&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.List&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;java.util.Map&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

&lt;span class="c1"&gt;// Arm the blockchain file loader.&lt;/span&gt;
&lt;span class="n"&gt;NetworkParameters&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;MainNetParams&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
&lt;span class="n"&gt;List&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;File&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;blockChainFiles&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;ArrayList&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;();&lt;/span&gt;
&lt;span class="n"&gt;blockChainFiles&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;add&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;File&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"/tmp/bootstrap.dat"&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
&lt;span class="n"&gt;BlockFileLoader&lt;/span&gt; &lt;span class="n"&gt;bfl&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;BlockFileLoader&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;blockChainFiles&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

&lt;span class="c1"&gt;// Data structures to keep the statistics.&lt;/span&gt;
&lt;span class="n"&gt;Map&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Integer&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;monthlyTxCount&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;HashMap&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;();&lt;/span&gt;
&lt;span class="n"&gt;Map&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Integer&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;monthlyBlockCount&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;HashMap&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;();&lt;/span&gt;

&lt;span class="c1"&gt;// Iterate over the blocks in the dataset.&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Block&lt;/span&gt; &lt;span class="n"&gt;block&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;bfl&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

    &lt;span class="c1"&gt;// Extract the month keyword.&lt;/span&gt;
    &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;month&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;SimpleDateFormat&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"yyyy-MM"&lt;/span&gt;&lt;span class="o"&gt;).&lt;/span&gt;&lt;span class="na"&gt;format&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;block&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getTime&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;

    &lt;span class="c1"&gt;// Make sure there exists an entry for the extracted month.&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(!&lt;/span&gt;&lt;span class="n"&gt;monthlyBlockCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;containsKey&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;monthlyBlockCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;put&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;monthlyTxCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;put&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="c1"&gt;// Update the statistics.&lt;/span&gt;
    &lt;span class="n"&gt;monthlyBlockCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;put&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;monthlyBlockCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
    &lt;span class="n"&gt;monthlyTxCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;put&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;block&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;getTransactions&lt;/span&gt;&lt;span class="o"&gt;().&lt;/span&gt;&lt;span class="na"&gt;size&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;monthlyTxCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;

&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="c1"&gt;// Compute the average number of transactions per block per month.&lt;/span&gt;
&lt;span class="n"&gt;Map&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Float&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;monthlyAvgTxCountPerBlock&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;HashMap&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;gt;();&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;month&lt;/span&gt; &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;monthlyBlockCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;keySet&lt;/span&gt;&lt;span class="o"&gt;())&lt;/span&gt;
    &lt;span class="n"&gt;monthlyAvgTxCountPerBlock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;put&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;float&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="n"&gt;monthlyTxCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="n"&gt;monthlyBlockCount&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;month&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That’s it! In order to appreciate the hassle-free simplicity of the bitcoinj
interface, you ought to take your time and spend a couple of hours on other
tools first. (About the performance, for the sample blockchain dataset of size
4.7 GB, above code snippet completes in less than 2 minutes on my 2.4 GHz
GNU/Linux notebook without any JVM flags. Pretty zippy!)&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2014-05-16://blog/post/2014/05/16/bandwidth-shaping/</id>
    <title type="html">Bandwidth Shaping on Linux</title>
    <published>2014-05-16T15:05:00Z</published>
    <updated>2014-05-16T15:05:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2014/05/16/bandwidth-shaping/"/>
    <content type="html">&lt;p&gt;Networking stack in Linux kernel by default ships an immense set of
functionality that provide every hairy sort of tuning a network administrator
can (and most of the time, cannot) imagine. But unfortunately it totally lacks a
user-friendly interface for the average programmer, not to mention the regular
desktop users.&lt;/p&gt;

&lt;p&gt;&lt;a href="http://xkcd.com/619/"&gt;&lt;img src="xkcd.png" alt="Supported Features"&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Each time I need to come up with a &lt;a href="http://lartc.org/manpages/tc.txt"&gt;&lt;code&gt;tc&lt;/code&gt;&lt;/a&gt;
one-liner for traffic shaping, I find myself reading &lt;a href="http://www.lartc.org/"&gt;Linux Advanced Routing &amp;amp;
Traffic Control&lt;/a&gt; guide (aka. LARTC) all over again. No
exceptions! (Luckily they keep it up to date with the recent kernel versions,
which is something not expected in the GNU/Linux documentation ecosystem.) I
must admit that, it has almost been 16 years since I last used Microsoft Windows
on desktop, but I met with no alternative to the beloved
&lt;a href="http://www.netlimiter.com/"&gt;NetLimiter&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href="http://www.netlimiter.com/"&gt;&lt;img src="netlimiter.png" alt="NetLimiter"&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fate knocked my door again and this time I am assigned with the task of
providing access to an &lt;code&gt;iperf&lt;/code&gt; server with two different packet schedulings as
follows.&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;In the first interface, I need to cut down the bandwidth to a certain threshold, e.g., 1Mbps.&lt;/li&gt;
  &lt;li&gt;In the second one, I need to introduce some extra delay to each packet, e.g., 200ms.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;Luckily, &lt;code&gt;iperf&lt;/code&gt; was set to run over TCP and just playing with the egress
packets did suffice.&lt;/p&gt;

&lt;p&gt;I first picked the easiest task: adding latency. In this case,
&lt;a href="http://www.linuxfoundation.org/collaborate/workgroups/networking/netem"&gt;&lt;code&gt;netem&lt;/code&gt;&lt;/a&gt;
provides a decent collection of examples and I quickly came up with a working
solution.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-bash"&gt;tc qdisc add dev eth0 root netem delay 200ms&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;For the next task, I skimmed through the &lt;a href="http://lartc.org/howto/lartc.qdisc.html"&gt;Queueing Disciplines for Bandwidth
Management&lt;/a&gt; section in LARTC and
figured out a solution.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-bash"&gt;tc qdisc add dev eth0 root tbf rate 1024kbit buffer 1600 limit 3000&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Is it just me or that has been fairly easy? Later it turned out that it was just
the beginning. Here, the problem is that the above &lt;code&gt;tc&lt;/code&gt; one-liners take effect
on &lt;em&gt;every&lt;/em&gt; packet transmitted through &lt;code&gt;eth0&lt;/code&gt;. So how one can shape just the
&lt;code&gt;iperf&lt;/code&gt; traffic? After wasting my whole day on this, I came up with the
following &lt;code&gt;tc&lt;/code&gt; kung-fu.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tc qdisc add dev eth0 root handle 1: prio
tc qdisc add dev eth0 parent 1:3 handle 30: netem delay 200ms
tc filter add dev eth0 protocol ip parent 1:0 u32 match ip sport 34001 0xffff flowid 1:3
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That is, I set &lt;code&gt;iperf&lt;/code&gt; to run on port 34001 and instructed &lt;code&gt;tc&lt;/code&gt; rule to apply
just for packets outgoing from &lt;code&gt;sport&lt;/code&gt; 34001.&lt;/p&gt;

&lt;p&gt;All said and done, combining both rules (i.e., &lt;code&gt;netem&lt;/code&gt; and &lt;code&gt;tbf&lt;/code&gt;) was turned out
to be a nightmare. I even put one of the test servers into an inaccessible state
and needed walk down to the server room to fix the problem by hand. After hours
and hours of try and failures, I finally managed to find a working solution:&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-bash"&gt;tc qdisc add dev eth0 root handle 1: prio
tc qdisc add dev eth0 parent 1:2 handle 20: tbf rate 1024kbit buffer 1600 limit 3000
tc qdisc add dev eth0 parent 1:3 handle 30: netem delay 200ms
tc filter add dev eth0 protocol ip parent 1: prio 2 route flowid 1:1
tc filter add dev eth0 protocol ip parent 1: prio 1 u32 match ip sport 34002 0xffff flowid 1:2
tc filter add dev eth0 protocol ip parent 1: prio 1 u32 match ip sport 34003 0xffff flowid 1:3&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In this setting, I run two &lt;code&gt;iperf&lt;/code&gt; instances listening for incoming connections
on ports 34002 and 34003. (First filter directs any unmatched packet to class
&lt;code&gt;1:1&lt;/code&gt; created by &lt;code&gt;prio&lt;/code&gt; queue.)&lt;/p&gt;

&lt;p&gt;I could have explained the above &lt;code&gt;tc&lt;/code&gt; snippets in detail and written a couple
more that demonstrate simple use cases for the readers, but believe me, that
would have no points at all. If you have a traffic shaping problem and stucked
with &lt;code&gt;tc&lt;/code&gt;, you practically have two options: You either (try hard and) find
somebody to do the work for you – which is the recommended approach, or start
reading the &lt;a href="http://lartc.org/howto/lartc.qdisc.terminology.html"&gt;Terminology&lt;/a&gt;
section and make your way through a working solution.&lt;/p&gt;

&lt;p&gt;After all this fuss, everytime I read the very first sentence of the &lt;a href="http://lartc.org/howto/lartc.qdisc.html"&gt;Queueing
Disciplines for Bandwidth Management&lt;/a&gt;
chapter in LARTC, it makes me smile: &lt;strong&gt;Now, when I discovered this, it really
blew me away.&lt;/strong&gt; So true!&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2014-02-14://blog/post/2014/02/14/java-safe-publication/</id>
    <title type="html">Safe Object Publication in Java</title>
    <published>2014-02-14T12:22:00Z</published>
    <updated>2014-02-14T12:22:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2014/02/14/java-safe-publication/"/>
    <content type="html">&lt;p&gt;I have just finished reading &lt;a href="http://jcip.net/"&gt;Java Concurrency in Practice&lt;/a&gt; yesterday and would like to share some excerpts from the book on safe object publication in Java. Before stepping into the details, I would like to state that I found every single page of the book quite useful and found numerous places that I can enhance my existing code base during my daily coding routine. Thanks to &lt;a href="https://twitter.com/BrianGoetz"&gt;@BrianGoetz&lt;/a&gt; et al for such a comprehensive and practical guide.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;[Presented excerpts are copied directly, sometimes with slight changes, from &lt;a href="http://jcip.net/"&gt;Java Concurrency in Practice&lt;/a&gt;.]&lt;/em&gt;&lt;/p&gt;

&lt;h1 id="safe-construction-practices"&gt;Safe Construction Practices&lt;/h1&gt;

&lt;p&gt;An object is in a predictable, consistent state only after its constructor returns, so publishing an object from within its constructor can publish an incompletely constructed object. This is true &lt;em&gt;even if the publication is the last statement in the constructor&lt;/em&gt;. If the &lt;code&gt;this&lt;/code&gt; reference escapes during construction, the object is considered &lt;em&gt;not properly constructed&lt;/em&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;ThisEscape&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="nf"&gt;ThisEscape&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;EventSource&lt;/span&gt; &lt;span class="n"&gt;source&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;source&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;registerListener&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
            &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;EventListener&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
                &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;onEvent&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Event&lt;/span&gt; &lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
                    &lt;span class="n"&gt;doSomething&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
                &lt;span class="o"&gt;}&lt;/span&gt;
            &lt;span class="o"&gt;});&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here, when &lt;code&gt;ThisEscape&lt;/code&gt; publishes the &lt;code&gt;EventListener&lt;/code&gt;, it implicitly publishes the enclosing &lt;code&gt;ThisEscape&lt;/code&gt; instance as well, because inner class instances contain a hidden reference to the enclosing instance.&lt;/p&gt;

&lt;p&gt;If you are tempted to register an event listener or start a thread from a constructor, you can avoid the improper construction by using a private constructor and a public factory method, as shown in &lt;code&gt;SafeListener&lt;/code&gt; below.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;SafeListener&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;final&lt;/span&gt; &lt;span class="n"&gt;EventListener&lt;/span&gt; &lt;span class="n"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="nf"&gt;SafeListener&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;listener&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;EventListener&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
            &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;onEvent&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Event&lt;/span&gt; &lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
                &lt;span class="n"&gt;doSomething&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
            &lt;span class="o"&gt;}&lt;/span&gt;
        &lt;span class="o"&gt;}&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;SafeListener&lt;/span&gt; &lt;span class="nf"&gt;newInstance&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;EventSource&lt;/span&gt; &lt;span class="n"&gt;source&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;SafeListener&lt;/span&gt; &lt;span class="n"&gt;safe&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;SafeListener&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
        &lt;span class="n"&gt;source&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;registerListener&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;safe&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;listener&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;safe&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id="lazy-initialization"&gt;Lazy Initialization&lt;/h1&gt;

&lt;p&gt;Unsafe publication can happen as a result of an incorrect lazy initialization as follows.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="nd"&gt;@NotThreadSafe&lt;/span&gt;
&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;UnsafeLazyInitialization&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Resource&lt;/span&gt; &lt;span class="n"&gt;resource&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Resource&lt;/span&gt; &lt;span class="nf"&gt;getInstance&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;resource&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;resource&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Resource&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;resource&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Under certain circumstances, such as when all instances of the &lt;code&gt;Resource&lt;/code&gt; are identical, you might be willing to overlook these (along with the inefficiency of possibly creating the &lt;code&gt;Resource&lt;/code&gt; more than once). Unfortunately, even if these defects are overlooked, &lt;code&gt;UnsafeLazyInitialization&lt;/code&gt; is still not safe, because another thread could observe a reference to a partially constructed &lt;code&gt;Resource&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Suppose thread &lt;code&gt;A&lt;/code&gt; is the first to invoke &lt;code&gt;getInstance&lt;/code&gt;. It sees that &lt;code&gt;resource&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;, instantiates a new &lt;code&gt;Resource&lt;/code&gt;, and sets &lt;code&gt;resource&lt;/code&gt; to reference it. When thread &lt;code&gt;B&lt;/code&gt; later calls &lt;code&gt;getInstance&lt;/code&gt;, it might see that &lt;code&gt;resource&lt;/code&gt; already has a non-null value and just use the already constructed &lt;code&gt;Resource&lt;/code&gt;. This might look harmless at first, but &lt;em&gt;there is no happens-before ordering between the writing of &lt;code&gt;resource&lt;/code&gt; in &lt;code&gt;A&lt;/code&gt; and the reading of &lt;code&gt;resource&lt;/code&gt; in &lt;code&gt;B&lt;/code&gt;&lt;/em&gt;. A data race has been used to publish the object, and therefore &lt;code&gt;B&lt;/code&gt; is not guaranteed to see the correct state of the &lt;code&gt;Resource&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;Resource&lt;/code&gt; constructor changes the fields of the freshly allocated &lt;code&gt;Resource&lt;/code&gt; from their default values (written by the &lt;code&gt;Object&lt;/code&gt; constructor) to their initial values. Since neither thread used synchronization, &lt;code&gt;B&lt;/code&gt; could possible see &lt;code&gt;A&lt;/code&gt;’s actions in a different order than &lt;code&gt;A&lt;/code&gt; performed them. So even though &lt;code&gt;A&lt;/code&gt; initialized the &lt;code&gt;Resource&lt;/code&gt; before setting &lt;code&gt;resource&lt;/code&gt; to reference it, &lt;code&gt;B&lt;/code&gt; could see the write to &lt;code&gt;resource&lt;/code&gt; as occuring &lt;em&gt;before&lt;/em&gt; the writes to the fields of the &lt;code&gt;Resource&lt;/code&gt;. &lt;code&gt;B&lt;/code&gt; could thus see a partially constructed &lt;code&gt;Resource&lt;/code&gt; that may well be in an invalid state – and whose state may unexpectedly change later.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;UnsafeLazyInitialization&lt;/code&gt; can be fixed by making the &lt;code&gt;getResource&lt;/code&gt; method &lt;code&gt;synchronized&lt;/code&gt; as follows.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="nd"&gt;@ThreadSafe&lt;/span&gt;
&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;SafeLazyInitialization&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Resource&lt;/span&gt; &lt;span class="n"&gt;resource&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;synchronized&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Resource&lt;/span&gt; &lt;span class="nf"&gt;getInstance&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;resource&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;resource&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Resource&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;resource&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Because the code path through the &lt;code&gt;getInstance&lt;/code&gt; is fairly short (a test and a predicted branch), if &lt;code&gt;getInstance&lt;/code&gt; is not called frequently by many threads, there is a little enough contention for the &lt;code&gt;SafeLazyInitialization&lt;/code&gt; lock that this approach offers adequate performance.&lt;/p&gt;

&lt;p&gt;The treatment of static fields with initializers (or fields whose value is initialized in a static initialization block [JPL 2.2.1 and 2.5.3]) is somewhat special and offers additional thread-safety guarantees. Static initializers are run by the JVM at class initialization time, after class loading but before the class is used by any thread. Because the JVM acquires a lock during initialization [JSL 12.4.2] and this lock is acquired by each thread at least once to ensure that the class has been loaded, memory writes made during static initialization are automatically visible to all threads. Thus statically initialized objects require no explicit synchronization either during construction or when being referenced. However, this applies only to the &lt;em&gt;as-constructed&lt;/em&gt; state – if the object is mutable, synchronization is still required by both readers and writers to make subsequent modifications visible to avoid data corruption.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="nd"&gt;@ThreadSafe&lt;/span&gt;
&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;EagerInitialization&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Resource&lt;/span&gt; &lt;span class="n"&gt;resource&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Resource&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Resource&lt;/span&gt; &lt;span class="nf"&gt;getResource&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;resource&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt; &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Using eager initialization eliminates the synchronization cost incurred on each call to &lt;code&gt;getInstace&lt;/code&gt; in &lt;code&gt;SafeLazyInitialization&lt;/code&gt;. This technique can be combined with the JVM’s lazy class loading to create a lazy initialization technique that does not require synchronization on the common code path. The &lt;em&gt;lazy initialization holder class&lt;/em&gt; idiom [EJ Item 48] presented below uses a class whose only purpose is to initialize the &lt;code&gt;Resource&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="nd"&gt;@ThreadSafe&lt;/span&gt;
&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;ResourceFactory&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;ResourceHolder&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Resource&lt;/span&gt; &lt;span class="n"&gt;resource&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Resource&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;Resource&lt;/span&gt; &lt;span class="nf"&gt;getResource&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ResourceHolder&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;resource&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here the JVM defers initializing the &lt;code&gt;ResourceHolder&lt;/code&gt; class until it is actually used [JLS 12.4.1], and because the &lt;code&gt;Resource&lt;/code&gt; is initialized with a static initializer, no additional synchronization is needed. The first call to &lt;code&gt;getResource&lt;/code&gt; by any thread causes &lt;code&gt;ResourceHolder&lt;/code&gt; to be loaded and initialized, at which time the initialization of the &lt;code&gt;Resource&lt;/code&gt; happens through the static initializer.&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2014-01-03://blog/post/2014/01/03/tcp-time-wait/</id>
    <title type="html">Sockets, TCP Keep Alive and TIME_WAIT</title>
    <published>2014-01-03T19:19:00Z</published>
    <updated>2014-01-03T19:19:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2014/01/03/tcp-time-wait/"/>
    <content type="html">&lt;p&gt;Time to time I share some technical links on Twitter and let them get lost in the internet junk yard. I thought it might be a better idea to archive them on my blog in a more organized fashion. (I will group such posts under tag &lt;a href="/blog/tag/link"&gt;link&lt;/a&gt;.) This way they will at least be more accessible by myself. This post is my first effort towards this goal. (Sorry for the ugly Twitter embeddings. I find some 3rd party libraries to configure the display, but that stuff usually gets broken in the long run due to changes in the Twitter API.)&lt;/p&gt;

&lt;p&gt;Last month I have been bitten seriously by a software bug caused by &lt;code&gt;TIME_WAIT&lt;/code&gt; sockets. Below is the list of links I found useful in the pursuit of trying to solve the problem.&lt;/p&gt;

&lt;blockquote class="twitter-tweet" lang="en" data-conversation="none" data-cards="hidden"&gt;
&lt;p&gt;Multi-platform &lt;a href="https://twitter.com/search?q=%23TCP&amp;amp;src=hash"&gt;#TCP&lt;/a&gt; Keep Alive guide: &lt;a href="http://t.co/uEukpMrCEV"&gt;http://t.co/uEukpMrCEV&lt;/a&gt; &lt;a href="https://twitter.com/search?q=%23bsd&amp;amp;src=hash"&gt;#bsd&lt;/a&gt; &lt;a href="https://twitter.com/search?q=%23linux&amp;amp;src=hash"&gt;#linux&lt;/a&gt; &lt;a href="https://twitter.com/search?q=%23solaris&amp;amp;src=hash"&gt;#solaris&lt;/a&gt; &lt;a href="https://twitter.com/search?q=%23windows&amp;amp;src=hash"&gt;#windows&lt;/a&gt; &lt;a href="https://twitter.com/search?q=%23osx&amp;amp;src=hash"&gt;#osx&lt;/a&gt;&lt;/p&gt;— Volkan Yazıcı (@yazicivo) &lt;a href="https://twitter.com/yazicivo/statuses/413989234052067328"&gt;December 20, 2013&lt;/a&gt;
&lt;/blockquote&gt;

&lt;blockquote class="twitter-tweet" lang="en" data-conversation="none" data-cards="hidden"&gt;
&lt;p&gt;The ultimate guide to socket/bind/connect: &lt;a href="http://t.co/7YjSiIfWnX"&gt;http://t.co/7YjSiIfWnX&lt;/a&gt; &lt;a href="https://twitter.com/search?q=%23bsd&amp;amp;src=hash"&gt;#bsd&lt;/a&gt; &lt;a href="https://twitter.com/search?q=%23linux&amp;amp;src=hash"&gt;#linux&lt;/a&gt; &lt;a href="https://twitter.com/search?q=%23unix&amp;amp;src=hash"&gt;#unix&lt;/a&gt; &lt;a href="https://twitter.com/search?q=%23network&amp;amp;src=hash"&gt;#network&lt;/a&gt; &lt;a href="https://twitter.com/search?q=%23programming&amp;amp;src=hash"&gt;#programming&lt;/a&gt;&lt;/p&gt;— Volkan Yazıcı (@yazicivo) &lt;a href="https://twitter.com/yazicivo/statuses/413970759489294336"&gt;December 20, 2013&lt;/a&gt;
&lt;/blockquote&gt;

&lt;blockquote class="twitter-tweet" lang="en" data-conversation="none" data-cards="hidden"&gt;
&lt;p&gt;Suffering from &lt;a href="https://twitter.com/search?q=%23TIME_WAIT&amp;amp;src=hash"&gt;#TIME_WAIT&lt;/a&gt; &lt;a href="https://twitter.com/search?q=%23sockets&amp;amp;src=hash"&gt;#sockets&lt;/a&gt; while trying to handle thousands of connections? Enabled tcp_tw_recycle? &lt;a href="http://t.co/XGdPYNibGE"&gt;http://t.co/XGdPYNibGE&lt;/a&gt; &lt;a href="https://twitter.com/search?q=%23linux&amp;amp;src=hash"&gt;#linux&lt;/a&gt;&lt;/p&gt;— Volkan Yazıcı (@yazicivo) &lt;a href="https://twitter.com/yazicivo/statuses/413967038147612672"&gt;December 20, 2013&lt;/a&gt;
&lt;/blockquote&gt;

&lt;blockquote class="twitter-tweet" lang="en" data-conversation="none" data-cards="hidden"&gt;
&lt;p&gt;tcpdrop: Drop TCP flows, unschedule TIME_WAIT sockets &lt;a href="https://t.co/c8mP6Bn8f7"&gt;https://t.co/c8mP6Bn8f7&lt;/a&gt;&lt;/p&gt;— Volkan Yazıcı (@yazicivo) &lt;a href="https://twitter.com/yazicivo/statuses/403816364445429760"&gt;November 22, 2013&lt;/a&gt;
&lt;/blockquote&gt;

&lt;blockquote class="twitter-tweet" lang="en"&gt;
&lt;p&gt;RT &lt;a href="https://twitter.com/EmreSevinc"&gt;@EmreSevinc&lt;/a&gt;: Coping with the TCP TIME-WAIT state on busy Linux servers &lt;a href="http://t.co/juPGPxaRad"&gt;http://t.co/juPGPxaRad&lt;/a&gt;&lt;/p&gt;— Volkan Yazıcı (@yazicivo) &lt;a href="https://twitter.com/yazicivo/statuses/438630417722540032"&gt;February 26, 2014&lt;/a&gt;
&lt;/blockquote&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2014-01-03://blog/post/2014/01/03/safe-math-ops/</id>
    <title type="html">Detecting Overflows in Java Arithmetic Operators</title>
    <published>2014-01-03T18:13:00Z</published>
    <updated>2014-01-03T18:13:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2014/01/03/safe-math-ops/"/>
    <content type="html">&lt;p&gt;A couple of months ago I came across &lt;a href="https://www.securecoding.cert.org/confluence/display/java/The+CERT+Oracle+Secure+Coding+Standard+for+Java"&gt;The CERT Oracle Secure Coding Standard for Java&lt;/a&gt;. It is suprising how come I did not find this fascinating resource before. I first skimmed through the chapters and figured out that the recommended conventions are so practical that I can even directly use some of them in my existing code base. Right at that time I was working on a routing engine, which performs some arithmetic operators over link costs. It was a good place to apply the conventions metioned in the chapter &lt;a href="https://www.securecoding.cert.org/confluence/display/java/NUM00-J.+Detect+or+prevent+integer+overflow"&gt;NUM00-J. Detect or prevent integer overflow&lt;/a&gt;. Hence, I directly copied safe versions of arithmetic operators into my &lt;code&gt;util&lt;/code&gt; package. (Everybody does have a &lt;code&gt;util&lt;/code&gt;, right?)&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="nf"&gt;safeAdd&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;OverflowException&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
            &lt;span class="o"&gt;?&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Integer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;MAX_VALUE&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;
            &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;Integer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;MIN_VALUE&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;throw&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;ArithmeticException&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;format&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
                &lt;span class="s"&gt;"Integer overflow: %d + %d"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="nf"&gt;safeMultiply&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
        &lt;span class="kd"&gt;throws&lt;/span&gt; &lt;span class="n"&gt;ArithmeticException&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
            &lt;span class="o"&gt;?&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Integer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;MAX_VALUE&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;Integer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;MIN_VALUE&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;
            &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;
                &lt;span class="o"&gt;?&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Integer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;MIN_VALUE&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;Integer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;MAX_VALUE&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;
                &lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;Integer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;MIN_VALUE&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt;
        &lt;span class="k"&gt;throw&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nf"&gt;ArithmeticException&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;format&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;
                &lt;span class="s"&gt;"Integer overflow: %d x %d"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;To my suprise, I observed integer overflow error messages in the server logs today. Yay! Further examination of the problem revealed that I cause an integer overflow while taking the square of link costs for a particular routing algorithm. Some might argue about the overhead of replacing operators with methods, but let’s think about this: How would I ever figure this problem out if I would not be using these safe arithmetic operators. No need to mention about the problem’s consequences.&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2013-12-04://blog/post/2013/12/04/combinations/</id>
    <title type="html">Key to Parallel Combinations: Enumeration</title>
    <published>2013-12-04T16:44:00Z</published>
    <updated>2013-12-04T16:44:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2013/12/04/combinations/"/>
    <content type="html">&lt;p&gt;Combinations have many use cases in the daily life of a programmer: for
testing a given function, for generating the all possible input sets of a
particular problem instance, etc. Writing them down in lexicographic order is
something we all do time to time. For instance, 2-combination of a set
&lt;script type="math/tex"&gt;(0, 1, 2, 3)&lt;/script&gt; can simply be written as follows.&lt;/p&gt;

&lt;script type="math/tex; mode=display"&gt;{(0, 1), (0, 2), (0, 3), (1, 2), (1, 3), (2, 3)}&lt;/script&gt;&lt;p&gt;We also have a shortcut to get the total number of combinations for a particular
instance. That is,&lt;/p&gt;

&lt;script type="math/tex; mode=display"&gt;{n \choose r} = \frac{n(n-1)\ldots(n-r+1)}{r(r-1)\dots1}=\frac{n!}{r!(n-r)!},&lt;/script&gt;&lt;p&gt;which applies to our above example 4-choose-2 as follows:
&lt;script type="math/tex"&gt;{4 \choose 2} = \frac{4 \times 3}{2} = 6&lt;/script&gt;.&lt;/p&gt;

&lt;p&gt;You might also have noticed the pattern we used to generate the combinations in
lexicographic order. The algorithm finds the rightmost index element that can be
incremented, increments it, and then changes the elements to the right to each
be 1 plus the element on their left. This procedure repeats until there are no
more rooms left to increment. (You might want to check out &lt;a href="http://eu.wiley.com/WileyCDA/WileyTitle/productCd-%0AEHEP001993.html"&gt;Applied
Combinatorics&lt;/a&gt; by Alan Tucker for further details of the algorithm.)&lt;/p&gt;

&lt;p&gt;One advantage of generating combinations in lexicographic order using the above
algorithm is that given the &lt;script type="math/tex"&gt;k&lt;/script&gt;‘th combination, one can easily generate
&lt;script type="math/tex"&gt;k+1&lt;/script&gt;‘th combination. Which leads us to the fact that one can continue
generating combinations given the combination at a particular position.&lt;/p&gt;

&lt;h1 id="the-problem"&gt;The Problem&lt;/h1&gt;

&lt;p&gt;In the case of a single consumer, one can iterate over a set of combinations
step by step. However, what if there are multiple consumers? In this case, a
single producer can present a central combination queue, where it pushes new
combinations on demand, and then the consumers can poll the queue as they
desire. That being said, in this setup the producer can become the bottleneck.
That is, what if consumers poll the queue at a speed faster than the producer’s
push rate? Houston, we have a problem.&lt;/p&gt;

&lt;p&gt;Previously we have seen that given the &lt;script type="math/tex"&gt;k&lt;/script&gt;‘th combination, we can compute the
&lt;script type="math/tex"&gt;k+1&lt;/script&gt;‘th one. In addition, we also know how to calculate the total number of
combinations, that is, &lt;script type="math/tex"&gt;{n \choose r}&lt;/script&gt;. With this in mind, we can split the
all possible combinations set &lt;script type="math/tex"&gt;\{c_1, c_2, \dots\}&lt;/script&gt; into two separate parts:&lt;/p&gt;

&lt;script type="math/tex; mode=display"&gt;
\{c_1, \dots, c_m\} \textrm{ and } \{c_{m+1}, \dots, c_l\}, \\
\textrm{where } l = {n \choose r} \textrm{ and } m = \lfloor ^l/_2 \rfloor.
&lt;/script&gt;&lt;p&gt;Going from &lt;script type="math/tex"&gt;c_1&lt;/script&gt; to &lt;script type="math/tex"&gt;c_m&lt;/script&gt; is trivial, we can keep a counter for the
generated combinations up to &lt;script type="math/tex"&gt;m&lt;/script&gt;. But what about &lt;script type="math/tex"&gt;c_{m+1}&lt;/script&gt;? How can we
compute the &lt;script type="math/tex"&gt;{m+1}&lt;/script&gt;‘th combination without having a prior information about
&lt;script type="math/tex"&gt;m&lt;/script&gt;‘th one. In other words, can we calculate &lt;script type="math/tex"&gt;c_{m+1}&lt;/script&gt;, given just &lt;script type="math/tex"&gt;n&lt;/script&gt; and
&lt;script type="math/tex"&gt;r&lt;/script&gt;?&lt;/p&gt;

&lt;h1 id="enumerating-combinations"&gt;Enumerating Combinations&lt;/h1&gt;

&lt;p&gt;Lucky for us, there exists a vast literature for &lt;a href="http://en.wikipedia.org/wiki/Combinatorial_number_system"&gt;combinatorial number
system&lt;/a&gt;, where people
come up with a way to enumerate combinations. Long story short, combinatorial
number system presents a mapping between natural numbers (taken to include 0)
and the combinations. In a combinatorial number system of degree &lt;script type="math/tex"&gt;r&lt;/script&gt;, each
natural number &lt;script type="math/tex"&gt;b\in\mathbb{N}&lt;/script&gt; map to a one and only one r-combination
&lt;script type="math/tex"&gt;[d_1, d_2, \dots, d_r]&lt;/script&gt; with the following equality.&lt;/p&gt;

&lt;script type="math/tex; mode=display"&gt;
b = {d_1 \choose r} + {d_2 \choose r-1} + \dots + {d_r \choose 1},\\
\textrm{ where } d_1 &gt; d_2 &gt; \dots &gt; d_r.
&lt;/script&gt;&lt;p&gt;For instance, let &lt;script type="math/tex"&gt;b=8&lt;/script&gt; and &lt;script type="math/tex"&gt;r=2&lt;/script&gt;. Here &lt;script type="math/tex"&gt;b&lt;/script&gt; corresponds to the
2-combination &lt;script type="math/tex"&gt;[4, 2]&lt;/script&gt; in combinatorial number system of degree 2 with the
following equality.&lt;/p&gt;

&lt;script type="math/tex; mode=display"&gt;8 = {4 \choose 2} + {2 \choose 1}&lt;/script&gt;&lt;p&gt;The r-combination of a given number &lt;script type="math/tex"&gt;b&lt;/script&gt; can be computed using the following
greedy algorithm: take &lt;script type="math/tex"&gt;d_i&lt;/script&gt; maximal with &lt;script type="math/tex"&gt;{d_i \choose i} \leq b&lt;/script&gt;, then
take &lt;script type="math/tex"&gt;d_{i-1}&lt;/script&gt; maximal with &lt;script type="math/tex"&gt;{d_{i-1} \choose i-1} \leq b - {d_i \choose i}&lt;/script&gt;,
and so forth.&lt;/p&gt;

&lt;p&gt;So far so good. Let’s do the magic. Suppose that we want to enumerate the
combinations of 5-choose-2. That is, we want the following mapping.&lt;/p&gt;

&lt;script type="math/tex; mode=display"&gt;
0 \rightarrow [0, 1] \quad 5 \rightarrow [1, 3] \\
1 \rightarrow [0, 2] \quad 6 \rightarrow [1, 4] \\
2 \rightarrow [0, 3] \quad 7 \rightarrow [2, 3] \\
3 \rightarrow [0, 4] \quad 8 \rightarrow [2, 4] \\
4 \rightarrow [1, 2] \quad 9 \rightarrow [3, 4]
&lt;/script&gt;&lt;p&gt;We know that &lt;script type="math/tex"&gt;{5 \choose 2} = 10&lt;/script&gt;, hence we have 10 combinations enumerated
from 0 to 9. Let’s try to find the 3rd combination in this sequence from
scratch.&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;First, we set &lt;script type="math/tex"&gt;i&lt;/script&gt; to the index of the combination we are interested in: &lt;script type="math/tex"&gt;i=3&lt;/script&gt;
&lt;/li&gt;
  &lt;li&gt;Second, we set &lt;script type="math/tex"&gt;j&lt;/script&gt; to the dual index of &lt;script type="math/tex"&gt;i&lt;/script&gt; in &lt;script type="math/tex"&gt;{5 \choose 2}&lt;/script&gt; system:
&lt;script type="math/tex"&gt;j = {5 \choose 2} - i - 1 = 6&lt;/script&gt;.&lt;/li&gt;
  &lt;li&gt;Now let’s find the 2-combination of &lt;script type="math/tex"&gt;j&lt;/script&gt;: &lt;script type="math/tex"&gt;6 = {4 \choose 2} + {0 \choose 1}&lt;/script&gt;,
that is, the 2-combination corresponding to &lt;script type="math/tex"&gt;j=6&lt;/script&gt; is &lt;script type="math/tex"&gt;[4, 0]&lt;/script&gt;.&lt;/li&gt;
  &lt;li&gt;Next we subtract the found 2-combination from the mask &lt;script type="math/tex"&gt;[4, 4]&lt;/script&gt;, where 4’s
comes from &lt;script type="math/tex"&gt;5-1&lt;/script&gt;: &lt;script type="math/tex"&gt;[4, 4] - [4, 0] = [0, 4]&lt;/script&gt;.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;Yay! 3rd combination of &lt;script type="math/tex"&gt;{5 \choose 2}&lt;/script&gt; system is &lt;script type="math/tex"&gt;[0, 4]&lt;/script&gt;! Hrm… Was that
a coincidence? Let’s give it another try with 8th combination this time.&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;First, we set &lt;script type="math/tex"&gt;i&lt;/script&gt; to the index of the combination we are interested in: &lt;script type="math/tex"&gt;i=8&lt;/script&gt;
&lt;/li&gt;
  &lt;li&gt;Second, we set &lt;script type="math/tex"&gt;j&lt;/script&gt; to the dual index of &lt;script type="math/tex"&gt;i&lt;/script&gt; in &lt;script type="math/tex"&gt;{5 \choose 2}&lt;/script&gt; system:
&lt;script type="math/tex"&gt;j = {5 \choose 2} - i - 1 = 1&lt;/script&gt;.&lt;/li&gt;
  &lt;li&gt;Now let’s find the 2-combination of &lt;script type="math/tex"&gt;j&lt;/script&gt;: &lt;script type="math/tex"&gt;1 = {2 \choose 2} + {0 \choose 1}&lt;/script&gt;,
that is, the 2-combination corresponding to &lt;script type="math/tex"&gt;j=1&lt;/script&gt; is &lt;script type="math/tex"&gt;[2, 0]&lt;/script&gt;.&lt;/li&gt;
  &lt;li&gt;Next we subtract the found 2-combination from the mask &lt;script type="math/tex"&gt;[4, 4]&lt;/script&gt;:
&lt;script type="math/tex"&gt;[4, 4] - [2, 0] = [2, 4]&lt;/script&gt;.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;8th combination turns out to be &lt;script type="math/tex"&gt;[2, 4]&lt;/script&gt;. Eureka!&lt;/p&gt;

&lt;h1 id="conclusion"&gt;Conclusion&lt;/h1&gt;

&lt;p&gt;We have shown that using &lt;script type="math/tex"&gt;r&lt;/script&gt;-combinations one can compute the &lt;script type="math/tex"&gt;k&lt;/script&gt;‘th
combination among the lexicographically ordered set of combinations of
&lt;script type="math/tex"&gt;n&lt;/script&gt;-choose-&lt;script type="math/tex"&gt;r&lt;/script&gt;, where &lt;script type="math/tex"&gt;0 \leq k \lt {n \choose r}&lt;/script&gt;. Using this method we
can partition the space of all combinations into multiple subsets and generate
each of them individually. For this purpose, I put together a Java library:
&lt;a href="https://github.com/vy/combination"&gt;combination&lt;/a&gt;. Here is a sample snippet.&lt;/p&gt;

&lt;pre&gt;&lt;code class="language-java"&gt;&lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Main&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;

    &lt;span class="kd"&gt;public&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;main&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;Combination&lt;/span&gt; &lt;span class="n"&gt;c52&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;Combination&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="kt"&gt;long&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;c52&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;size&lt;/span&gt;&lt;span class="o"&gt;();&lt;/span&gt;
        &lt;span class="n"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"size(c52): %d"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"c52"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;CombinationIterator&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="n"&gt;c52&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;iterator&lt;/span&gt;&lt;span class="o"&gt;());&lt;/span&gt;
        &lt;span class="cm"&gt;/*&lt;/span&gt;
&lt;span class="cm"&gt;         * size(c52): 10&lt;/span&gt;
&lt;span class="cm"&gt;         * c52:&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [0, 1]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [0, 2]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [0, 3]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [0, 4]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [1, 2]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [1, 3]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [1, 4]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [2, 3]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [2, 4]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [3, 4]&lt;/span&gt;
&lt;span class="cm"&gt;         */&lt;/span&gt;

        &lt;span class="kt"&gt;long&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;l&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;;&lt;/span&gt;
        &lt;span class="n"&gt;CombinationIterator&lt;/span&gt; &lt;span class="n"&gt;c52_lhs&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;CombinationIterator&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;CombinationIterator&lt;/span&gt; &lt;span class="n"&gt;c52_rhs&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="n"&gt;CombinationIterator&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;

        &lt;span class="n"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"c52_lhs"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;c52_lhs&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="cm"&gt;/*&lt;/span&gt;
&lt;span class="cm"&gt;         * c52_lhs:&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [0, 1]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [0, 2]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [0, 3]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [0, 4]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [1, 2]&lt;/span&gt;
&lt;span class="cm"&gt;         */&lt;/span&gt;

        &lt;span class="n"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"c52_rhs"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;c52_rhs&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="cm"&gt;/*&lt;/span&gt;
&lt;span class="cm"&gt;         * c52_rhs:&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [2, 3]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [2, 4]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [3, 4]&lt;/span&gt;
&lt;span class="cm"&gt;         * -&amp;gt; [3, 4]&lt;/span&gt;
&lt;span class="cm"&gt;         */&lt;/span&gt;

        &lt;span class="n"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"5C2: %d"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Combination&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;choose&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
        &lt;span class="cm"&gt;/*&lt;/span&gt;
&lt;span class="cm"&gt;         * 5C2: 10&lt;/span&gt;
&lt;span class="cm"&gt;         */&lt;/span&gt;

        &lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="o"&gt;[]&lt;/span&gt; &lt;span class="n"&gt;c&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;];&lt;/span&gt;
        &lt;span class="n"&gt;Combination&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"3rd combination of 5C2: %s"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Arrays&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;toString&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
        &lt;span class="cm"&gt;/*&lt;/span&gt;
&lt;span class="cm"&gt;         * 3rd combination of 5C2: [0, 4]&lt;/span&gt;
&lt;span class="cm"&gt;         */&lt;/span&gt;

        &lt;span class="n"&gt;Combination&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;get&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="n"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"8th combination of 5C2: %s"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Arrays&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;toString&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
        &lt;span class="cm"&gt;/*&lt;/span&gt;
&lt;span class="cm"&gt;         * 8th combination of 5C2: [2, 4]&lt;/span&gt;
&lt;span class="cm"&gt;         */&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;fmt&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Object&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;System&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;out&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;format&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fmt&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="o"&gt;));&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;private&lt;/span&gt; &lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="kt"&gt;void&lt;/span&gt; &lt;span class="nf"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="n"&gt;caption&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;CombinationIterator&lt;/span&gt; &lt;span class="n"&gt;ci&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"%s:"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;caption&lt;/span&gt;&lt;span class="o"&gt;);&lt;/span&gt;
        &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ci&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;hasNext&lt;/span&gt;&lt;span class="o"&gt;())&lt;/span&gt;
            &lt;span class="n"&gt;println&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"-&amp;gt; %s"&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Arrays&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;toString&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ci&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="na"&gt;next&lt;/span&gt;&lt;span class="o"&gt;()));&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id="references"&gt;References&lt;/h1&gt;

&lt;p&gt;I started my pursuit with Wikipedia page of &lt;a href="http://en.wikipedia.org/wiki/Combinatorial_number_system"&gt;combinatorial number
system&lt;/a&gt;. In the
beginning it did not make much sense. Later I found the enlightening 2004 post
&lt;a href="http://msdn.microsoft.com/en-us/library/aa289166%28VS.71%29.aspx"&gt;Generating the mth Lexicographical Element of a Mathematical
Combination&lt;/a&gt;
by James McCaffrey, which cleared out the things and made me start to understand
the Wikipedia page.&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2013-08-06://blog/post/2013/08/06/output-packet-from-input-port/</id>
    <title type="html">How come a packet gets output from its input port?</title>
    <published>2013-08-06T17:29:00Z</published>
    <updated>2013-08-06T17:29:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2013/08/06/output-packet-from-input-port/"/>
    <content type="html">&lt;p&gt;A couple of weeks ago I spotted a really suspicious flow in the logs that directly made me think of a bug at the controller. A packet was arriving to a port of a switch and was getting output from the very same port of the switch. This was kind of weird. If it is supposed to be transmitted back again, then why was it ended up here in the first hand? Was it because of a bug at the controller that first redirected the packet to the switch and then redirected it backwards to the previous switch? A logical fault at the controller was definitely the first suspect here. But later it turned out that this was not the case. The details are as follows.&lt;/p&gt;

&lt;p&gt;&lt;img src="topology.jpg" alt="SDN Topology"&gt;&lt;/p&gt;

&lt;p&gt;Consider the above topology, where three switches &lt;code&gt;s1&lt;/code&gt;, &lt;code&gt;s2&lt;/code&gt;, &lt;code&gt;s3&lt;/code&gt; are connected linearly and all together managed by the controller &lt;code&gt;c1&lt;/code&gt;. In addition, &lt;code&gt;s1&lt;/code&gt; and &lt;code&gt;s2&lt;/code&gt; is connected to two hosts &lt;code&gt;h1&lt;/code&gt; and &lt;code&gt;h2&lt;/code&gt;, respectively. The controller, switches, hosts, their connections, and connection port numbers are given in the figure. The scenario generating the subtle gotcha is as follows.&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;
&lt;code&gt;h2&lt;/code&gt; sends a packet destined to &lt;code&gt;h1&lt;/code&gt;, whose attachment point is not learnt yet by &lt;code&gt;c1&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;Hence, upon arrival of the packet from &lt;code&gt;s2&lt;/code&gt;, &lt;code&gt;c1&lt;/code&gt; commands &lt;code&gt;s2&lt;/code&gt; to flood the request.&lt;/li&gt;
  &lt;li&gt;The flooded request goes to &lt;code&gt;s1&lt;/code&gt; and &lt;code&gt;s3&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;Upon arrival of the packet to &lt;code&gt;s1&lt;/code&gt;, &lt;code&gt;s1&lt;/code&gt; sends the packet to &lt;code&gt;c1&lt;/code&gt; again.&lt;/li&gt;
  &lt;li&gt;Since &lt;code&gt;c1&lt;/code&gt; still does not know the attachment point of &lt;code&gt;h1&lt;/code&gt;, &lt;code&gt;c1&lt;/code&gt; commands &lt;code&gt;s1&lt;/code&gt; to flood the request for a second time.&lt;/li&gt;
  &lt;li&gt;Flooded request from &lt;code&gt;s1&lt;/code&gt; reaches to &lt;code&gt;h1&lt;/code&gt; and &lt;code&gt;h1&lt;/code&gt; replies back.&lt;/li&gt;
  &lt;li&gt;With &lt;code&gt;h1&lt;/code&gt;s response, &lt;code&gt;c1&lt;/code&gt; learns the attachment point of &lt;code&gt;h1&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;In the meantime, &lt;code&gt;s2&lt;/code&gt;s flood (see 3rd step) reaches to &lt;code&gt;s3&lt;/code&gt;
&lt;/li&gt;
  &lt;li&gt;Now &lt;code&gt;c1&lt;/code&gt; knows the attachment point of the &lt;code&gt;h1&lt;/code&gt;. Consequently, &lt;code&gt;c1&lt;/code&gt; figures out that the route to &lt;code&gt;h1&lt;/code&gt; goes through &lt;code&gt;s1&lt;/code&gt; and &lt;code&gt;s1&lt;/code&gt; is reachable by &lt;code&gt;p1&lt;/code&gt; of &lt;code&gt;s3&lt;/code&gt;. Hence, &lt;code&gt;c1&lt;/code&gt; commands &lt;code&gt;s3&lt;/code&gt; to output the packet from the very same input port of the packet.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;I do not have a single idea about the probability of such a subtle bug, but somehow it happened to exist in my logs, right at the lines I was just taking a glance and wasted my whole day. The saying was right, network is really unreliable. Gorgeous!&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2013-08-06://blog/post/2013/08/06/sdn-discovery/</id>
    <title type="html">Discovery in Software-Defined Networks</title>
    <published>2013-08-06T17:29:00Z</published>
    <updated>2013-08-06T17:29:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2013/08/06/sdn-discovery/"/>
    <content type="html">&lt;p&gt;&lt;em&gt;Discovery&lt;/em&gt; can mean a couple of things in a software-defined network including, but is not limited to, the discovery of the 1) switches, 2) links, and 3) hosts. In this blog post I will briefly describe the basics of the underlying plumbing for these three &lt;em&gt;discovery&lt;/em&gt; tasks. Note that I will assume that the OpenFlow is employed as the south-bound protocol.&lt;/p&gt;

&lt;h1 id="discovery-of-the-switches"&gt;Discovery of the Switches&lt;/h1&gt;

&lt;p&gt;So how does a controller get to know the switches in its control domain and their features? A switch is initially configured with a &lt;em&gt;master&lt;/em&gt; controller IP address and a set of &lt;em&gt;slave&lt;/em&gt; controller IP addresses. While the most recent OpenFlow specifications allow a switch to simultaneously connect to multiple controllers, for simplicity, in this post I will assume that a switch first tries to connect to the master controller and if the connection fails, picks one of the slave controllers – that is, a switch is connected to a single controller at a time.&lt;/p&gt;

&lt;p&gt;When the switch establishes a (TCP) connection to a controller, controller sends a &lt;em&gt;feature request&lt;/em&gt; message to the switch and waits for a reply. When the reply reaches to the controller, controller gets informed about the features provided by the switch, for instance, the datapath ID (i.e., DPID), list of ports, etc.&lt;/p&gt;

&lt;h1 id="discovery-of-the-links"&gt;Discovery of the Links&lt;/h1&gt;

&lt;p&gt;When a switch connects to a controller, controller periodically (e.g., every 5 seconds) commands the switch to flood LLDP (Link Layer Discovery Protocol) and BDDP (Broadcast Domain Discovery Protocol) packets through all of its ports. A discovery protocol packet typically contains the DPID of the sender along with the port of the switch that the message originates from. The reserved set of destination MAC addresses and &lt;code&gt;ethertype&lt;/code&gt;s used by the discovery protocol packets lets the controller to differentiate them with the other data packets. LLDP is used to discover direct links between switches and BDDP is used to discover the switches in the same broadcast domain. LLDP and BDDP differ from each other by the &lt;code&gt;ethertype&lt;/code&gt;s they use.&lt;/p&gt;

&lt;p&gt;&lt;img src="network.jpg" alt="SDN Topology"&gt;&lt;/p&gt;

&lt;p&gt;Consider the above network topology, where &lt;code&gt;s1&lt;/code&gt;, &lt;code&gt;s2&lt;/code&gt;, and &lt;code&gt;s3&lt;/code&gt; are connected to a controller and &lt;code&gt;s4&lt;/code&gt; is a non-OpenFlow switch. Further, each switch is connected to a host. Note that the port numbers are denoted by the numbers at the endpoints of the links. After controller connections to &lt;code&gt;s1&lt;/code&gt;, &lt;code&gt;s2&lt;/code&gt;, &lt;code&gt;s3&lt;/code&gt; get established, the controller commands all three switches to flood LLDP packets. Consequently, LLDP packet sent by &lt;code&gt;p1&lt;/code&gt; of &lt;code&gt;s1&lt;/code&gt; (i.e., 1st port of the 1st switch) reaches to &lt;code&gt;p1&lt;/code&gt; of &lt;code&gt;s3&lt;/code&gt; and &lt;code&gt;s3&lt;/code&gt; forwards this packet to the controller. Since the LLDP packet sent by &lt;code&gt;s1&lt;/code&gt; is actuated by the controller itself, upon receiving the LLDP packet from &lt;code&gt;s3&lt;/code&gt;, controller discovers that there is a link from &lt;code&gt;p1&lt;/code&gt; of &lt;code&gt;s1&lt;/code&gt; to &lt;code&gt;p1&lt;/code&gt; of &lt;code&gt;s3&lt;/code&gt;. Likewise, the LLDP packet sent by &lt;code&gt;p2&lt;/code&gt; of &lt;code&gt;s2&lt;/code&gt; reaches to &lt;code&gt;p2&lt;/code&gt; of &lt;code&gt;s1&lt;/code&gt; and the controller learns that there is a link from &lt;code&gt;s1&lt;/code&gt; to &lt;code&gt;s2&lt;/code&gt; as well, and so on. Proceeding in this way the controller eventually figures out all the &lt;em&gt;direct&lt;/em&gt; links in the topology – we will come to the case for &lt;code&gt;s4&lt;/code&gt;. Note that upon receiving an LLDP packet, controller does not forward these packets any further, LLDP packets just acknowledge the controller about the direct links between the switches.&lt;/p&gt;

&lt;p&gt;Since &lt;code&gt;s4&lt;/code&gt; is a non-OpenFlow switch, it does not flood any LLDP packets and even if it would do so, since &lt;code&gt;s4&lt;/code&gt; is not known by the controller, the LLDP packets originate from &lt;code&gt;s4&lt;/code&gt; to the OpenFlow controler’s domain will not mean anything to the controller. On the other hand topology tells us that &lt;code&gt;p1&lt;/code&gt; of &lt;code&gt;s2&lt;/code&gt; is reachable by &lt;code&gt;p2&lt;/code&gt; of &lt;code&gt;s3&lt;/code&gt;, in other words, they are in the same &lt;em&gt;broadcast domain&lt;/em&gt;, but they do not have a direct link between each other. In this case, LLDP and BDDP packets flooded by &lt;code&gt;s2&lt;/code&gt; and &lt;code&gt;s3&lt;/code&gt; reaches to the non-OpenFlow switch &lt;code&gt;s4&lt;/code&gt;. Since LLDP packets are used for direct link discoveries LLDPs get dropped immediatly at the &lt;code&gt;s4&lt;/code&gt;. However, BDDP packets are broadcasted by non-OpenFlow switches and they make their way to &lt;code&gt;s2&lt;/code&gt; and &lt;code&gt;s3&lt;/code&gt;. By this way the controller discovers that there is an indirect connection between &lt;code&gt;p1&lt;/code&gt; of &lt;code&gt;s2&lt;/code&gt; and &lt;code&gt;p2&lt;/code&gt; of &lt;code&gt;s3&lt;/code&gt; and these switches are in the same broadcast domain.&lt;/p&gt;

&lt;h1 id="discovery-of-the-hosts"&gt;Discovery of the Hosts&lt;/h1&gt;

&lt;p&gt;Using a combination of LLDP and BDDP packets, controller discovers the direct and indirect connections between the switches. Further, controller also keeps an eye on the liveliness of the connections regularly with periodical checks. Equipped with the knowledge of the network topology, controller can determine the shortest path from a source switch port to a destination switch port. But how does it discover the hosts? That is, how does the controller discover the &lt;em&gt;attachment point(s)&lt;/em&gt; of a host?&lt;/p&gt;

&lt;p&gt;Considering the previously illustrated network topology, let’s assume that &lt;code&gt;h1&lt;/code&gt; pings &lt;code&gt;h2&lt;/code&gt;. When ping request reaches to &lt;code&gt;s1&lt;/code&gt;, since there were no previously installed rule(s) for the incoming flow, &lt;code&gt;s1&lt;/code&gt; will forward the first packet of the flow to the controller. This is the first time the controller observes a message originating from &lt;code&gt;h1&lt;/code&gt;. Hence, the controller discovers that &lt;code&gt;p3&lt;/code&gt; of &lt;code&gt;s1&lt;/code&gt; is an attachment point for &lt;code&gt;h1&lt;/code&gt;. But the controller still does not have any knowledge on the attachment points for the destination &lt;code&gt;h2&lt;/code&gt;. Thus, the controller tells &lt;code&gt;s1&lt;/code&gt; to flood the packet. Due to flooding, the ping request reaches to &lt;code&gt;s2&lt;/code&gt; and &lt;code&gt;s3&lt;/code&gt;. For simplicity, let’s assume that the flood first arrived to &lt;code&gt;s2&lt;/code&gt;. Since &lt;code&gt;s2&lt;/code&gt; does not have any corresponding rules for the flow, &lt;code&gt;s2&lt;/code&gt; forwards the packet to the controller. Controller still does not know the attachment point of &lt;code&gt;h2&lt;/code&gt; and hence commands to &lt;code&gt;s2&lt;/code&gt; to flood the packet again. After this second flood, the ping request reaches to &lt;code&gt;h2&lt;/code&gt; and &lt;code&gt;h2&lt;/code&gt; replies back. Upon &lt;code&gt;s2&lt;/code&gt; receiving &lt;code&gt;h2&lt;/code&gt;s reply from &lt;code&gt;p3&lt;/code&gt;, it forwards the reply to the controller. Now the controller discovers that &lt;code&gt;p3&lt;/code&gt; of &lt;code&gt;s2&lt;/code&gt; is an attachment point for &lt;code&gt;h2&lt;/code&gt;. Since controller has previously discovered &lt;code&gt;h1&lt;/code&gt;s attachment point, it knows that the reply needs to be routed from &lt;code&gt;p3&lt;/code&gt; to &lt;code&gt;p2&lt;/code&gt; of &lt;code&gt;s2&lt;/code&gt; and then from &lt;code&gt;p2&lt;/code&gt; to &lt;code&gt;p3&lt;/code&gt; of &lt;code&gt;s1&lt;/code&gt;. Consequently, controller installs the appropriate rules to the switches &lt;code&gt;s1&lt;/code&gt; and &lt;code&gt;s2&lt;/code&gt;, and finally commands &lt;code&gt;s2&lt;/code&gt; to send the ping reply from &lt;code&gt;p2&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Hosts &lt;code&gt;h1&lt;/code&gt;, &lt;code&gt;h2&lt;/code&gt; and &lt;code&gt;h3&lt;/code&gt; all have a single attachment point from the point of view of the controller. Say this time &lt;code&gt;h1&lt;/code&gt; pings &lt;code&gt;h4&lt;/code&gt;. Since the controller does not know the attachment point of &lt;code&gt;h4&lt;/code&gt;, it will repeatedly flood the request until it makes its way to &lt;code&gt;s4&lt;/code&gt; and then &lt;code&gt;h4&lt;/code&gt;. &lt;code&gt;h4&lt;/code&gt;s reply might reach to the controller network either from &lt;code&gt;p1&lt;/code&gt; of &lt;code&gt;s2&lt;/code&gt; or &lt;code&gt;p2&lt;/code&gt; of &lt;code&gt;s3&lt;/code&gt;. Further, each packet originating from &lt;code&gt;h4&lt;/code&gt; can be routed across different paths by &lt;code&gt;s4&lt;/code&gt; too. To handle such cases, controllers generally assign multiple attachment points for &lt;code&gt;h4&lt;/code&gt;.&lt;/p&gt;</content>
  </entry>
  <entry>
    <id>tag:vy.github.io,2013-07-31://blog/post/2013/07/31/openflow-controllers/</id>
    <title type="html">On the OpenFlow Controllers</title>
    <published>2013-07-31T17:11:00Z</published>
    <updated>2013-07-31T17:11:00Z</updated>
    <link rel="alternate" href="https://vy.github.io//blog/post/2013/07/31/openflow-controllers/"/>
    <content type="html">&lt;p&gt;&lt;strong&gt;TL;DR&lt;/strong&gt; – Use Floodlight (Pythonistas might want to give POX a try) and keep an eye on OpenDaylight.&lt;/p&gt;

&lt;p&gt;There has always been a confusion on which controller to start with for newcomers in the OpenFlow ecosystem. Should one prefer the classic &lt;a href="http://www.nox-repo.org/"&gt;NOX&lt;/a&gt;? Or go with a more modern choice like &lt;a href="http://www.beaconcontroller.net/"&gt;Beacon&lt;/a&gt; or its successor &lt;a href="http://www.projectfloodlight.org/"&gt;Floodlight&lt;/a&gt;? What about &lt;a href="http://www.osrg.net/ryu/"&gt;Ryu&lt;/a&gt;, &lt;a href="http://trema.github.com/trema/"&gt;Trema&lt;/a&gt;, and a dozen of &lt;a href="http://yuba.stanford.edu/~casado/of-sw.html"&gt;other controllers&lt;/a&gt; in the wild? Ohh! I was just forgetting about &lt;a href="http://www.opendaylight.org/"&gt;OpenDaylight&lt;/a&gt;, which is backed by industry giants such as Cisco, Juniper, Brocade, IBM, etc. After all you just want to push a set of simple OpenFlow commands to the forwarding plane and observe the result. On the other hand, you are also concerned with the maturity of the environment that you will work with. Nobody wants to find himself scratching his head for a bug in the controller core. And I am pretty sure you will also question whether there is an ongoing &lt;em&gt;active development&lt;/em&gt; and supportive &lt;em&gt;community&lt;/em&gt; in the project or not. Lucky for you, I have volunteered to share my two cents on the issue. After two years of fighting in this mud up to my neck, I have something to say!&lt;/p&gt;

&lt;p&gt;Let’s get this straight first: This survey investigates the existing free and open-source OpenFlow controllers in the wild from the point of view of a developer. I assume that what you look for is&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;clean code base (not a slick GUI or ground-breaking performance),&lt;/li&gt;
  &lt;li&gt;versatile core (not ad-hoc solutions like STP to common problems),&lt;/li&gt;
  &lt;li&gt;decent set of built-in components (e.g., device/switch query interface, access to topology, links and routing),&lt;/li&gt;
  &lt;li&gt;quick deployment cycle (i.e., it should take a few minutes to compile your changes and fire up the controller),&lt;/li&gt;
  &lt;li&gt;active development (i.e., presence of developers constantly contributing to the code base),&lt;/li&gt;
  &lt;li&gt;supportive community (e.g., once I had a reply to one of my &lt;a href="https://groups.google.com/d/msg/rrd4j-discuss/kXSJJibegSs/IKTbs8LEPC0J"&gt;questions&lt;/a&gt; in RRD4J mailing lists after 9 months), and&lt;/li&gt;
  &lt;li&gt;some documentation (not just a API reference).&lt;/li&gt;
&lt;/ul&gt;&lt;h1 id="nox"&gt;NOX&lt;/h1&gt;

&lt;p&gt;It all began with &lt;a href="http://www.nox-repo.org/"&gt;NOX&lt;/a&gt;. While some might argue, NOX is the very first OpenFlow controller that attracted a whole lot of researchers around itself and achieved to have a wide acceptance. A majority of the primary Software-Defined Networking (SDN) and OpenFlow papers and applications are implemented on top of NOX. Even Google used NOX to build (prototype?) its own distributed OpenFlow controller, called &lt;a href="http://yuba.stanford.edu/~casado/onix-osdi.pdf"&gt;ONIX&lt;/a&gt;. That being said, all that fuss was left in 2010. From then on the NOX mailing-lists are almost abandoned and no major changes that I know of is introduced to the code base.&lt;/p&gt;

&lt;p&gt;&lt;a href="http://dir.gmane.org/gmane.network.nox.devel"&gt;&lt;img src="nox-dev-ml-activity.png" alt="nox-dev Mail List Activity"&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;NOX is written in C++ and does not have a reputation for providing a developer-friendly environment. While rumors have that it ships a Python API, almost all the development is getting performed in C++. Another missing feature that I get shocked when I unfortunately figured out after days of debugging is that it does not support topologies with loops. (As a solution one can enable &lt;a href="https://en.wikipedia.org/wiki/Spanning_Tree_Protocol"&gt;STP&lt;/a&gt;, but this approach contradicts with the essence of SDN. In addition, you are always free to implement your own routing module or modify the built-in one to overcome this shortcoming.) In terms of &lt;a href="http://www.noxrepo.org/nox/documentation/"&gt;documentation&lt;/a&gt;, it is safe to say that there is almost no documentation. NOX is also shipped with a Python+QT based &lt;a href="https://github.com/noxrepo/nox-classic/wiki/NOX-GUI"&gt;GUI&lt;/a&gt;. (One should note that a decent user interface is maybe the first feature that newcomers look in a controller. While your mileage might vary, I had never been in need of a GUI and a majority of the time you make your way out with Wireshark traces and controller logs, trust me.)&lt;/p&gt;

&lt;p&gt;&lt;a href="https://github.com/noxrepo/nox-classic/wiki/NOX-GUI"&gt;&lt;img src="nox-gui.png" alt="NOX GUI"&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To sum up, NOX had its rise-and-fall. Personally, I would not recommend it to anybody for production and/or development purposes, especially considering the other decent alternatives in the market.&lt;/p&gt;

&lt;h1 id="pox"&gt;POX&lt;/h1&gt;

&lt;p&gt;Hereby I confess that I have never programmed in &lt;a href="http://www.noxrepo.org/pox/about-pox/"&gt;POX&lt;/a&gt; before. I will present the following statements depending on (1) my experiences with other controllers and POX activity I observed in the OpenFlow social media and (2) the corrections from POX hacker Murphy McCauley.&lt;/p&gt;

&lt;p&gt;POX &lt;a href="http://www.noxrepo.org/pox/about-pox/"&gt;calls&lt;/a&gt; itself as the younger sibling of NOX. (They are both managed/maintained by the same team/organization.) My personal belief is that POX is more or less motivated by the purpose of creating a developer-friendly OpenFlow controller successor to the NOX. Almost all OpenFlow newcomers are directed to either POX or Floodlight. Hence, it is no surprise that it has a pretty active &lt;a href="http://www.mail-archive.com/pox-dev@lists.noxrepo.org/"&gt;mailing list&lt;/a&gt;. POX provides a limited &lt;a href="https://openflow.stanford.edu/display/ONL/POX+Wiki#POXWiki-openflow.webservice"&gt;web API&lt;/a&gt; (via JSON-RPC) and a moderate sized collection of manuals on its &lt;a href="https://openflow.stanford.edu/display/ONL/POX+Wiki"&gt;wiki&lt;/a&gt;. It is written in Python and provides a decent Python API for the Pythonistas out there. Due to Python being an interpreted language, POX really cuts down the time spent in develop-and-deploy cycle, particularly compared to C++ based NOX. Further, in addition to supporting the NOX GUI, POX also provides a web-based GUI.&lt;/p&gt;

&lt;p&gt;&lt;a href="http://www.noxrepo.org/2012/09/pox-web-interfaces/"&gt;&lt;img src="pox-gui.png" alt="POX GUI"&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If Python is your main language of choice, then you are safe to experiment with POX. If you care about maturity and want to deploy your system in production, or the programming language does not matter much for you (that is, either you are a total programming newbie or have the same knowledge level on both Python and Java) I recommend you to evaluate the Java alternatives.&lt;/p&gt;

&lt;h1 id="beacon"&gt;Beacon&lt;/h1&gt;

&lt;p&gt;When I first started controller programming with NOX, there was no documentation, no consistency in the code base, nothing was compiling or working without manual intervention. Despite the fact that I have some significant experience with C/C++ and Linux, I could not understand what the controller was &lt;em&gt;actually&lt;/em&gt; doing behind. Even making the routing module work was a quite &lt;a href="http://comments.gmane.org/gmane.network.nox.devel/2856"&gt;painful experience&lt;/a&gt;. Then came &lt;a href="http://www.beaconcontroller.net/"&gt;Beacon&lt;/a&gt;. You clone the repository, import the project into Eclipse, and hit the run button. It was all that simple. You have just changed something in the code? Hit the run again and here you go. It even has a getting started tutorial and video on its website and it was working. (It is very rare to see working tutorials in the research world.) Further, it has a &lt;a href="https://openflow.stanford.edu/forums/forum/4-beacon-general/"&gt;forum&lt;/a&gt;, where &lt;a href="http://yuba.stanford.edu/~derickso/"&gt;David Erickson&lt;/a&gt;, the author of Beacon, himself replies you back promptly. What could a developer want more? But that was not all there. The code was written in a very a simple and expressive style. You just look at the names of the classes, modules, functions and you get the whole picture. You don’t need to be a programming prodigy just to push a simple flow. So you need to get the network topology? See &lt;code&gt;topology&lt;/code&gt; module, checked. You need the attachment point of a device, see &lt;code&gt;devicemanager&lt;/code&gt;, checked. You need to observe link states, see &lt;code&gt;linkdiscovery&lt;/code&gt;, checked. You need a hub, see &lt;code&gt;hub&lt;/code&gt;. You need a learning switch, see &lt;code&gt;learningswitch&lt;/code&gt;. You need the shortest path between two switches, see &lt;code&gt;routing&lt;/code&gt;. It was all falling into place. Finally, there was a controller where you can focus on programming, instead of wasting your time on compilation and library issues. I do not even mention about what a relief it felt was to program in an IDE, instead of using a text editor to modify a gigantic code base you have zero knowledge of. Ahh… And it was the first controller that ships with a built-in web user-interface. (The UI was so superior to the alternatives that I think it is still the best out there – I did not had a chance to test the web UI of OpenDaylight.)&lt;/p&gt;

&lt;p&gt;In my humble opinion, &lt;em&gt;David Erickson is the programmer who founded the fundamental software design patterns that are necessary for an SDN controller&lt;/em&gt;. His design choices affected all the other controller software out there in the wild written after Beacon and they all used more or less the same patterns. Some might argue that those patterns were obvious and the market would eventually converge to them at some point. But looking back at the controllers before Beacon, it was really a huge step forward and David Erickson is the name behind this leap.&lt;/p&gt;

&lt;p&gt;Being written in Java was a game changing feature for Beacon. On the other hand, Beacon is so tightly bound to Eclipse such that even it does support Maven, I had never managed to make it work with IntelliJ IDEA or compile manually with Maven. In addition, Eclipse toolbox helps you to export the controller as a single executable binary, but (due to a bug in Eclipse launcher) it requires GTK libraries to run, which is non-sense for a console application. (For instance, the launcher tries to pop up a GTK warning window for a missing &lt;code&gt;JAVA_CONSOLE&lt;/code&gt; environment variable, but since you are in console, you just see a lousy stack trace of the failed GTK call.) Further, OSGi had its own hard to debug, subtle sensitivities and steep learning curve. (That being said, OSGi helps you to restart the bundles individually, which once I used to provide fault-tolerance in a distributed controller I implemented.) Beacon also could not handle topologies with loops or devices with multiple attachment points, that is, a device reachable by multiple switch ports. And it is disappointing to say that it didn’t have a feature update since years.&lt;/p&gt;

&lt;p&gt;To sum up, Beacon provides a compact and expressive code base and works flawlessly. That being said, Eclipse and OSGi dependency really kills me and supporting only star topologies (that is, topologies without loops) is very constraining. If you are about to give Beacon a try, I would recommend you to evaluate Floodlight instead.&lt;/p&gt;

&lt;h1 id="floodlight"&gt;Floodlight&lt;/h1&gt;

&lt;p&gt;When I first heard of &lt;a href="http://bigswitch.com/"&gt;BigSwitch Networks&lt;/a&gt; announce their fork of Beacon, called &lt;a href="http://www.projectfloodlight.org/"&gt;Floodlight&lt;/a&gt;, I checked out the repository, casted an eye on it for 10 minutes, and concluded that it is almost the same code base. Months passed by, I had been bitten many times by gotchas found in Beacon (e.g., topologies with loops, devices appearing in multiple attachment points, etc.) and decided to give Floodlight another try. Good lord! In months Floodlight became the most prolific and feature rich F/OSS controller upto its time. Besides supporting topologies with loops, non-OpenFlow domains, and multiple device attachment points, it even introduced lots of other features that I had never imagined of for a software-defined network. Further, it is built with Apache Ant (Yay! Now I can use IntelliJ IDEA!) that lets you easily export JARs and replaces OSGi with a custom, Java-based, simple module loading system. While these two features would not mean much to Beacon foreigners, this was really something. (The custom module system does provide no &lt;code&gt;stop&lt;/code&gt;, &lt;code&gt;restart&lt;/code&gt; and &lt;code&gt;reload&lt;/code&gt; capabilities, but if they were so inevitable for you, you can easily tailor the existing system to fit your needs.) Floodlight has unquestionably the most active and responsive community among the F/OSS OpenFlow softwares. A majority of the Floodlight developers working in BigSwitch Networks directly participate in the mailing-lists. You can find yourself discussing an issue with the actual developer(s) of a particular module. I have never witnessed neither an unanswered question, nor an unresolved problem. It was truly a supportive and active community. Floodlight exposes almost all of its functionality through a REST API and there exists many handy utilities for common tasks such as static routes and end-to-end route (circuit) pushes. Floodlight has a web-based UI (contributed by &lt;a href="http://felter.org/wesley/"&gt;Wes Felter&lt;/a&gt;) and a Java-based GUI, called &lt;a href="http://openflow.marist.edu/avior.html"&gt;Avior&lt;/a&gt;, contributed by &lt;a href="http://jasonparraga.com/"&gt;Jason Parraga&lt;/a&gt;. One of its kind, Floodlight can also be run as network backend for OpenStack using a Quantum plug-in. Finally, it is the most &lt;a href="http://docs.projectfloodlight.org/display/floodlightcontroller/Floodlight+Documentation"&gt;documented&lt;/a&gt; controller project out there in the ecosystem.&lt;/p&gt;

&lt;p&gt;&lt;img src="fl-ui.jpg" alt="Floodlight Web-based UI"&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src="avior.png" alt="Avior"&gt;&lt;/p&gt;

&lt;p&gt;When I look back at the Beacon code base, it was written in a succint and expressive style, which makes it easy to grasp the logic at a single glance. This compactness also comes from the fact that Beacon does not provide as much feature as Floodlight does. On the other hand, Floodlight has so many enhancements and compatibility layers for different kind of hardware and corner cases that the code base is, to put it mildly, polluted and a couple of its components needs a rewrite from scratch. But these are generally concerns from a software architectural point of view and probably does not bother 90% of its users.
In addition, while I have never been in need of one, I must admit that Floodlight web-based UI has some serious bugs and neither web-based UI, nor Java-based UI is officially supported by the BigSwitch Networks.&lt;/p&gt;

&lt;p&gt;All in all, Floodlight is the most mature OpenFlow F/OSS controller in the market that I know of and my concerns about the code base will probably never be a problem for a majority of its users. It just runs out of the box, has a smooth work flow, supportive community, and works without a glitch for almost all real-world cases. Floodlight is the controller that I would recommend to anybody who wants to write custom control plane applications.&lt;/p&gt;

&lt;h1 id="opendaylight"&gt;OpenDaylight&lt;/h1&gt;

&lt;p&gt;&lt;a href="http://www.opendaylight.org/"&gt;OpenDaylight&lt;/a&gt; is an industry-supported Linux Foundation project. While I have never used it in practice, in my observations throughout the code, I found its code base clearer compared to Floodlight (that is, more idiomatic class hierarchy and naming conventions, consistent coding style, less &lt;code&gt;if (isWorking() == true) ...&lt;/code&gt; stuff) and more or less provides a similar feature set (that is, a majority of the modules are in common) – there are even some OpenDaylight features that are not present in Floodlight (for instance, support for multiple islands with loops).  At the beginning stages of the project, board members favored the controller code contributed by Cisco to the Floodlight-based contribution of BigSwitch Networks, which consequently followed by &lt;a href="http://www.bigswitch.com/blog/2013/06/05/big-switch-steps-down-from-opendaylight-platinum-status"&gt;BigSwitch Networks stepping down from the platinium status&lt;/a&gt;. When you look at the mailing list activity, you can also easily observe the domination of Cisco developers. Further, OpenDaylight follows a controller model that, in addition to OpenFlow, alternative south-bound protocols can be introduced. This facet significantly differs OpenDaylight from the other controllers and lets you use switches employing non-OpenFlow proprietary control protocols. Much can be said about OpenDaylight, but in my humble opinion it is still in the early development stages. That being said, developers should certainly keep an eye on it.&lt;/p&gt;

&lt;h1 id="feature-matrix"&gt;Feature Matrix&lt;/h1&gt;

&lt;p&gt;Before concluding the post, here I present a feature matrix for the controllers discussed.&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;&lt;tr&gt;
&lt;th&gt;Feature&lt;/th&gt;
			&lt;th&gt;NOX&lt;/th&gt;
			&lt;th&gt;POX&lt;/th&gt;
			&lt;th&gt;Beacon&lt;/th&gt;
			&lt;th&gt;Floodlight&lt;/th&gt;
			&lt;th&gt;OpenDaylight&lt;/th&gt;
		&lt;/tr&gt;&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Language(s) the controller is written in&lt;/td&gt;
			&lt;td&gt;C++&lt;/td&gt;
			&lt;td&gt;Python&lt;/td&gt;
			&lt;td&gt;Java&lt;/td&gt;
			&lt;td&gt;Java&lt;/td&gt;
			&lt;td&gt;Java&lt;/td&gt;
		&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Language(s) supported by the controller&lt;/td&gt;
			&lt;td&gt;C, C++, Python&lt;/td&gt;
			&lt;td&gt;Python&lt;/td&gt;
			&lt;td&gt;Java&lt;/td&gt;
			&lt;td&gt;Java, Python&lt;/td&gt;
			&lt;td&gt;Java&lt;/td&gt;
		&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Is actively developed?&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;maintained&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
		&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Has an active community?&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
		&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Easy to install?&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
		&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Easy to program?&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
		&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Is documented?&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;some&lt;/td&gt;
		&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Provides a REST API?&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;Y (limited)&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
		&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Have utility functions?&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
		&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Has a UI?&lt;/td&gt;
			&lt;td&gt;Python+QT4&lt;/td&gt;
			&lt;td&gt;Python+QT4, Web&lt;/td&gt;
			&lt;td&gt;Web&lt;/td&gt;
			&lt;td&gt;Java, Web&lt;/td&gt;
			&lt;td&gt;Web&lt;/td&gt;
		&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Supports hosts with multiple attachment points?&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
		&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Supports topologies with loops?&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;Y (via &lt;code&gt;spanning_tree&lt;/code&gt; component)&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
		&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Supports non-OF island connections?&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
		&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Supports OF island connections with loops?&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
		&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Provides an abstraction layer above south-bound protocols?&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
		&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Supports OpenStack Quantum?&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;N&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
			&lt;td&gt;Y&lt;/td&gt;
		&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;&lt;h1 id="conclusion"&gt;Conclusion&lt;/h1&gt;

&lt;p&gt;To sum it all together, I find Floodlight the most viable controller in the ecosystem as of now. That being said, after Murphy McCauley’s corrections, I also realized that POX has made a certain amount of progress on improving its documentation and components, hence can be a viable option for Pythonistas. While other alternatives can be tailored to fit your needs, this or that way as your project nears to finalize, you start to look for stability and being bitten by some odd limitations of the controllers starts to be quite annoying. Considering the huge amount of time that you will devote for learning a controller, try to aim your shot to the best candidate as much as possible. And we will together see how far will OpenDaylight go in the future.&lt;/p&gt;

&lt;h1 id="acknowledgement"&gt;Acknowledgement&lt;/h1&gt;

&lt;p&gt;I would like to thank &lt;a href="http://yuba.stanford.edu/~derickso/"&gt;David Erickson&lt;/a&gt;, &lt;a href="http://jasonparraga.com/"&gt;Jason Parraga&lt;/a&gt; and Murphy McCauley for their corrections.&lt;/p&gt;</content>
  </entry>
</feed>

