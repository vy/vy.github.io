<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Checking Null Arguments at Runtime Using Spring AOP</title>
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/bootstrap-responsive.css">
    <script src="/js/bootstrap.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <link rel="stylesheet" href="/css/common.css">
    <meta name="generator" content="nanoc 3.7.5">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/post.css">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-40183531-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <div id="menu">
      <div><a href="/">Home</a></div><div><a href="/about/">About</a></div><div><a href="/blog/">Blog</a></div><div><a href="/code/">Code</a></div><div><a href="/blog/feed/">Feed</a></div>
    </div>
    

<div class="container">
  <div class="row-fluid">
    <div class="offset1 span10">
      <div id="post" class="more-white-box rounded-corners">
	<div class="head">
	  <div class="title">Checking Null Arguments at Runtime Using Spring AOP</div>
	  <div class="subtitle">posted at
	    January 8, 2015
	    with tags <a href="/blog/tag/java">java</a>, <a href="/blog/tag/spring">spring</a>, <a href="/blog/tag/aop">aop</a>
	  </div>
	  <div class="share">
	    <div class="addthis_toolbox addthis_default_style ">
	      <a class="addthis_button_preferred_1"></a>
	      <a class="addthis_button_preferred_2"></a>
	      <a class="addthis_button_preferred_3"></a>
	      <a class="addthis_button_preferred_4"></a>
	      <a class="addthis_button_compact"></a>
	    </div>
	    <script type="text/javascript">var addthis_config = {"data_track_addressbar":false};</script>
	    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5144adf75211a62b"></script>
	  </div>
	</div>
	<div class="body">

	  
<p>For almost every function I wrote in Java, I add null checks to the method
header as follows:</p>

<pre><code class="language-java"><span class="kn">import</span> <span class="nn">javax.annotation.Nonnull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">base</span><span class="o">.</span><span class="na">Preconditions</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">;</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">foo</span><span class="o">(</span><span class="nd">@Nonnull</span> <span class="n">String</span> <span class="n">bar</span><span class="o">,</span> <span class="nd">@Nonnull</span> <span class="n">String</span> <span class="n">baz</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">checkNotNull</span><span class="o">(</span><span class="n">bar</span><span class="o">,</span> <span class="s">"bar == NULL"</span><span class="o">);</span>
    <span class="n">checkNotNull</span><span class="o">(</span><span class="n">baz</span><span class="o">,</span> <span class="s">"baz == NULL"</span><span class="o">);</span>
    <span class="c1">// ...</span>
<span class="o">}</span></code></pre>

<p>When the code is examined, <code>checkNotNull</code> calls look totally redundant given
that the parameters are already annotated with <code>@Nonnull</code>. However, <code>@Nonnull</code>
just provides an insight to the static code analysis tools and does not have
an effect at runtime, which makes <code>checkNotNull</code> calls necessary. I thought as
programmers we should be able to do better than this and found myself working
on a way to intercept methods with one or more <code>@Nonnull</code> annotated parameters
and check if they are null at runtime. Finally, I managed to find a solution
using <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/aop.html">Spring AOP</a>.
All you have to do is it include <code>spring-boot-starter-aop</code> artifact in your
dependencies, add the following Spring aspect to your project, and you are
done.</p>

<pre><code class="language-java"><span class="kn">import</span> <span class="nn">org.aspectj.lang.JoinPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Before</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.reflect.CodeSignature</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.reflect.MethodSignature</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Nonnull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Annotation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NullMonitor</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MethodArgument</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Annotation</span><span class="o">&gt;</span> <span class="n">annotations</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">value</span><span class="o">;</span>

        <span class="kd">private</span> <span class="nf">MethodArgument</span><span class="o">(</span>
                <span class="kt">int</span> <span class="n">index</span><span class="o">,</span>
                <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
                <span class="n">List</span><span class="o">&lt;</span><span class="n">Annotation</span><span class="o">&gt;</span> <span class="n">annotations</span><span class="o">,</span>
                <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">annotations</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">annotations</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getIndex</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">index</span><span class="o">;</span> <span class="o">}</span>

        <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">name</span><span class="o">;</span> <span class="o">}</span>

        <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Annotation</span><span class="o">&gt;</span> <span class="nf">getAnnotations</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">annotations</span><span class="o">;</span> <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasAnnotation</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Annotation</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Annotation</span> <span class="n">annotation</span> <span class="o">:</span> <span class="n">annotations</span><span class="o">)</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span><span class="o">.</span><span class="na">annotationType</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">type</span><span class="o">))</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">value</span><span class="o">;</span> <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">MethodArgument</span><span class="o">&gt;</span> <span class="nf">of</span><span class="o">(</span><span class="n">JoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">MethodArgument</span><span class="o">&gt;</span> <span class="n">arguments</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
            <span class="n">CodeSignature</span> <span class="n">codeSignature</span> <span class="o">=</span> <span class="o">(</span><span class="n">CodeSignature</span><span class="o">)</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">();</span> 
            <span class="n">String</span><span class="o">[]</span> <span class="n">names</span> <span class="o">=</span> <span class="n">codeSignature</span><span class="o">.</span><span class="na">getParameterNames</span><span class="o">();</span>
            <span class="n">MethodSignature</span> <span class="n">methodSignature</span> <span class="o">=</span>
                    <span class="o">(</span><span class="n">MethodSignature</span><span class="o">)</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getStaticPart</span><span class="o">().</span><span class="na">getSignature</span><span class="o">();</span>
            <span class="n">Annotation</span><span class="o">[][]</span> <span class="n">annotations</span> <span class="o">=</span> <span class="n">methodSignature</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getParameterAnnotations</span><span class="o">();</span>
            <span class="n">Object</span><span class="o">[]</span> <span class="n">values</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getArgs</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">values</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
                <span class="n">arguments</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">MethodArgument</span><span class="o">(</span>
                        <span class="n">i</span><span class="o">,</span> <span class="n">names</span><span class="o">[</span><span class="n">i</span><span class="o">],</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">annotations</span><span class="o">[</span><span class="n">i</span><span class="o">]),</span> <span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]));</span>
            <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">arguments</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="nd">@Before</span><span class="o">(</span><span class="s">"execution(* *(.., @javax.annotation.Nonnull (*), ..))"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">nullCheck</span><span class="o">(</span><span class="n">JoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">MethodSignature</span> <span class="n">methodSignature</span> <span class="o">=</span> <span class="o">(</span><span class="n">MethodSignature</span><span class="o">)</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">MethodArgument</span> <span class="n">argument</span> <span class="o">:</span> <span class="n">MethodArgument</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">joinPoint</span><span class="o">))</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">argument</span><span class="o">.</span><span class="na">hasAnnotation</span><span class="o">(</span><span class="n">Nonnull</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">argument</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                        <span class="s">"%s: argument \"%s\" (at position %d) cannot be null"</span><span class="o">,</span>
                        <span class="n">methodSignature</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(),</span> <span class="n">argument</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">argument</span><span class="o">.</span><span class="na">getIndex</span><span class="o">()));</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre>

<p>The source code is available in <a href="https://github.com/vy/null-check">null-check</a>
project at GitHub with some unit tests and a little bit more detailed
installation instructions.</p>


	  <script type="text/javascript">
	    $("#post table").attr("class", "table table-hover");
	  </script>

	  <div id="disqus_thread"></div>
	  <script type="text/javascript">
	  var disqus_shortname = 'vyazici';
	  var disqus_identifier = '/blog/post/20150130-java-null-check/';
	  var disqus_title = 'Checking Null Arguments at Runtime Using Spring AOP';
	  (function() {
	  	var dsq = document.createElement('script');
	  	dsq.type = 'text/javascript';
	  	dsq.async = true;
	  	dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	  	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	  })();
	  </script>

	</div>
      </div>
      <div id="bgauthor" class="narrow-font">
	background image by
	<a href="http://jenniferwetzel.com/">Jennifer Wetzel</a>
      </div>
    </div>
  </div>
</div>




  </body>
</html>

