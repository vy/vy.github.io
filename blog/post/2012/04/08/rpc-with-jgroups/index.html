<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>RPC (Remote Procedure Call) with JGroup</title>
    <link rel="stylesheet" href="/css/common.css">
    <meta name="generator" content="nanoc 3.8.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/post.css">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-40183531-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <div id="container">

      <ul id="menu">
        <li><a href="/">Home</a></li><li><a href="/blog/">Blog</a></li><li><a href="/code/">Code</a></li><li><a href="/blog/feed/">Feed</a></li>
      </ul>

    

<div id="post">

	<div class="head">
		<div class="title">RPC (Remote Procedure Call) with JGroup</div>
		<div class="subtitle">posted at
			April 8, 2012
			with tags <a href="/blog/tag/java">java</a>, <a href="/blog/tag/jgroups">jgroups</a>
		</div>
	</div>

	<div class="body">

	  
<p>JGroups constitutes a perfect medium for RPC between nodes in a cluster. Here, I share a very basic JGroups RPC example.</p>

<pre><code class="language-java"><span class="kn">import</span> <span class="nn">org.jgroups.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jgroups.JChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jgroups.blocks.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jgroups.util.RspList</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RpcPeer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">JChannel</span> <span class="n">rpcChannel</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">RpcDispatcher</span> <span class="n">rpcDispatcher</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">RequestOptions</span> <span class="n">requestOptions</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Short</span><span class="o">,</span> <span class="n">Method</span><span class="o">&gt;</span> <span class="n">methods</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">short</span> <span class="n">CALLABLE</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Short</span><span class="o">,</span> <span class="n">Method</span><span class="o">&gt;();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">methods</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">CALLABLE</span><span class="o">,</span> <span class="n">RpcPeer</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"callable"</span><span class="o">,</span> <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">RpcPeer</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">rpcChannel</span> <span class="o">=</span> <span class="n">ChannelFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">create</span><span class="o">();</span>
        <span class="n">rpcDispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">RpcDispatcher</span><span class="o">(</span><span class="n">rpcChannel</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="n">rpcDispatcher</span><span class="o">.</span><span class="na">setMethodLookup</span><span class="o">(</span><span class="k">new</span> <span class="nf">MethodLookup</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="n">Method</span> <span class="nf">findMethod</span><span class="o">(</span><span class="kt">short</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">methods</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">requestOptions</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">RequestOptions</span><span class="o">(</span><span class="n">ResponseMode</span><span class="o">.</span><span class="na">GET_ALL</span><span class="o">,</span> <span class="mi">3000</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">connect</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">rpcChannel</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">disconnect</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">rpcChannel</span><span class="o">.</span><span class="na">disconnect</span><span class="o">();</span>
        <span class="n">rpcChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unused"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">callable</span><span class="o">(</span><span class="n">Long</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s received %s."</span><span class="o">,</span> <span class="n">rpcChannel</span><span class="o">.</span><span class="na">getAddress</span><span class="o">(),</span> <span class="n">n</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">call</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span><span class="o">,</span> <span class="n">Long</span> <span class="n">n</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">MethodCall</span> <span class="n">methodCall</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MethodCall</span><span class="o">(</span><span class="n">CALLABLE</span><span class="o">,</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="mi">10</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">rpcDispatcher</span><span class="o">.</span><span class="na">callRemoteMethod</span><span class="o">(</span>
                <span class="n">address</span><span class="o">,</span> <span class="n">methodCall</span><span class="o">,</span> <span class="n">requestOptions</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">RspList</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">call</span><span class="o">(</span><span class="n">Long</span> <span class="n">n</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">MethodCall</span> <span class="n">methodCall</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MethodCall</span><span class="o">(</span><span class="n">CALLABLE</span><span class="o">,</span> <span class="n">n</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">rpcDispatcher</span><span class="o">.</span><span class="na">callRemoteMethods</span><span class="o">(</span>
                <span class="kc">null</span><span class="o">,</span> <span class="n">methodCall</span><span class="o">,</span> <span class="n">requestOptions</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>

<p>I think (at least, hope) the code is self-explanatory. A minor important point here is the RPC channel. Per see, I use <code>ChannelFactory.getInstance().create()</code> method to create the channel. <code>ChannelFactory</code> is a shortcut class to create multiple channels sharing the same transport. (See my <a href="/blog/post/2012/03/19/shared-transport-in-jgroups/">Shared Transport in JGroups</a> post for details.) That is, you need to have a separate JGroups channel reserved for RPC communication. All other messages sent/received using this channel will be consumed and ignored by the <code>RpcDispatcher</code>.</p>


	  <div id="disqus_thread"></div>
	  <script type="text/javascript">
	  var disqus_shortname = 'vyazici';
	  var disqus_identifier = '/blog/post/20120408-rpc-with-jgroups/';
	  var disqus_title = 'RPC (Remote Procedure Call) with JGroup';
	  (function() {
	  	var dsq = document.createElement('script');
	  	dsq.type = 'text/javascript';
	  	dsq.async = true;
	  	dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	  	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	  })();
	  </script>

	</div>

</div>





    </div>
  </body>
</html>

