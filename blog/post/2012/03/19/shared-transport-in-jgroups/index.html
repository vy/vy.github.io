<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Shared Transport in JGroups</title>
    <link rel="stylesheet" href="/css/common.css">
    <meta name="generator" content="nanoc 3.8.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/post.css">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-40183531-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <div id="container">

      <ul id="menu">
        <li><a href="/">Home</a></li><li><a href="/blog/">Blog</a></li><li><a href="/code/">Code</a></li><li><a href="/blog/feed/">Feed</a></li>
      </ul>

    

<div id="post">

    <div class="head">
        <div class="title">Shared Transport in JGroups</div>
        <div class="subtitle">posted at
            March 19, 2012
            with tags <a href="/blog/tag/java">java</a>, <a href="/blog/tag/jgroups">jgroups</a>
        </div>
    </div>

    <div class="body">

        <script type="text/javascript">
        var asyncLoadRequests = [];
        </script>

        
<p>A transport in a JGroups application is a heavy-weight object with significant overhead and a majority of the JGroups entities (remote procedure call, replicated hash map, etc.) generally require their dedicated channels, and hence transports for communication. However, by <a href="http://www.jgroups.org/manual/html/user-advanced.html#SharedTransport">sharing a transport between multiple channels</a>, it is possible to optimize available resources. (Remember that each transport occupies a thread pool and a socket.) For this purpose, one just needs to set the <code>singleton_name</code> attribute for the transport.</p>

<p><img src="shared-transport.png" alt="JGroups Shared Transport Architecture"></p>

<p>Unfortunately, it is not possible to alter the <code>singleton_name</code> attribute of a transport in your Java program using something like:</p>

<pre><code class="language-java"><span class="n">String</span> <span class="n">singletonName</span> <span class="o">=</span> <span class="s">"yabba"</span><span class="o">;</span>
<span class="n">JChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">JChannel</span><span class="o">();</span>
<span class="n">channel</span><span class="o">.</span><span class="na">getProtocolStack</span><span class="o">().</span><span class="na">getTransport</span><span class="o">()</span>
        <span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="s">"singleton_name"</span><span class="o">,</span> <span class="n">singletonName</span><span class="o">)</span></code></pre>

<p>At the moment, for this purpose, you have to alter the XML specification of the channel you are using. (See Bela Banâ€™s reply to <a href="http://article.gmane.org/gmane.comp.java.javagroups.general/7856">Setting Up a Shared Transport</a> post in JGroups mailing-list.)</p>

<p>For convenience, I put together a <code>ChannelFactory</code> to create channels sharing the same transport as follows.</p>

<pre><code class="language-java"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">ChannelFactory</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ChannelFactory</span> <span class="n">instance</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">singletonName</span> <span class="o">=</span> <span class="s">"shared"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">jchannel</span><span class="o">&gt;</span> <span class="n">channels</span><span class="o">;</span>
 
    <span class="kd">private</span> <span class="nf">ChannelFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">jchannel</span><span class="o">&gt;();</span>
    <span class="o">}</span>
 
    <span class="kd">synchronized</span> <span class="n">JChannel</span> <span class="nf">create</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">JChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">JChannel</span><span class="o">(</span>
                <span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="s">"META-INF/channel.xml"</span><span class="o">));</span>
        <span class="n">channels</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">channel</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">JChannel</span> <span class="n">channel</span> <span class="o">:</span> <span class="n">channels</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">disconnect</span><span class="o">();</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">channels</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="o">}</span>
 
    <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">ChannelFactory</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ChannelFactory</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>

<p>Later, I copied (say) <code>udp.xml</code> from JGroups sources to <code>META-INF/channel.xml</code>. And I added <code>singleton_name="shared"</code> line to the protocol specification in <code>META-INF/channel.xml</code> file.</p>

<p>Now, my individual classes make calls to <code>ChannelFactory.getInstance().create()</code> to get a channel dedicated to them. And while program shuts down, I just make a call to <code>ChannelFactory.getInstance().clear()</code> to tidy things up.</p>


        <div id="disqus_thread"></div>
        <script type="text/javascript">
        var disqus_shortname = 'vyazici';
        var disqus_identifier = '/blog/post/20120319-shared-transport-in-jgroups/';
        var disqus_title = 'Shared Transport in JGroups';
        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>

        

        

    </div>
  </body>
</html>


        <script type="text/javascript">
        for (var i = 0; i < asyncLoadRequests.length; i++) {
            asyncLoadRequest = asyncLoadRequests[i];
            asyncLoadRequest();
        }
        </script>

    </div>

</div>
