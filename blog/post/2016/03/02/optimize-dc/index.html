<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Optimizing a Data Center Using Integer Programming</title>
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/bootstrap-responsive.css">
    <script src="/js/bootstrap.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <link rel="stylesheet" href="/css/common.css">
    <meta name="generator" content="nanoc 3.8.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/post.css">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-40183531-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <div id="menu">
      <div><a href="/">Home</a></div><div><a href="/about/">About</a></div><div><a href="/blog/">Blog</a></div><div><a href="/code/">Code</a></div><div><a href="/blog/feed/">Feed</a></div>
    </div>
    

<div class="container">
  <div class="row-fluid">
    <div class="offset1 span10">
      <div id="post" class="more-white-box rounded-corners">
	<div class="head">
	  <div class="title">Optimizing a Data Center Using Integer Programming</div>
	  <div class="subtitle">posted at
	    March 2, 2016
	    with tags <a href="/blog/tag/algorithm">algorithm</a>
	  </div>
	  <div class="share">
	    <div class="addthis_toolbox addthis_default_style ">
	      <a class="addthis_button_preferred_1"></a>
	      <a class="addthis_button_preferred_2"></a>
	      <a class="addthis_button_preferred_3"></a>
	      <a class="addthis_button_preferred_4"></a>
	      <a class="addthis_button_compact"></a>
	    </div>
	    <script type="text/javascript">var addthis_config = {"data_track_addressbar":false};</script>
	    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5144adf75211a62b"></script>
	  </div>
	</div>
	<div class="body">

	  
<p><a href="https://hashcode.withgoogle.com/2015/tasks/hashcode2015_qualification_task.pdf">Optimize a Data
Center</a>
is a <strong>challenging</strong> programming problem presented in the Qualification Round
of the <a href="https://hashcode.withgoogle.com/past_editions.html">Hash Code 2015</a>.
Among 230 teams, <em>What’s in a name?</em> from <a href="http://www.ens.fr/">École normale
supérieure</a> ranked first in the qualification, but third
in the final round. By challenging, I mean it is not possible to come up with
a deterministic polynomial-time optimal answer. I am not in a position to
either provide a rigor proof of its complexity or its reduction to a known
NP-hard problem. But in this blog post I will investigate the following
question: Can we provide an optimal solution using <a href="https://en.wikipedia.org/wiki/Integer_programming">integer
programming</a>? In practice,
that would allow us to come up with an optimal solution to small-sized
problems. Without further ado, let’s start with the problem definition.</p>

<h1 id="the-problem">The Problem</h1>

<p>Here, I will present a brief summary of <a href="https://hashcode.withgoogle.com/2015/tasks/hashcode2015_qualification_task.pdf">the actual
problem</a>.
A data center is modeled as <strong>rows​</strong> of <strong>slots</strong> ​in which servers can be
placed. And some of the slots are known to be <strong>unavailable</strong>.</p>

<p><img src="rows.jpg" alt="Data center rows"></p>

<p>Each <strong>server</strong> is characterized by its <strong>size</strong> and <strong>capacity​</strong>. Size is
the number of consecutive slots occupied by the machine. Capacity is the total
amount of CPU resources of the machine (an integer value).</p>

<p><img src="servers.jpg" alt="Data center servers"></p>

<p>Servers in a data center are also logically divided into <strong>pools</strong>. ​Each
server belongs to exactly one pool. The capacity of a pool is the sum of the
capacities of the available ​servers in that pool.</p>

<p>The <strong>guaranteed capacity</strong> ​of a pool is the minimum capacity it will have
when at most one data center row goes down. Given a schema of a data center
and a list of available servers, the goal is to assign servers to slots within
the rows​ and to logical pools ​so that the lowest guaranteed capacity​ of all
pools is maximized.</p>

<p>Consider the following data center schema and a list of available servers. For
simplicity, it is assumed that server capacities are equal to server sizes.</p>

<p><img src="example-prob.jpg" alt="Example problem"></p>

<p>Following layout is a solution to the above given problem. Here different
pools are denoted in distinct colors.</p>

<p><img src="example-soln.jpg" alt="Example solution"></p>

<h1 id="preliminaries">Preliminaries</h1>

<p>Before modeling the IP (Integer Program), I will start with stating the
problem input.</p>

<ul>
  <li>
<script type="math/tex">R</script> ​denotes the number of rows in the data center</li>
  <li>
<script type="math/tex">S</script> denotes the number of slots in each row of the data center</li>
  <li>
<script type="math/tex">U \leq RS</script> denotes the number of unavailable slots</li>
  <li>
<script type="math/tex">P</script> denotes the number of pools to be created</li>
  <li>
<script type="math/tex">M \leq RS</script> denotes the number of servers to be allocated</li>
  <li>
<script type="math/tex">z_k</script> and <script type="math/tex">c_k</script> denote <script type="math/tex">k</script>th server’s respectively size and capacity</li>
  <li>
<script type="math/tex">r_i</script> and <script type="math/tex">s_i</script> denote <script type="math/tex">i</script>th unavailable slot’s respectively row and
slot indices</li>
</ul>

<p>While modeling the formulation, I will need to provide constraints to avoid
placing servers to unavailable slots. Rather than doing that, <a href="http://kaygun.tumblr.com/">Atabey
Kaygun</a> hinted me to represent the data in
<strong>blocks</strong>. That is, instead of <script type="math/tex">U</script>, <script type="math/tex">r_i</script>, and <script type="math/tex">s_i</script>, I will transform
this data into a single lookup table called <script type="math/tex">z(i, j)</script> that denotes the size
of the available slots at <script type="math/tex">i</script>th row and <script type="math/tex">j</script>th block. For instance,
consider the following layout:</p>

<p><img src="blocks.jpg" alt="Example blocks"></p>

<p>Here blocks will look as follows:</p>

<script type="math/tex; mode=display">z(0, 0) = 10 \\
z(1, 0) = 5,\, z(1, 1) = 3 \\
z(2, 0) = 3,\, z(2, 1) = 4,\, z(2, 2) = 1 \\
z(3, 0) = 6</script>

<h1 id="the-integer-programming-model">The Integer Programming Model</h1>

<p>For simplicity, I will adopt the following index notation:</p>

<ul>
  <li>
<script type="math/tex">i</script> denotes row indices (<script type="math/tex">0 \leq i \leq R</script>)</li>
  <li>
<script type="math/tex">j</script> denotes block (not slot!) indices (varies per row)</li>
  <li>
<script type="math/tex">k</script> denotes server indices (<script type="math/tex">0 \leq k \leq M</script>)</li>
  <li>
<script type="math/tex">\ell</script> denotes pool indices (<script type="math/tex">0 \leq \ell \leq P</script>)</li>
</ul>

<p>Given that <script type="math/tex">z(i, j)</script> denotes the available blocks, the IP model can be
defined as follows:</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}

\text{maximize}
& \quad
\min_\ell g(\ell)
\quad \text{(minimum of pool guaranteed capacities)} \\

\text{subject to}

& \quad
\sum_\ell p(k, l) \leq 1, \, \forall k
\quad \text{(a server can be assigned to at most 1 pool)} \\

& \quad
\sum_i \sum_j b(i, j, k) \leq 1, \, \forall k
\quad \text{(a server can be assigned to at most 1 block)} \\

& \quad
\sum_k z_k \, b(i, j, k) \leq z(i, j), \, \forall i, j
\quad \text{(total size of servers within a block cannot exceed block's size)} \\

& \quad
p(k, l) \leq \sum_i \sum_j b(i, j, k), \, \forall k, \ell
\quad \text{(a server can be assigned to a pool if the server is assigned to a block)} \\

\text{where}
& \quad
b(i, j, k) =
\begin{cases}
    1       & \quad \text{if block } (i, j) \text{ contains } k\text{th server} \\
    0  & \quad \text{otherwise} \\
  \end{cases} \\

& \quad
p(k, l) =
\begin{cases}
    1       & \quad \text{if } \ell \text{th pool contains } k\text{th server} \\
    0  & \quad \text{otherwise} \\
  \end{cases} \\

& \quad
g(\ell) = \min_i g(\ell, i)
\quad \text{(guaranteed capacity of } \ell \text{th pool)} \\

& \quad
g(\ell, i) = \sum_k c_k \, p(k, \ell) - \sum_k \sum_j c_k \, p(k, \ell) \, b(i, j, k)
\quad \text{(guaranteed capacity of } \ell \text{th pool for } i \text{th row)} \\

\end{align} %]]></script>

<h1 id="avoiding-minimax-constraint">Avoiding Minimax Constraint</h1>

<p>The presented IP model contains a minimax objective, which to the best of my
knowledge is not tractable by popular linear programming optimizers, such as
<a href="http://www-01.ibm.com/software/commerce/optimization/cplex-optimizer/">CPLEX</a>
or <a href="http://lpsolve.sourceforge.net/">lpsolve</a>. But I have a trick in my pocket
to tackle that. Let’s assume that we know the optimal objective, say <script type="math/tex">g^*</script>.
Then we can model the entire IP as follows:</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}

\text{maximize}
& \quad
1
\quad \text{(a dummy objective)} \\

\text{subject to}

& \quad
\sum_\ell p(k, l) \leq 1, \, \forall k \\

& \quad
\sum_i \sum_j b(i, j, k) \leq 1, \, \forall k \\

& \quad
\sum_k z_k \, b(i, j, k) \leq z(i, j), \, \forall i, j \\

& \quad
p(k, l) \leq \sum_i \sum_j b(i, j, k), \, \forall k, \ell \\

& \quad
g(\ell, i) \geq g^*, \, \forall \ell, i
\quad \text{(guaranteed capacity must be greater than or equal to } g^* \text{)} \\

\end{align} %]]></script>

<p>What this model states is this: I am not interested in the optimization
objective, return me the first found feasible solution. That is, the optimizer
will return us the first <script type="math/tex">b(i, j, k)</script> variable set the moment it finds a
feasible solution satisfying <script type="math/tex">g(\ell, i) \geq g^*, \, \forall \ell, i</script>
constraints.</p>

<p>Now things are getting interesting. If we can find bounds to <script type="math/tex">g^*</script>, than we
can use these bounds to bisect the optimal <script type="math/tex">g^*</script>! For the lower bound, we
know that <script type="math/tex">g_i = 0 \leq g^*</script>. The upper bound is a little bit tricky, but we
can come up with a quite loose bound: <script type="math/tex">g_f = \frac{1}{P} \sum_k c_k \gg
g^*</script>. (I will not go into details of how to come up with a stricter upper
bound.) So by picking <script type="math/tex">g^* \in (g_i, g_f)</script> we can bisect <strong>the optimal
guaranteed capacity</strong>.</p>

<h1 id="avoiding-non-linear-constraints">Avoiding Non-Linear Constraints</h1>

<p>Note that due to <script type="math/tex">p(k, \ell) \, b(i, j, k)</script> multiplication, the following
constraint in the model is non-linear:</p>

<script type="math/tex; mode=display">g^* \leq g(\ell, i) = \sum_k c_k \, p(k, \ell) - \sum_k \sum_j c_k \, p(k, \ell) \, b(i, j, k), \, \forall \ell, i</script>

<p>Non-linear constraints are as well not allowed by CPLEX and lpsolve. Luckily,
we can <a href="http://www.leandro-coelho.com/linearization-product-variables/">linearize this binary
multiplication</a>
by introducing a temporary binary variable <script type="math/tex">t(i, j, k, \ell) = p(k, \ell) \,
b(i, j, k)</script>:</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}
g(\ell, i) & = \sum_k c_k \, p(k, \ell) - \sum_k \sum_j c_k \, t(i, j, k, \ell), \, \forall \ell, i \\
t(i, j, k, \ell) & \leq p(k, l), \, \forall i, j, k, \ell \\
t(i, j, k, \ell) & \leq b(i, j, k), \, \forall i, j, k, \ell \\
t(i, j, k, \ell) & \geq p(k, l) + b(i, j, k) - 1, \, \forall i, j, k, \ell \\
\end{align} %]]></script>


	  <script type="text/javascript">
	    $("#post table").attr("class", "table table-hover");
	  </script>

	  <div id="disqus_thread"></div>
	  <script type="text/javascript">
	  var disqus_shortname = 'vyazici';
	  var disqus_identifier = '/blog/post/20160302-optimize-dc/';
	  var disqus_title = 'Optimizing a Data Center Using Integer Programming';
	  (function() {
	  	var dsq = document.createElement('script');
	  	dsq.type = 'text/javascript';
	  	dsq.async = true;
	  	dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	  	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	  })();
	  </script>

	</div>
      </div>
      <div id="bgauthor" class="narrow-font">
	background image by
	<a href="http://jenniferwetzel.com/">Jennifer Wetzel</a>
      </div>
    </div>
  </div>
</div>




<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>









  </body>
</html>

