<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Optimizing a Data Center Using Integer Programming</title>
    <link rel="stylesheet" href="/css/common.css">
    <meta name="generator" content="nanoc 3.8.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/post.css">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-40183531-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <div id="container">

      <ul id="menu">
        <li><a href="/">Home</a></li><li><a href="/blog/">Blog</a></li><li><a href="/code/">Code</a></li><li><a href="/blog/feed/">Feed</a></li>
      </ul>

    

<div id="post">

	<div class="head">
		<div class="title">Optimizing a Data Center Using Integer Programming</div>
		<div class="subtitle">posted at
			March 2, 2016
			with tags <a href="/blog/tag/algorithm">algorithm</a>
		</div>
	</div>

	<div class="body">

	  
<p><a href="https://hashcode.withgoogle.com/2015/tasks/hashcode2015_qualification_task.pdf">Optimize a Data
Center</a>
is a <strong>challenging</strong> programming problem presented in the Qualification Round
of the <a href="https://hashcode.withgoogle.com/past_editions.html">Hash Code 2015</a>.
Among 230 teams, <em>What’s in a name?</em> from <a href="http://www.ens.fr/">École normale
supérieure</a> ranked first in the qualification, but third
in the final round. By challenging, I mean it is not possible to come up with
a deterministic polynomial-time optimal answer. I am not in a position to
either provide a rigorous proof of its complexity or its reduction to a known
NP-hard problem. But in this blog post I will investigate the following
question: Can we provide an optimal solution using <a href="https://en.wikipedia.org/wiki/Integer_programming">integer
programming</a>? In practice,
that would allow us to come up with an optimal solution to small-sized
problems. Without further ado, let’s start with the problem definition.</p>

<h1 id="the-problem">The Problem</h1>

<p>Here, I will present a brief summary of <a href="https://hashcode.withgoogle.com/2015/tasks/hashcode2015_qualification_task.pdf">the actual
problem</a>.
A data center is modeled as <strong>rows​</strong> of <strong>slots</strong> ​in which servers can be
placed. And some of the slots are known to be <strong>unavailable</strong>.</p>

<p><img src="rows.jpg" alt="Data center rows"></p>

<p>Each <strong>server</strong> is characterized by its <strong>size</strong> and <strong>capacity​</strong>. Size is
the number of consecutive slots occupied by the machine. Capacity is the total
amount of CPU resources of the machine (an integer value).</p>

<p><img src="servers.jpg" alt="Data center servers"></p>

<p>Servers in a data center are also logically divided into <strong>pools</strong>. ​Each
server belongs to exactly one pool. The capacity of a pool is the sum of the
capacities of the available ​servers in that pool.</p>

<p>The <strong>guaranteed capacity</strong> ​of a pool is the minimum capacity it will have
when at most one data center row goes down. Given a schema of a data center
and a list of available servers, the goal is to assign servers to slots within
the rows​ and to logical pools ​so that the lowest guaranteed capacity​ of all
pools is maximized.</p>

<p>Consider the following data center schema and a list of available servers. For
simplicity, it is assumed that server capacities are equal to server sizes.</p>

<p><img src="example-prob.jpg" alt="Example problem"></p>

<p>Following layout is a solution to the above given problem. Here different
pools are denoted in distinct colors.</p>

<p><img src="example-soln.jpg" alt="Example solution"></p>

<h1 id="preliminaries">Preliminaries</h1>

<p>Before modeling the IP (Integer Program), I will start with stating the
problem input.</p>

<ul>
  <li>
<script type="math/tex">R</script> ​denotes the number of rows in the data center</li>
  <li>
<script type="math/tex">S</script> denotes the number of slots in each row of the data center</li>
  <li>
<script type="math/tex">U \leq RS</script> denotes the number of unavailable slots</li>
  <li>
<script type="math/tex">P</script> denotes the number of pools to be created</li>
  <li>
<script type="math/tex">M \leq RS</script> denotes the number of servers to be allocated</li>
  <li>
<script type="math/tex">z_k</script> and <script type="math/tex">c_k</script> denote <script type="math/tex">k</script>th server’s respectively size and capacity</li>
  <li>
<script type="math/tex">r_i</script> and <script type="math/tex">s_i</script> denote <script type="math/tex">i</script>th unavailable slot’s respectively row and
slot indices</li>
</ul>

<p>While modeling the formulation, I will need to provide constraints to avoid
placing servers to unavailable slots. Rather than doing that, <a href="http://kaygun.tumblr.com/">Atabey
Kaygun</a> hinted me to represent the data in
<strong>blocks</strong>. That is, instead of <script type="math/tex">U</script>, <script type="math/tex">r_i</script>, and <script type="math/tex">s_i</script>, I will transform
this data into a single lookup table called <script type="math/tex">z(i, j)</script> that denotes the size
of the available slots at <script type="math/tex">i</script>th row and <script type="math/tex">j</script>th block. For instance,
consider the following layout:</p>

<p><img src="blocks.jpg" alt="Example blocks"></p>

<p>Here blocks will look as follows:</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}
[z(0, 0)] &= [10] \\
[z(1, 0), z(1, 1)] &= [5,3] \\
[z(2, 0), z(2, 1), z(2, 2)] &= [3, 4, 1] \\
[z(3, 0)] &= [6]
\end{align} %]]></script>

<h1 id="the-integer-programming-model">The Integer Programming Model</h1>

<p>For simplicity, I will adopt the following index notation:</p>

<ul>
  <li>
<script type="math/tex">i</script> denotes row indices (<script type="math/tex">0 \leq i \leq R</script>)</li>
  <li>
<script type="math/tex">j</script> denotes block (not slot!) indices (varies per row)</li>
  <li>
<script type="math/tex">k</script> denotes server indices (<script type="math/tex">0 \leq k \leq M</script>)</li>
  <li>
<script type="math/tex">\ell</script> denotes pool indices (<script type="math/tex">0 \leq \ell \leq P</script>)</li>
</ul>

<p>Given that <script type="math/tex">z(i, j)</script> denotes the available blocks, the IP model can be
defined as follows:</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}

\text{maximize}
& \quad
\min_\ell g(\ell)
\quad \text{(minimum of pool guaranteed capacities)} \\

\text{subject to}

& \quad
\sum_\ell a(i, j, k, \ell) \leq 1, \, \forall k
\quad \text{(a server can be assigned to at most 1 pool and block)} \\

& \quad
\sum_{k,\ell} z_k \, a(i, j, k, \ell) \leq z(i, j), \, \forall i, j
\quad \text{(total size of servers within a block cannot exceed block's size)} \\

\text{where}
& \quad
a(i, j, k, \ell) =
\begin{cases}
    1       & \quad \text{if } k \text{th server is assigned to } (i, j) \text{th block and } \ell \text{th pool} \\
    0  & \quad \text{otherwise} \\
  \end{cases} \\

& \quad
g(\ell) = \min_i g(\ell, i)
\quad \text{(guaranteed capacity of } \ell \text{th pool)} \\

& \quad
g(\ell, i) = \sum_{i', j, k} c_k \, a(i', j, k, \ell) - \sum_{j, k} c_k \, a(i, j, k, \ell)
\quad \text{(guaranteed capacity of } \ell \text{th pool for } i \text{th row)} \\

\end{align} %]]></script>

<h1 id="avoiding-minimax-constraint">Avoiding Minimax Constraint</h1>

<p>The presented IP model contains a minimax objective, which to the best of my
knowledge is not tractable by popular linear programming optimizers, such as
<a href="http://www-01.ibm.com/software/commerce/optimization/cplex-optimizer/">CPLEX</a>
or <a href="http://lpsolve.sourceforge.net/">lpsolve</a>. But I have a trick in my pocket
to tackle that. Let’s assume that we know the optimal objective, say <script type="math/tex">g^*</script>.
Then we can model the entire IP as follows:</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}

\text{maximize}
& \quad
1
\quad \text{(a dummy objective)} \\

& \quad
\sum_\ell a(i, j, k, \ell) \leq 1, \, \forall k \\

& \quad
\sum_{k,\ell} z_k \, a(i, j, k, \ell) \leq z(i, j), \, \forall i, j \\

& \quad
g(\ell, i) \geq g^*, \, \forall \ell, i
\quad \text{(guaranteed capacity must be greater than or equal to } g^* \text{)} \\

\end{align} %]]></script>

<p>What this model states is this: I am not interested in the optimization
objective, return me the first found feasible solution. That is, the optimizer
will return us the first <script type="math/tex">a(i, j, k, \ell)</script> variable set the moment it finds
a feasible solution satisfying <script type="math/tex">g(\ell, i) \geq g^*, \, \forall \ell, i</script>
constraints.</p>

<p>Now things are getting interesting. If we can find bounds to <script type="math/tex">g^*</script>, than we
can use these bounds to bisect the optimal <script type="math/tex">g^*</script>! For the lower bound, we
know that <script type="math/tex">g_i = 0 \leq g^*</script>. The upper bound is a little bit tricky, but we
can come up with a quite loose bound: <script type="math/tex">g_f = \frac{1}{P} \sum_k c_k \gg
g^*</script>. (I will not go into details of how to come up with a stricter upper
bound.) So by picking <script type="math/tex">g^* \in (g_i, g_f)</script> we can bisect <strong>the optimal
guaranteed capacity</strong>.</p>

<h1 id="the-solver">The Solver</h1>

<p>For testing purposes, I wrote a simple <a href="https://gist.github.com/vy/9689cb122a84be22d454">Python
script</a> that reads an input
problem file and calls CPLEX iteratively. A sample output of the script is as
follows:</p>

<pre><code>$ ./dc.py ./cplex.sh prob/dc-min.in soln/dc-min 0
2016-03-03 08:35:25 DEBUG    reading setup: prob/dc-min.in
2016-03-03 08:35:25 DEBUG    R=2, S=5, U=1, P=2, M=5
2016-03-03 08:35:25 INFO     solving for 0 &lt;= g=8 &lt; 16
2016-03-03 08:35:25 DEBUG    writing problem: soln/dc-min-8.lp
2016-03-03 08:35:25 DEBUG    running solver
2016-03-03 08:35:25 DEBUG    writing cplex output: soln/dc-min-8.out
2016-03-03 08:35:25 DEBUG    no solution
2016-03-03 08:35:25 DEBUG    stepping back
2016-03-03 08:35:25 INFO     solving for 0 &lt;= g=4 &lt; 8
2016-03-03 08:35:25 DEBUG    writing problem: soln/dc-min-4.lp
2016-03-03 08:35:25 DEBUG    running solver
2016-03-03 08:35:25 DEBUG    writing cplex output: soln/dc-min-4.out
2016-03-03 08:35:25 DEBUG    solution score: 5
2016-03-03 08:35:25 DEBUG    writing solution: soln/dc-min-4.soln
2016-03-03 08:35:25 DEBUG    stepping forward
2016-03-03 08:35:25 INFO     solving for 5 &lt;= g=6 &lt; 8
2016-03-03 08:35:25 DEBUG    writing problem: soln/dc-min-6.lp
2016-03-03 08:35:25 DEBUG    running solver
2016-03-03 08:35:25 DEBUG    writing cplex output: soln/dc-min-6.out
2016-03-03 08:35:25 DEBUG    no solution
2016-03-03 08:35:25 DEBUG    stepping back
2016-03-03 08:35:25 INFO     solving for 5 &lt;= g=5 &lt; 6
2016-03-03 08:35:25 DEBUG    writing problem: soln/dc-min-5.lp
2016-03-03 08:35:25 DEBUG    running solver
2016-03-03 08:35:25 DEBUG    writing cplex output: soln/dc-min-5.out
2016-03-03 08:35:25 DEBUG    solution score: 5
2016-03-03 08:35:25 DEBUG    writing solution: soln/dc-min-5.soln
2016-03-03 08:35:25 DEBUG    stepping forward
</code></pre>

<p>It also outputs intermediate IP formulation files, CPLEX output, and solution
file. The format of the problem and solution files are detailed in <a href="https://hashcode.withgoogle.com/2015/tasks/hashcode2015_qualification_task.pdf">the
official problem
description</a>.</p>


	  <div id="disqus_thread"></div>
	  <script type="text/javascript">
	  var disqus_shortname = 'vyazici';
	  var disqus_identifier = '/blog/post/20160302-optimize-dc/';
	  var disqus_title = 'Optimizing a Data Center Using Integer Programming';
	  (function() {
	  	var dsq = document.createElement('script');
	  	dsq.type = 'text/javascript';
	  	dsq.async = true;
	  	dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	  	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	  })();
	  </script>

	</div>

</div>




<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>










    </div>
  </body>
</html>

