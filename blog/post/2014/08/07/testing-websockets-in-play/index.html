<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Testing WebSockets in Play Framework</title>
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/bootstrap-responsive.css">
    <script src="/js/bootstrap.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <link rel="stylesheet" href="/css/common.css">
    <meta name="generator" content="nanoc 3.8.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/post.css">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-40183531-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <div id="menu">
      <div><a href="/">Home</a></div><div><a href="/about/">About</a></div><div><a href="/blog/">Blog</a></div><div><a href="/code/">Code</a></div><div><a href="/blog/feed/">Feed</a></div>
    </div>
    

<div class="container">
  <div class="row-fluid">
    <div class="offset1 span10">
      <div id="post" class="more-white-box rounded-corners">
	<div class="head">
	  <div class="title">Testing WebSockets in Play Framework</div>
	  <div class="subtitle">posted at
	    August 7, 2014
	    with tags <a href="/blog/tag/java">java</a>, <a href="/blog/tag/play-framework">play framework</a>, <a href="/blog/tag/websocket">websocket</a>
	  </div>
	  <div class="share">
	    <div class="addthis_toolbox addthis_default_style ">
	      <a class="addthis_button_preferred_1"></a>
	      <a class="addthis_button_preferred_2"></a>
	      <a class="addthis_button_preferred_3"></a>
	      <a class="addthis_button_preferred_4"></a>
	      <a class="addthis_button_compact"></a>
	    </div>
	    <script type="text/javascript">var addthis_config = {"data_track_addressbar":false};</script>
	    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5144adf75211a62b"></script>
	  </div>
	</div>
	<div class="body">

	  
<p>In a recent job interview, I was asked to implement a fully fledged (that is,
including unit and integration tests) <a href="http://en.wikipedia.org/wiki/Mancala">Lubang Menggali
(Mancala)</a> game, where multiple users are
allowed to play in real-time. I went with <a href="http://www.playframework.com/">Play
Framework</a> and used
<a href="http://en.wikipedia.org/wiki/WebSocket">WebSocket</a>s to implement the real-time
server-client communication. (You can find the complete sources
<a href="https://github.com/vy/lubang-menggali">here</a>.) Play provides necessary leverage
for the integration tests â€“ start the server, connect two browsers to it, click
on the buttons to make a move and check the board updates. However, the tricky
bit was the implementation of unit tests for <code>WebSocket</code> handlers.</p>

<h1 id="preliminaries">Preliminaries</h1>

<p>A typical <code>WebSocket</code> handler in Play has the following entry point for the
request dispatcher.</p>

<pre><code class="language-java"><span class="kd">public</span> <span class="kd">static</span> <span class="n">WebSocket</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;</span> <span class="nf">join</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">WebSocket</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReady</span><span class="o">(</span><span class="n">In</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;</span> <span class="n">in</span><span class="o">,</span> <span class="n">Out</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// ...</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>

<p>When a request hits to <code>join()</code>, the function returns a new <code>WebSocket</code>
instance, where <code>onReady()</code> will be invoked upon connection establishment. After
that, the book keeping of the input and output sockets are delegated to the
programmer. Note that the client-server communication is performed in JSON
messages in the above code snippet.</p>

<h1 id="mocking">Mocking</h1>

<p>In order to mock a client-server <code>WebSocket</code> communication, I need mock
<code>WebSocket.In</code> and <code>WebSocket.Out</code> class implementations. For that purpose, I
first tried googling alternatives and checked what other people have done
previously, but did not find much material. Hence, I came up with the following
<code>MockInputWebSocket</code>.</p>

<pre><code class="language-java"><span class="nd">@ThreadSafe</span>
<span class="kd">class</span> <span class="nc">MockInputWebSocket</span> <span class="o">{</span>

    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">F</span><span class="o">.</span><span class="na">Callback</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;&gt;</span> <span class="n">messageListeners</span> <span class="o">=</span>
            <span class="n">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">F</span><span class="o">.</span><span class="na">Callback</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;&gt;());</span>

    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">F</span><span class="o">.</span><span class="na">Callback0</span><span class="o">&gt;</span> <span class="n">closeListeners</span> <span class="o">=</span>
            <span class="n">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">F</span><span class="o">.</span><span class="na">Callback0</span><span class="o">&gt;());</span>

    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">WebSocket</span><span class="o">.</span><span class="na">In</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;</span> <span class="n">inputSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebSocket</span><span class="o">.</span><span class="na">In</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;()</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">F</span><span class="o">.</span><span class="na">Callback</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span> <span class="n">messageListeners</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">callback</span><span class="o">);</span> <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClose</span><span class="o">(</span><span class="n">F</span><span class="o">.</span><span class="na">Callback0</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span> <span class="n">closeListeners</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">callback</span><span class="o">);</span> <span class="o">}</span>

    <span class="o">};</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">JsonNode</span> <span class="n">data</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">F</span><span class="o">.</span><span class="na">Callback</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;</span> <span class="n">listener</span> <span class="o">:</span> <span class="n">messageListeners</span><span class="o">)</span>
            <span class="n">listener</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">F</span><span class="o">.</span><span class="na">Callback0</span> <span class="n">listener</span> <span class="o">:</span> <span class="n">closeListeners</span><span class="o">)</span>
            <span class="n">listener</span><span class="o">.</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">WebSocket</span><span class="o">.</span><span class="na">In</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;</span> <span class="nf">getInputSocket</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">inputSocket</span><span class="o">;</span> <span class="o">}</span>

<span class="o">}</span></code></pre>

<p>Here, I first implement a <code>WebSocket.In</code> object, where message and close event
listeners can register themselves to <code>messageListeners</code> and <code>closeListeners</code>
list, respectively. Next, in order to pass data to the socket listeners, I wrote
my custom <code>write()</code> and <code>close()</code> methods.</p>

<p>I also implemented <code>MockOutputWebSocket</code> similarly:</p>

<pre><code class="language-java"><span class="nd">@ThreadSafe</span>
<span class="kd">class</span> <span class="nc">MockOutputWebSocket</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ObjectMapper</span><span class="o">();</span>

    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;</span> <span class="n">messageQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;&gt;();</span>

    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">WebSocket</span><span class="o">.</span><span class="na">Out</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;</span> <span class="n">outputSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebSocket</span><span class="o">.</span><span class="na">Out</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;()</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">JsonNode</span> <span class="n">frame</span><span class="o">)</span> <span class="o">{</span> <span class="n">messageQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">frame</span><span class="o">);</span> <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span> <span class="n">messageQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">.</span><span class="na">readTree</span><span class="o">(</span><span class="s">"{\"closed\": true}"</span><span class="o">));</span> <span class="o">}</span>
            <span class="c1">// This should not happen.</span>
            <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span> <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;</span> <span class="nf">getMessageQueue</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">messageQueue</span><span class="o">;</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="n">WebSocket</span><span class="o">.</span><span class="na">Out</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;</span> <span class="nf">getOutputSocket</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">outputSocket</span><span class="o">;</span> <span class="o">}</span>

<span class="o">}</span></code></pre>

<p>If we would forget about the custom close message hack (nasty!) in <code>close()</code>
method of the implemented <code>WebSocket.Out</code> class, things are self-explanative
here as well. That is, when we receive a new message, we push it to
<code>messageQueue</code>. The test user will be able to consume the messages written to
the mock output socket by polling <code>JsonData</code> from the <code>messageQueue</code>.</p>

<p>Since I come this far, I also implemented an entire <code>WebSocket</code> mock
(<code>MockWebSocket</code>) that employs the aforementioned <code>MockInputWebSocket</code> and
<code>MockOutputWebSocket</code> as follows.</p>

<pre><code class="language-java"><span class="nd">@ThreadSafe</span>
<span class="kd">class</span> <span class="nc">MockWebSocket</span> <span class="o">{</span>

    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">MockInputWebSocket</span> <span class="n">mockInput</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MockInputWebSocket</span><span class="o">();</span>
    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">MockOutputWebSocket</span> <span class="n">mockOutput</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MockOutputWebSocket</span><span class="o">();</span>
    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">WebSocket</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;</span> <span class="n">socket</span><span class="o">;</span>

    <span class="n">MockWebSocket</span><span class="o">(</span><span class="n">WebSocket</span><span class="o">&lt;</span><span class="n">JsonNode</span><span class="o">&gt;</span> <span class="n">socket</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">;</span>
        <span class="n">socket</span><span class="o">.</span><span class="na">onReady</span><span class="o">(</span><span class="n">mockInput</span><span class="o">.</span><span class="na">getInputSocket</span><span class="o">(),</span> <span class="n">mockOutput</span><span class="o">.</span><span class="na">getOutputSocket</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">JsonNode</span> <span class="nf">read</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">mockOutput</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">().</span><span class="na">poll</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">JsonNode</span> <span class="n">data</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span> <span class="n">mockInput</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">data</span><span class="o">);</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span> <span class="n">mockInput</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span>

<span class="o">}</span></code></pre>

<p><code>MockWebSocket</code> provides the caller an interface such that the two-way
<code>WebSocket</code> communication can be intercepted through provided <code>read()</code>,
<code>write()</code> and <code>close()</code> methods â€“ much like a regular network socket.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Remember that I used JSON as the messaging medium. For that purpose, I created a
couple of event classes (e.g., <code>WaitingForOpponent</code>, <code>ReadyToStart</code>,
<code>IllegalMove</code>, etc.) and used <a href="http://jackson.codehaus.org/">Jackson</a> for
POJO-JSON (de)serialization. Next, I integrated my brand new <code>MockWebSocket</code>
into the unit tests as follows.</p>

<pre><code class="language-java"><span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">readPojo</span><span class="o">(</span><span class="n">MockWebSocket</span> <span class="n">socket</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">JsonProcessingException</span> <span class="o">{</span>
    <span class="n">JsonNode</span> <span class="n">data</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">data</span><span class="o">).</span><span class="na">isNotNull</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span> <span class="k">return</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">convertValue</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">clazz</span><span class="o">);</span> <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalArgumentException</span> <span class="n">iae</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span>
                <span class="s">"Invalid JSON: "</span> <span class="o">+</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">data</span><span class="o">),</span> <span class="n">iae</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">writeMove</span><span class="o">(</span><span class="n">MockWebSocket</span> <span class="n">socket</span><span class="o">,</span> <span class="n">Object</span> <span class="n">pit</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
    <span class="n">socket</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">.</span><span class="na">valueToTree</span><span class="o">(</span><span class="n">pit</span><span class="o">));</span>
<span class="o">}</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testJoin</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
    <span class="c1">// Introduce the first user and read the "WaitingForOpponent" message.</span>
    <span class="n">MockWebSocket</span> <span class="n">fstSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MockWebSocket</span><span class="o">(</span><span class="n">Application</span><span class="o">.</span><span class="na">join</span><span class="o">());</span>
    <span class="n">WaitingForOpponent</span> <span class="n">fstWfo</span> <span class="o">=</span> <span class="n">readPojo</span><span class="o">(</span><span class="n">fstSocket</span><span class="o">,</span> <span class="n">WaitingForOpponent</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">Application</span><span class="o">.</span><span class="na">getPendingPlayers</span><span class="o">().</span><span class="na">size</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">Application</span><span class="o">.</span><span class="na">getGames</span><span class="o">().</span><span class="na">size</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

    <span class="c1">// Introduce the second user and read the."WaitingForOpponent" message.</span>
    <span class="n">MockWebSocket</span> <span class="n">sndSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MockWebSocket</span><span class="o">(</span><span class="n">Application</span><span class="o">.</span><span class="na">join</span><span class="o">());</span>
    <span class="n">WaitingForOpponent</span> <span class="n">sndWfo</span> <span class="o">=</span> <span class="n">readPojo</span><span class="o">(</span><span class="n">sndSocket</span><span class="o">,</span> <span class="n">WaitingForOpponent</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">fstWfo</span><span class="o">.</span><span class="na">playerId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">sndWfo</span><span class="o">.</span><span class="na">playerId</span><span class="o">)).</span><span class="na">isFalse</span><span class="o">();</span>

    <span class="c1">// Validate "ReadyToStart" messages.</span>
    <span class="n">ReadyToStart</span> <span class="n">fstRts</span> <span class="o">=</span> <span class="n">readPojo</span><span class="o">(</span><span class="n">fstSocket</span><span class="o">,</span> <span class="n">ReadyToStart</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">ReadyToStart</span> <span class="n">sndRts</span> <span class="o">=</span> <span class="n">readPojo</span><span class="o">(</span><span class="n">sndSocket</span><span class="o">,</span> <span class="n">ReadyToStart</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">Application</span><span class="o">.</span><span class="na">getGames</span><span class="o">().</span><span class="na">size</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">Application</span><span class="o">.</span><span class="na">getPendingPlayers</span><span class="o">().</span><span class="na">size</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">fstRts</span><span class="o">.</span><span class="na">nextPlayerId</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">sndRts</span><span class="o">.</span><span class="na">nextPlayerId</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">fstRts</span><span class="o">.</span><span class="na">opponentId</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">sndWfo</span><span class="o">.</span><span class="na">playerId</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">sndRts</span><span class="o">.</span><span class="na">opponentId</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">fstWfo</span><span class="o">.</span><span class="na">playerId</span><span class="o">);</span>

    <span class="c1">// Let 2nd player make a move, while this is not his turn.</span>
    <span class="n">writeMove</span><span class="o">(</span><span class="n">sndSocket</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="n">IllegalMove</span> <span class="n">im</span> <span class="o">=</span> <span class="n">readPojo</span><span class="o">(</span><span class="n">sndSocket</span><span class="o">,</span> <span class="n">IllegalMove</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">im</span><span class="o">.</span><span class="na">reason</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"It is opponent's turn."</span><span class="o">);</span>

    <span class="c1">// Let 1st player make a move to an invalid pit index.</span>
    <span class="n">writeMove</span><span class="o">(</span><span class="n">fstSocket</span><span class="o">,</span> <span class="s">"n/a"</span><span class="o">);</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">readPojo</span><span class="o">(</span><span class="n">fstSocket</span><span class="o">,</span> <span class="n">IllegalMove</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">im</span><span class="o">.</span><span class="na">reason</span><span class="o">).</span><span class="na">matches</span><span class="o">(</span><span class="s">"^Invalid pit index: .*"</span><span class="o">);</span>

    <span class="c1">// Let 1st player make a move with a negative pit index.</span>
    <span class="n">writeMove</span><span class="o">(</span><span class="n">fstSocket</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">readPojo</span><span class="o">(</span><span class="n">fstSocket</span><span class="o">,</span> <span class="n">IllegalMove</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">im</span><span class="o">.</span><span class="na">reason</span><span class="o">).</span><span class="na">matches</span><span class="o">(</span><span class="s">"^Invalid pit index: .*"</span><span class="o">);</span>

    <span class="c1">// ...</span>
<span class="o">}</span></code></pre>

<p>I suppose I have got a nearly 99% code coverage of the game engine by using the
mock <code>WebSocket</code>s. I hope this scheme would help others trying to do a similar
testing stuff.</p>


	  <script type="text/javascript">
	    $("#post table").attr("class", "table table-hover");
	  </script>

	  <div id="disqus_thread"></div>
	  <script type="text/javascript">
	  var disqus_shortname = 'vyazici';
	  var disqus_identifier = '/blog/post/20140807-testing-websockets-in-play/';
	  var disqus_title = 'Testing WebSockets in Play Framework';
	  (function() {
	  	var dsq = document.createElement('script');
	  	dsq.type = 'text/javascript';
	  	dsq.async = true;
	  	dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	  	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	  })();
	  </script>

	</div>
      </div>
      <div id="bgauthor" class="narrow-font">
	background image by
	<a href="http://jenniferwetzel.com/">Jennifer Wetzel</a>
      </div>
    </div>
  </div>
</div>




  </body>
</html>

