<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Parsing Bitcoin Blockchain Data in Java</title>
    <link rel="stylesheet" href="/css/common.css">
    <meta name="generator" content="nanoc 3.8.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/post.css">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-40183531-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <div id="container">

      <ul id="menu">
        <li><a href="/">Home</a></li><li><a href="/blog/">Blog</a></li><li><a href="/code/">Code</a></li><li><a href="/blog/feed/">Feed</a></li>
      </ul>

    


<div id="post">

	<div class="head">
		<div class="title">Parsing Bitcoin Blockchain Data in Java</div>
		<div class="subtitle">posted at
			June 27, 2014
			with tags <a href="/blog/tag/bitcoin">bitcoin</a>, <a href="/blog/tag/java">java</a>
		</div>
	  	<div class="share">
	      	<div class="addthis_toolbox addthis_default_style ">
	      		<a class="addthis_button_preferred_1"></a>
	      		<a class="addthis_button_preferred_2"></a>
	      		<a class="addthis_button_preferred_3"></a>
	      		<a class="addthis_button_preferred_4"></a>
	      		<a class="addthis_button_compact"></a>
	    	</div>
	    	<script type="text/javascript">var addthis_config = {"data_track_addressbar":false};</script>
	        <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5144adf75211a62b"></script>
	    </div>
	</div>

	<div class="body">

	  
<p>Last week I spent some time on collecting certain statistics (e.g., average
number of performed transactions and created blocks per month) over a vast
(~20GB) Bitcoin blockchain dataset. The hardest part for me was to pick the
right tool to parse the raw blockchain data. First, I hit the Google with
<em>“parse bitcoin blockchain”</em> keywords. Unfortunately, the returned results
(<a href="https://github.com/gavinandresen/bitcointools">bitcointools</a>,
<a href="https://code.google.com/p/blockchain/">blockchain</a>,
<a href="https://github.com/znort987/blockparser">blockparser</a>, etc.) point to almost
undocumented projects, where some appear to not even work. (As a side note,
bitcointools require a running BitcoinQt/bitcoind process in the background,
which I find pretty amusing.) Next, I checked some papers on Google Scholars to
find out how other people solved the problem. A paper leaded me to
<a href="https://github.com/etotheipi/BitcoinArmory">BitcoinArmory</a> project, which
requires a dozen of manual interventions to get installed. (I did not even
attempt to install it.) Suddenly, it occured me to add a <em>“java”</em> keyword to the
search phrase, which led me to <a href="https://bitcoinj.github.io/">bitcoinj</a> project.
<strong><em>bitcoinj is far most the best Bitcoin blockchain parser library that I have
ever met.</em></strong> It has a rich documentation, developer-friendly (and fully
documented) API and works out of the box. It is composed of a single JAR, no
other requirements, stupid hassles, etc. In addition, its IRC channel at
FreeNode is packed with real people that provide instant support on any Bitcoin
related questions.</p>

<p>Enough with the talk! Let’s get our hands dirty with the code. I first included
the bitcoinj Maven dependency in my <code>pom.xml</code> as follows:</p>

<pre><code class="language-xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.google<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>bitcoinj<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>0.11.3<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>

<p>Next, I downloaded a couple of raw blockchain data for test purposes:</p>

<ul>
  <li>
<a href="https://code.google.com/p/blockchain/source/browse/trunk/blk00000.dat">Sample data composed of 5000 blocks</a> (128 MB)</li>
  <li>
<a href="https://bitfetch.com/static/bootstrap.7z">From the genesis block through height 295,000</a> (4.7 GB)</li>
  <li>
<a href="https://bitcoin.org/bin/blockchain/bootstrap.dat.torrent">From the genesis block through a recent height</a> (~17 GB as of this post)</li>
</ul>

<p>Here comes the simplest part: the Java code. Below, I calculate the average
number of transactions per block per month.</p>

<pre><code class="language-java"><span class="kn">import</span> <span class="nn">com.google.bitcoin.core.Block</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.bitcoin.core.NetworkParameters</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.bitcoin.core.PrunedException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.bitcoin.core.Transaction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.bitcoin.params.MainNetParams</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.bitcoin.store.BlockStoreException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="c1">// Arm the blockchain file loader.</span>
<span class="n">NetworkParameters</span> <span class="n">np</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MainNetParams</span><span class="o">();</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">blockChainFiles</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="n">blockChainFiles</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="s">"/tmp/bootstrap.dat"</span><span class="o">));</span>
<span class="n">BlockFileLoader</span> <span class="n">bfl</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">BlockFileLoader</span><span class="o">(</span><span class="n">np</span><span class="o">,</span> <span class="n">blockChainFiles</span><span class="o">);</span>

<span class="c1">// Data structures to keep the statistics.</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">monthlyTxCount</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">monthlyBlockCount</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>

<span class="c1">// Iterate over the blocks in the dataset.</span>
<span class="k">for</span> <span class="o">(</span><span class="n">Block</span> <span class="n">block</span> <span class="o">:</span> <span class="n">bfl</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// Extract the month keyword.</span>
    <span class="n">String</span> <span class="n">month</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyy-MM"</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="n">block</span><span class="o">.</span><span class="na">getTime</span><span class="o">());</span>

    <span class="c1">// Make sure there exists an entry for the extracted month.</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">monthlyBlockCount</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">month</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">monthlyBlockCount</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">month</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">monthlyTxCount</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">month</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Update the statistics.</span>
    <span class="n">monthlyBlockCount</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">month</span><span class="o">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">monthlyBlockCount</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">month</span><span class="o">));</span>
    <span class="n">monthlyTxCount</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">month</span><span class="o">,</span> <span class="n">block</span><span class="o">.</span><span class="na">getTransactions</span><span class="o">().</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="n">monthlyTxCount</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">month</span><span class="o">));</span>

<span class="o">}</span>

<span class="c1">// Compute the average number of transactions per block per month.</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Float</span><span class="o">&gt;</span> <span class="n">monthlyAvgTxCountPerBlock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">month</span> <span class="o">:</span> <span class="n">monthlyBlockCount</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span>
    <span class="n">monthlyAvgTxCountPerBlock</span><span class="o">.</span><span class="na">put</span><span class="o">(</span>
            <span class="n">month</span><span class="o">,</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">monthlyTxCount</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">month</span><span class="o">)</span> <span class="o">/</span> <span class="n">monthlyBlockCount</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">month</span><span class="o">));</span></code></pre>

<p>That’s it! In order to appreciate the hassle-free simplicity of the bitcoinj
interface, you ought to take your time and spend a couple of hours on other
tools first. (About the performance, for the sample blockchain dataset of size
4.7 GB, above code snippet completes in less than 2 minutes on my 2.4 GHz
GNU/Linux notebook without any JVM flags. Pretty zippy!)</p>


	  <script type="text/javascript">
	    $("#post table").attr("class", "table table-hover");
	  </script>

	  <div id="disqus_thread"></div>
	  <script type="text/javascript">
	  var disqus_shortname = 'vyazici';
	  var disqus_identifier = '/blog/post/20140627-parse-bitcoin-blockchain/';
	  var disqus_title = 'Parsing Bitcoin Blockchain Data in Java';
	  (function() {
	  	var dsq = document.createElement('script');
	  	dsq.type = 'text/javascript';
	  	dsq.async = true;
	  	dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	  	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	  })();
	  </script>

	</div>

</div>





    </div>
  </body>
</html>

